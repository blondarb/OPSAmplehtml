<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sevaro Outpatient Clinical Note - MVP Prototype</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #F9FAFB;
      color: #111827;
      font-size: 14px;
      line-height: 1.5;
    }

    /* Color Variables - Light Mode */
    :root {
      --primary: #0D9488;
      --primary-light: #14B8A6;
      --primary-dark: #0F766E;
      --bg-white: #FFFFFF;
      --bg-gray: #F9FAFB;
      --bg-dark: #F3F4F6;
      --text-primary: #111827;
      --text-secondary: #6B7280;
      --text-muted: #9CA3AF;
      --border: #E5E7EB;
      --error: #EF4444;
      --success: #10B981;
      --warning: #F59E0B;
    }

    /* Color Variables - Dark Mode */
    [data-theme="dark"] {
      --primary: #14B8A6;
      --primary-light: #2DD4BF;
      --primary-dark: #0D9488;
      --bg-white: #1F2937;
      --bg-gray: #111827;
      --bg-dark: #0F172A;
      --text-primary: #F9FAFB;
      --text-secondary: #D1D5DB;
      --text-muted: #9CA3AF;
      --border: #374151;
      --error: #F87171;
      --success: #34D399;
      --warning: #FBBF24;
    }

    [data-theme="dark"] body {
      background: #111827;
      color: #F9FAFB;
    }

    [data-theme="dark"] .form-textarea,
    [data-theme="dark"] .form-input,
    [data-theme="dark"] .form-select,
    [data-theme="dark"] .diagnosis-input {
      background: var(--bg-dark);
      color: var(--text-primary);
    }

    [data-theme="dark"] .chip:not(.selected) {
      background: var(--bg-dark);
      color: var(--text-secondary);
    }

    [data-theme="dark"] .output-preview {
      background: #0F172A;
    }

    [data-theme="dark"] .ai-summary-box {
      background: linear-gradient(135deg, #064E3B 0%, #065F46 100%);
      border-color: #059669;
    }

    [data-theme="dark"] .patient-summary-box {
      background: linear-gradient(135deg, #064E3B 0%, #065F46 100%);
      border-color: #059669;
    }

    [data-theme="dark"] .ai-drawer-header {
      background: linear-gradient(135deg, #064E3B 0%, #065F46 100%);
    }

    [data-theme="dark"] .ai-launcher-menu-header {
      background: linear-gradient(135deg, #064E3B 0%, #065F46 100%);
    }

    [data-theme="dark"] .ai-live-indicator {
      background: linear-gradient(135deg, #78350F 0%, #92400E 100%);
      border-color: #B45309;
    }

    [data-theme="dark"] .ai-live-text h5 {
      color: #FDE68A;
    }

    [data-theme="dark"] .ai-live-text p {
      color: #FCD34D;
    }

    /* Layout */
    .app-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* Top Navigation */
    .top-nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 20px;
      background: var(--bg-white);
      border-bottom: 1px solid var(--border);
      gap: 16px;
    }

    .nav-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .logo svg {
      width: 32px;
      height: 32px;
    }

    .search-bar {
      display: flex;
      align-items: center;
      background: var(--bg-gray);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 12px;
      width: 280px;
    }

    .search-bar input {
      border: none;
      background: transparent;
      outline: none;
      width: 100%;
      font-size: 14px;
    }

    .search-bar svg {
      color: var(--text-muted);
      margin-right: 8px;
    }

    .queue-filters {
      display: flex;
      gap: 8px;
    }

    .queue-pill {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid var(--border);
      background: var(--bg-white);
      color: var(--text-secondary);
    }

    .queue-pill.active {
      background: var(--text-primary);
      color: white;
      border-color: var(--text-primary);
    }

    .nav-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .timer {
      display: flex;
      align-items: center;
      gap: 6px;
      background: var(--primary);
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-weight: 500;
      font-size: 13px;
    }

    .nav-icon {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      cursor: pointer;
      color: var(--text-secondary);
    }

    .nav-icon:hover {
      background: var(--bg-gray);
    }

    .notification-badge {
      position: absolute;
      top: 2px;
      right: 2px;
      width: 16px;
      height: 16px;
      background: var(--error);
      color: white;
      font-size: 10px;
      font-weight: 600;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid var(--bg-white);
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
    }

    /* Main Content Area */
    .main-content {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* Left Sidebar */
    .left-sidebar {
      width: 260px;
      background: var(--bg-white);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .patient-card {
      padding: 16px;
      border-bottom: 1px solid var(--border);
    }

    .patient-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .patient-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--bg-dark);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .patient-info h3 {
      font-size: 15px;
      font-weight: 600;
    }

    .patient-info p {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .patient-badges {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    .badge-teal {
      background: #CCFBF1;
      color: var(--primary-dark);
    }

    .badge-blue {
      background: #DBEAFE;
      color: #1D4ED8;
    }

    .badge-green {
      background: #D1FAE5;
      color: #059669;
    }

    .badge-red {
      background: #FEE2E2;
      color: #DC2626;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .btn-video, .btn-phone {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border: none;
    }

    .btn-video {
      background: var(--primary);
      color: white;
    }

    .btn-phone {
      background: var(--primary-light);
      color: white;
    }

    .sidebar-links {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
    }

    .sidebar-links a {
      color: var(--primary);
      text-decoration: none;
      font-size: 13px;
    }

    .sidebar-links a:hover {
      text-decoration: underline;
    }

    .sidebar-section {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
    }

    .sidebar-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      padding: 4px 0;
    }

    .sidebar-section-header h4 {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .sidebar-section-header .toggle-icon {
      color: var(--text-muted);
      transition: transform 0.2s;
    }

    .sidebar-section-header.collapsed .toggle-icon {
      transform: rotate(-90deg);
    }

    .sidebar-section-content {
      margin-top: 8px;
    }

    .timeline-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 0;
    }

    .timeline-dot {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--bg-gray);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
    }

    .timeline-info p {
      font-size: 13px;
    }

    .timeline-info span {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Prior Visits */
    .prior-visit-card {
      background: var(--bg-gray);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .prior-visit-card:hover {
      background: var(--bg-dark);
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .prior-visit-card.expanded {
      background: var(--bg-white);
      border: 1px solid var(--primary);
    }

    .visit-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 4px;
    }

    .visit-date {
      font-weight: 600;
      font-size: 13px;
    }

    .visit-type {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 10px;
    }

    .visit-chief {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .visit-provider {
      font-size: 11px;
      color: var(--text-muted);
    }

    .visit-expanded-content {
      display: none;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }

    .prior-visit-card.expanded .visit-expanded-content {
      display: block;
    }

    .ai-summary-box {
      background: linear-gradient(135deg, #F0FDFA 0%, #ECFDF5 100%);
      border: 1px solid #A7F3D0;
      border-radius: 8px;
      padding: 12px;
      margin-top: 8px;
    }

    .ai-summary-header {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
      font-size: 12px;
      color: var(--primary-dark);
      margin-bottom: 8px;
    }

    .ai-summary-content {
      font-size: 12px;
      color: var(--text-secondary);
    }

    /* Center Panel */
    .center-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .tab-nav {
      display: flex;
      gap: 4px;
      padding: 0 24px;
      background: var(--bg-white);
      border-bottom: 1px solid var(--border);
    }

    .tab-btn {
      padding: 16px 20px;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      background: none;
      border: none;
      cursor: pointer;
      position: relative;
      transition: color 0.2s;
    }

    .tab-btn:hover {
      color: var(--text-primary);
    }

    .tab-btn.active {
      color: var(--primary);
    }

    .tab-btn.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--primary);
    }

    .tab-content {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      background: var(--bg-gray);
    }

    .tab-pane {
      display: none;
    }

    .tab-pane.active {
      display: block;
    }

    /* Draggable Tabs */
    .tab-btn.dragging {
      opacity: 0.5;
      background: var(--primary-light);
      color: white;
    }

    .tab-btn.drag-over {
      border-left: 3px solid var(--primary);
    }

    .tab-nav-wrapper {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--bg-white);
      border-bottom: 1px solid var(--border);
      padding-right: 16px;
    }

    .tab-nav {
      border-bottom: none;
    }

    .view-toggle-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: var(--bg-gray);
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
    }

    .view-toggle-btn:hover {
      background: var(--bg-dark);
      color: var(--text-primary);
    }

    .view-toggle-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .view-toggle-btn svg {
      width: 14px;
      height: 14px;
    }

    /* Vertical Scroll View */
    .tab-content.vertical-view .tab-pane {
      display: block;
      margin-bottom: 24px;
      padding-bottom: 24px;
      border-bottom: 2px solid var(--border);
    }

    .tab-content.vertical-view .tab-pane:last-child {
      border-bottom: none;
    }

    .tab-content.vertical-view .section-divider {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }

    .tab-content.vertical-view .section-divider h3 {
      font-size: 18px;
      font-weight: 600;
      color: var(--primary);
      margin: 0;
    }

    .tab-content.vertical-view .section-divider .section-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }

    .section-divider {
      display: none;
    }

    .tab-content.vertical-view .section-divider {
      display: flex;
    }

    /* Hide tab nav in vertical view */
    .vertical-mode .tab-nav {
      display: none;
    }

    .vertical-mode .view-toggle-btn {
      margin-left: auto;
    }

    /* Form Sections */
    .form-section {
      background: var(--bg-white);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .required-badge {
      background: var(--error);
      color: white;
      font-size: 11px;
      font-weight: 500;
      padding: 3px 8px;
      border-radius: 4px;
    }

    .optional-badge {
      background: var(--bg-dark);
      color: var(--text-secondary);
      font-size: 11px;
      font-weight: 500;
      padding: 3px 8px;
      border-radius: 4px;
    }

    /* Chips */
    .chips-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .chip {
      padding: 8px 14px;
      border-radius: 20px;
      font-size: 13px;
      cursor: pointer;
      border: 1px solid var(--border);
      background: var(--bg-white);
      color: var(--text-secondary);
      transition: all 0.2s;
    }

    .chip:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .chip.selected {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    /* Text Areas */
    .form-textarea {
      width: 100%;
      min-height: 120px;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-family: inherit;
      font-size: 14px;
      resize: vertical;
      outline: none;
    }

    .form-textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1);
    }

    .form-textarea::placeholder {
      color: var(--primary);
    }

    /* Form Inputs */
    .form-row {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
    }

    .form-group {
      flex: 1;
    }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }

    .form-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      outline: none;
    }

    .form-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1);
    }

    .form-select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      background: var(--bg-white);
      cursor: pointer;
    }

    /* Radio/Checkbox Groups */
    .option-group {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }

    .option-item {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    .option-item input {
      accent-color: var(--primary);
    }

    /* Accordion */
    .accordion {
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 8px;
      overflow: hidden;
    }

    .accordion-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 16px;
      background: var(--bg-white);
      cursor: pointer;
      transition: background 0.2s;
    }

    .accordion-header:hover {
      background: var(--bg-gray);
    }

    .accordion-title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 500;
    }

    .accordion-title .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--border);
    }

    .accordion-title .status-dot.filled {
      background: var(--success);
    }

    .accordion-chevron {
      color: var(--text-muted);
      transition: transform 0.2s;
    }

    .accordion.open .accordion-chevron {
      transform: rotate(180deg);
    }

    .accordion-content {
      display: none;
      padding: 16px;
      border-top: 1px solid var(--border);
      background: var(--bg-gray);
    }

    .accordion.open .accordion-content {
      display: block;
    }

    /* Scales Section */
    .scale-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }

    .scale-item:last-child {
      border-bottom: none;
    }

    .scale-name {
      flex: 1;
      font-weight: 500;
    }

    .scale-input {
      width: 80px;
      padding: 8px;
      border: 1px solid var(--border);
      border-radius: 6px;
      text-align: center;
    }

    .scale-interpretation {
      width: 150px;
    }

    /* Study Cards (Imaging Tab) */
    .study-card {
      background: var(--bg-white);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 8px;
      overflow: hidden;
    }

    .study-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 16px;
      cursor: pointer;
    }

    .study-card-header:hover {
      background: var(--bg-gray);
    }

    .study-card-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .study-card-summary {
      font-size: 12px;
      color: var(--text-muted);
    }

    .study-card-content {
      display: none;
      padding: 16px;
      border-top: 1px solid var(--border);
      background: var(--bg-gray);
    }

    .study-card.open .study-card-content {
      display: block;
    }

    .study-card.open .study-chevron {
      transform: rotate(180deg);
    }

    /* Neuro Exam */
    .exam-quick-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      margin-bottom: 16px;
    }

    .exam-subsection {
      margin-bottom: 16px;
    }

    .exam-subsection h5 {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 10px;
      padding-bottom: 6px;
      border-bottom: 1px solid var(--border);
    }

    .exam-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
    }

    .exam-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .exam-item label {
      font-size: 13px;
    }

    /* Recommendation Tab */
    .diagnosis-search {
      position: relative;
      margin-bottom: 16px;
    }

    .diagnosis-input {
      width: 100%;
      padding: 12px 16px;
      padding-left: 40px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      outline: none;
    }

    .diagnosis-input:focus {
      border-color: var(--primary);
    }

    .diagnosis-search-icon {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
    }

    .diagnosis-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--bg-white);
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin-top: 4px;
      max-height: 250px;
      overflow-y: auto;
      z-index: 100;
      display: none;
    }

    .diagnosis-dropdown.show {
      display: block;
    }

    .diagnosis-option {
      padding: 12px 16px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .diagnosis-option:hover {
      background: var(--bg-gray);
    }

    .diagnosis-code {
      font-weight: 600;
      color: var(--primary);
    }

    .diagnosis-name {
      color: var(--text-primary);
    }

    .diagnosis-category {
      font-size: 12px;
      color: var(--text-muted);
    }

    .selected-diagnoses {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
    }

    .diagnosis-pill {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--bg-gray);
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 13px;
    }

    .diagnosis-pill .remove-btn {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--text-muted);
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }

    .diagnosis-pill .plan-btn {
      width: 24px;
      height: 24px;
      border-radius: 4px;
      background: var(--primary);
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .ai-generate-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      margin-bottom: 16px;
    }

    .ai-generate-btn:hover {
      background: var(--primary-dark);
    }

    .output-preview {
      background: #1F2937;
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
    }

    .output-preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .output-preview-header h4 {
      color: white;
      font-size: 13px;
    }

    .copy-btn {
      padding: 6px 12px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
    }

    .output-preview pre {
      color: #E5E7EB;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
      white-space: pre-wrap;
      line-height: 1.6;
    }

    /* Right Action Bar */
    .right-action-bar {
      width: 60px;
      background: var(--bg-white);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 16px 8px;
      gap: 8px;
    }

    .action-btn {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg-white);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-secondary);
      transition: all 0.2s;
    }

    .action-btn:hover {
      background: var(--bg-gray);
      border-color: var(--primary);
      color: var(--primary);
    }

    .action-btn-primary {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    .action-btn-primary:hover {
      background: var(--primary-dark);
    }

    .action-spacer {
      flex: 1;
    }

    .pend-btn {
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg-white);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      writing-mode: vertical-rl;
      text-orientation: mixed;
    }

    .sign-btn {
      padding: 10px 8px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      writing-mode: vertical-rl;
      text-orientation: mixed;
    }

    /* Plan Builder Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: flex-end;
      z-index: 1000;
    }

    .modal-overlay.show {
      display: flex;
    }

    .plan-builder-modal {
      width: 500px;
      height: 100%;
      background: var(--bg-white);
      box-shadow: -4px 0 20px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
      }
      to {
        transform: translateX(0);
      }
    }

    .plan-builder-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
    }

    .plan-builder-header h2 {
      font-size: 18px;
      margin-bottom: 12px;
    }

    .plan-builder-tabs {
      display: flex;
      gap: 4px;
    }

    .plan-tab {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid var(--border);
      background: var(--bg-white);
    }

    .plan-tab.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .plan-builder-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .plan-section {
      margin-bottom: 20px;
    }

    .plan-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      background: var(--bg-gray);
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 8px;
    }

    .plan-section-title {
      font-weight: 600;
      font-size: 14px;
    }

    .plan-checkbox-list {
      padding-left: 16px;
    }

    .plan-checkbox-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
    }

    .plan-checkbox-item input {
      accent-color: var(--primary);
    }

    .plan-checkbox-item label {
      font-size: 13px;
    }

    .plan-checkbox-item.sub-item {
      padding-left: 24px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .plan-builder-footer {
      padding: 16px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 12px;
    }

    .plan-builder-footer button {
      flex: 1;
      padding: 12px;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
    }

    .btn-cancel {
      background: var(--bg-white);
      border: 1px solid var(--border);
    }

    .btn-apply {
      background: var(--primary);
      color: white;
      border: none;
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 12px 20px;
      background: #1F2937;
      color: white;
      border-radius: 8px;
      display: none;
      align-items: center;
      gap: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 2000;
    }

    .toast.show {
      display: flex;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .toast-success {
      background: var(--success);
    }

    /* AI Toggle */
    .ai-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .toggle-switch {
      width: 40px;
      height: 22px;
      background: var(--border);
      border-radius: 11px;
      position: relative;
      cursor: pointer;
      transition: background 0.2s;
    }

    .toggle-switch.active {
      background: var(--primary);
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      width: 18px;
      height: 18px;
      background: white;
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: transform 0.2s;
    }

    .toggle-switch.active::after {
      transform: translateX(18px);
    }

    /* AI Text Input Features */
    .ai-textarea-wrapper {
      position: relative;
    }

    .ai-textarea-icons {
      position: absolute;
      top: 8px;
      right: 8px;
      display: flex;
      gap: 4px;
      z-index: 10;
    }

    .ai-icon-btn {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--bg-white);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-muted);
      transition: all 0.2s;
    }

    .ai-icon-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
      background: #F0FDFA;
    }

    .ai-icon-btn.recording {
      border-color: var(--error);
      color: var(--error);
      background: #FEE2E2;
      animation: pulse-recording 1.5s infinite;
    }

    @keyframes pulse-recording {
      0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
      50% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); }
    }

    /* Voice Waveform during recording */
    .recording-waveform {
      display: none;
      position: absolute;
      top: 8px;
      left: 8px;
      right: 80px;
      height: 28px;
      background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%);
      border: 1px solid #F87171;
      border-radius: 6px;
      align-items: center;
      justify-content: center;
      gap: 2px;
      padding: 0 12px;
      z-index: 5;
    }

    .recording-waveform.active {
      display: flex;
    }

    .recording-waveform .wave-bar {
      width: 3px;
      background: #EF4444;
      border-radius: 2px;
      animation: wave-animate 0.5s ease-in-out infinite;
    }

    .recording-waveform .wave-bar:nth-child(1) { height: 8px; animation-delay: 0s; }
    .recording-waveform .wave-bar:nth-child(2) { height: 14px; animation-delay: 0.1s; }
    .recording-waveform .wave-bar:nth-child(3) { height: 10px; animation-delay: 0.15s; }
    .recording-waveform .wave-bar:nth-child(4) { height: 18px; animation-delay: 0.2s; }
    .recording-waveform .wave-bar:nth-child(5) { height: 12px; animation-delay: 0.25s; }
    .recording-waveform .wave-bar:nth-child(6) { height: 16px; animation-delay: 0.3s; }
    .recording-waveform .wave-bar:nth-child(7) { height: 8px; animation-delay: 0.35s; }
    .recording-waveform .wave-bar:nth-child(8) { height: 14px; animation-delay: 0.4s; }
    .recording-waveform .wave-bar:nth-child(9) { height: 10px; animation-delay: 0.45s; }
    .recording-waveform .wave-bar:nth-child(10) { height: 6px; animation-delay: 0.5s; }

    @keyframes wave-animate {
      0%, 100% { transform: scaleY(0.5); }
      50% { transform: scaleY(1); }
    }

    .recording-waveform .recording-text {
      font-size: 11px;
      font-weight: 600;
      color: #DC2626;
      margin-left: 8px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .recording-waveform .recording-text .rec-dot {
      width: 6px;
      height: 6px;
      background: #EF4444;
      border-radius: 50%;
      animation: blink-live 0.8s infinite;
    }

    .ai-icon-btn.sparkle {
      background: linear-gradient(135deg, #F0FDFA 0%, #ECFDF5 100%);
      border-color: #A7F3D0;
      color: var(--primary);
    }

    .ai-icon-btn.sparkle:hover {
      background: linear-gradient(135deg, #CCFBF1 0%, #D1FAE5 100%);
    }

    /* AI Actions Dropdown */
    .ai-actions-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 4px;
      background: var(--bg-white);
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      min-width: 200px;
      z-index: 100;
      display: none;
    }

    .ai-actions-dropdown.show {
      display: block;
    }

    .ai-action-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      cursor: pointer;
      font-size: 13px;
      color: var(--text-primary);
      transition: background 0.2s;
    }

    .ai-action-item:first-child {
      border-radius: 8px 8px 0 0;
    }

    .ai-action-item:last-child {
      border-radius: 0 0 8px 8px;
    }

    .ai-action-item:hover {
      background: var(--bg-gray);
    }

    .ai-action-item svg {
      color: var(--primary);
    }

    .ai-action-item span {
      flex: 1;
    }

    /* Quick Phrases Button */
    .quick-phrases-btn {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--bg-white);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      transition: all 0.2s;
    }

    .quick-phrases-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
      background: #F0FDFA;
    }

    .quick-phrases-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 4px;
      background: var(--bg-white);
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      min-width: 280px;
      display: none;
      z-index: 100;
      max-height: 300px;
      overflow-y: auto;
    }

    .quick-phrases-dropdown.show {
      display: block;
    }

    .quick-phrases-header {
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .quick-phrase-item {
      padding: 10px 14px;
      cursor: pointer;
      font-size: 13px;
      color: var(--text-primary);
      border-bottom: 1px solid var(--border);
      transition: background 0.15s;
    }

    .quick-phrase-item:last-child {
      border-bottom: none;
    }

    .quick-phrase-item:hover {
      background: var(--bg-gray);
    }

    .quick-phrase-item .phrase-shortcut {
      font-size: 11px;
      color: var(--text-muted);
      font-family: monospace;
      background: var(--bg-dark);
      padding: 2px 6px;
      border-radius: 4px;
      margin-right: 8px;
    }

    /* AI Response Modal */
    .ai-response-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .ai-response-modal.show {
      display: flex;
    }

    .ai-response-content {
      background: var(--bg-white);
      border-radius: 16px;
      width: 500px;
      max-width: 90vw;
      max-height: 80vh;
      overflow: hidden;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
      animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .ai-response-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(135deg, #F0FDFA 0%, #ECFDF5 100%);
    }

    .ai-response-header h3 {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 15px;
      color: var(--primary-dark);
    }

    .ai-response-close {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      border: none;
      background: transparent;
      cursor: pointer;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .ai-response-close:hover {
      background: var(--bg-dark);
    }

    .ai-response-body {
      padding: 20px;
      max-height: 400px;
      overflow-y: auto;
    }

    .ai-response-text {
      font-size: 14px;
      line-height: 1.6;
      color: var(--text-primary);
    }

    .ai-response-footer {
      display: flex;
      gap: 12px;
      padding: 16px 20px;
      border-top: 1px solid var(--border);
      background: var(--bg-gray);
    }

    .ai-response-footer button {
      flex: 1;
      padding: 10px 16px;
      border-radius: 8px;
      font-weight: 500;
      font-size: 13px;
      cursor: pointer;
    }

    .ai-btn-secondary {
      background: var(--bg-white);
      border: 1px solid var(--border);
      color: var(--text-secondary);
    }

    .ai-btn-primary {
      background: var(--primary);
      border: none;
      color: white;
    }

    .ai-btn-primary:hover {
      background: var(--primary-dark);
    }

    .ai-thinking {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-muted);
      font-size: 13px;
    }

    .ai-thinking-dots {
      display: flex;
      gap: 4px;
    }

    .ai-thinking-dots span {
      width: 6px;
      height: 6px;
      background: var(--primary);
      border-radius: 50%;
      animation: thinking 1.4s infinite;
    }

    .ai-thinking-dots span:nth-child(2) { animation-delay: 0.2s; }
    .ai-thinking-dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes thinking {
      0%, 80%, 100% { transform: scale(0.6); opacity: 0.5; }
      40% { transform: scale(1); opacity: 1; }
    }

    /* Score History Section */
    .score-history-section {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
    }

    .score-history-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      padding: 4px 0;
    }

    .score-history-header h4 {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .score-history-toggle {
      color: var(--text-muted);
      transition: transform 0.2s;
    }

    .score-history-header.collapsed .score-history-toggle {
      transform: rotate(-90deg);
    }

    .score-history-content {
      margin-top: 12px;
    }

    .score-history-content.hidden {
      display: none;
    }

    .score-card {
      background: var(--bg-gray);
      border-radius: 8px;
      padding: 10px 12px;
      margin-bottom: 8px;
    }

    .score-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    .score-card-title {
      font-weight: 600;
      font-size: 12px;
      color: var(--text-primary);
    }

    .score-card-trend {
      font-size: 11px;
      display: flex;
      align-items: center;
      gap: 2px;
    }

    .score-card-trend.improving { color: var(--success); }
    .score-card-trend.worsening { color: var(--error); }
    .score-card-trend.stable { color: var(--text-muted); }

    .score-history-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .score-history-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 8px;
      border-radius: 4px;
      font-size: 11px;
      transition: background 0.2s;
    }

    .score-history-item.clickable {
      cursor: pointer;
    }

    .score-history-item.clickable:hover {
      background: var(--bg-dark);
    }

    .score-history-item .date {
      color: var(--text-muted);
    }

    .score-history-item .value {
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .score-history-item .interpretation {
      font-size: 10px;
      color: var(--text-secondary);
      padding: 2px 6px;
      background: var(--bg-dark);
      border-radius: 4px;
    }

    .score-detail-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .score-detail-modal.show {
      display: flex;
    }

    .score-detail-content {
      background: var(--bg-white);
      border-radius: 12px;
      width: 400px;
      max-width: 90vw;
      overflow: hidden;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
    }

    .score-detail-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .score-detail-header h3 {
      font-size: 15px;
      color: var(--text-primary);
    }

    .score-detail-body {
      padding: 20px;
    }

    .score-detail-summary {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: var(--bg-gray);
      border-radius: 8px;
      margin-bottom: 16px;
    }

    .score-detail-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--primary);
    }

    .score-detail-interpretation {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .score-detail-questions {
      font-size: 12px;
    }

    .score-detail-questions h4 {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .score-question-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
    }

    .score-question-item:last-child {
      border-bottom: none;
    }

    .score-question-text {
      color: var(--text-primary);
      flex: 1;
      padding-right: 12px;
    }

    .score-question-value {
      font-weight: 600;
      color: var(--primary);
    }

    /* Global AI Launcher */
    .ai-launcher-container {
      position: relative;
    }

    .ai-launcher-btn {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      cursor: pointer;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      border: none;
      color: white;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .ai-launcher-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(13, 148, 136, 0.4);
    }

    .ai-launcher-menu {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 8px;
      background: var(--bg-white);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      width: 280px;
      display: none;
      z-index: 1000;
      overflow: hidden;
    }

    .ai-launcher-menu.show {
      display: block;
    }

    .ai-launcher-menu-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(135deg, #F0FDFA 0%, #ECFDF5 100%);
    }

    .ai-launcher-menu-header h4 {
      font-size: 13px;
      font-weight: 600;
      color: var(--primary-dark);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .ai-launcher-menu-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.15s;
      border-bottom: 1px solid var(--border);
    }

    .ai-launcher-menu-item:last-child {
      border-bottom: none;
    }

    .ai-launcher-menu-item:hover {
      background: var(--bg-gray);
    }

    .ai-launcher-menu-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-gray);
      color: var(--primary);
    }

    .ai-launcher-menu-text h5 {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 2px;
    }

    .ai-launcher-menu-text p {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* AI Drawer */
    .ai-drawer-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.3);
      z-index: 1500;
      display: none;
    }

    .ai-drawer-overlay.show {
      display: block;
    }

    .ai-drawer {
      position: fixed;
      top: 0;
      right: -420px;
      width: 420px;
      height: 100vh;
      background: var(--bg-white);
      box-shadow: -4px 0 24px rgba(0,0,0,0.15);
      z-index: 1600;
      display: flex;
      flex-direction: column;
      transition: right 0.3s ease;
    }

    .ai-drawer.show {
      right: 0;
    }

    .ai-drawer-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(135deg, #F0FDFA 0%, #ECFDF5 100%);
    }

    .ai-drawer-header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .ai-drawer-header-left h3 {
      font-size: 16px;
      font-weight: 600;
      color: var(--primary-dark);
    }

    .ai-drawer-close {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: none;
      background: transparent;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
    }

    .ai-drawer-close:hover {
      background: var(--bg-gray);
    }

    .ai-drawer-tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      background: var(--bg-white);
      overflow-x: auto;
    }

    .ai-drawer-tab {
      padding: 12px 16px;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
      background: none;
      border: none;
      cursor: pointer;
      white-space: nowrap;
      position: relative;
    }

    .ai-drawer-tab:hover {
      color: var(--text-primary);
    }

    .ai-drawer-tab.active {
      color: var(--primary);
    }

    .ai-drawer-tab.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--primary);
    }

    .ai-drawer-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .ai-drawer-pane {
      display: none;
    }

    .ai-drawer-pane.active {
      display: block;
    }

    /* Chart Prep Styles */
    .chart-prep-section {
      margin-bottom: 20px;
    }

    .chart-prep-section h4 {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chart-prep-content {
      background: var(--bg-gray);
      border-radius: 8px;
      padding: 14px;
      font-size: 13px;
      line-height: 1.6;
      color: var(--text-secondary);
    }

    .chart-prep-content ul {
      margin: 0;
      padding-left: 16px;
    }

    .chart-prep-content li {
      margin-bottom: 6px;
    }

    .chart-prep-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 4px;
      font-weight: 500;
    }

    .chart-prep-badge.normal {
      background: #D1FAE5;
      color: #059669;
    }

    .chart-prep-badge.abnormal {
      background: #FEE2E2;
      color: #DC2626;
    }

    .chart-prep-badge.pending {
      background: #FEF3C7;
      color: #D97706;
    }

    /* AI Confidence Indicator */
    .ai-confidence {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 4px;
      font-weight: 500;
    }

    .ai-confidence.high {
      background: #D1FAE5;
      color: #059669;
    }

    .ai-confidence.medium {
      background: #FEF3C7;
      color: #D97706;
    }

    .ai-confidence.low {
      background: #FEE2E2;
      color: #DC2626;
    }

    .ai-confidence svg {
      width: 12px;
      height: 12px;
    }

    .confidence-bar {
      display: flex;
      gap: 2px;
      margin-left: 4px;
    }

    .confidence-bar .bar {
      width: 3px;
      height: 10px;
      border-radius: 1px;
      background: currentColor;
      opacity: 0.3;
    }

    .confidence-bar .bar.filled {
      opacity: 1;
    }

    /* Drug Interaction Alert */
    .drug-interaction-alert {
      background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
      border: 1px solid #F59E0B;
      border-left: 4px solid #F59E0B;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 16px;
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .drug-interaction-alert.severe {
      background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%);
      border-color: #EF4444;
      border-left-color: #EF4444;
    }

    .drug-interaction-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #F59E0B;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .drug-interaction-alert.severe .drug-interaction-icon {
      background: #EF4444;
    }

    .drug-interaction-content {
      flex: 1;
    }

    .drug-interaction-content h5 {
      font-size: 13px;
      font-weight: 600;
      color: #92400E;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .drug-interaction-alert.severe .drug-interaction-content h5 {
      color: #991B1B;
    }

    .drug-interaction-content p {
      font-size: 12px;
      color: #A16207;
      line-height: 1.5;
    }

    .drug-interaction-alert.severe .drug-interaction-content p {
      color: #B91C1C;
    }

    .drug-interaction-dismiss {
      background: none;
      border: none;
      color: #92400E;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
    }

    .drug-interaction-dismiss:hover {
      background: rgba(0,0,0,0.1);
    }

    /* Guided Tour Styles */
    .tour-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 9998;
    }

    .tour-overlay.active {
      display: block;
    }

    .tour-highlight {
      position: relative;
      z-index: 9999;
      box-shadow: 0 0 0 4px var(--primary), 0 0 0 5000px rgba(0, 0, 0, 0.5);
      border-radius: 8px;
    }

    .tour-tooltip {
      display: none;
      position: fixed;
      background: var(--bg-white);
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      padding: 20px;
      max-width: 340px;
      z-index: 10000;
      animation: tour-fade-in 0.3s ease;
    }

    .tour-tooltip.active {
      display: block;
    }

    @keyframes tour-fade-in {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .tour-tooltip-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .tour-tooltip-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }

    .tour-tooltip-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .tour-tooltip-step {
      font-size: 12px;
      color: var(--text-muted);
    }

    .tour-tooltip-content {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.6;
      margin-bottom: 16px;
    }

    .tour-tooltip-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .tour-dots {
      display: flex;
      gap: 6px;
    }

    .tour-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--border);
    }

    .tour-dot.active {
      background: var(--primary);
    }

    .tour-dot.completed {
      background: var(--success);
    }

    .tour-buttons {
      display: flex;
      gap: 8px;
    }

    .tour-btn {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }

    .tour-btn-skip {
      background: transparent;
      color: var(--text-muted);
    }

    .tour-btn-skip:hover {
      color: var(--text-secondary);
    }

    .tour-btn-next {
      background: var(--primary);
      color: white;
    }

    .tour-btn-next:hover {
      background: var(--primary-dark);
    }

    .tour-btn-prev {
      background: var(--bg-gray);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .tour-btn-prev:hover {
      background: var(--bg-dark);
    }

    /* Tour Start Button in Header */
    .tour-start-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tour-start-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(13, 148, 136, 0.3);
    }

    .tour-start-btn svg {
      width: 14px;
      height: 14px;
    }

    /* Document Interaction Styles */
    .doc-interaction-section {
      margin-bottom: 16px;
    }

    .doc-interaction-label {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .doc-interaction-textarea {
      width: 100%;
      min-height: 100px;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-family: inherit;
      font-size: 13px;
      resize: vertical;
      outline: none;
    }

    .doc-interaction-textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1);
    }

    .doc-interaction-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .doc-interaction-btn {
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border: none;
    }

    .doc-interaction-btn.primary {
      background: var(--primary);
      color: white;
    }

    .doc-interaction-btn.primary:hover {
      background: var(--primary-dark);
    }

    .doc-interaction-btn.secondary {
      background: var(--bg-gray);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .doc-interaction-btn.secondary:hover {
      background: var(--bg-dark);
    }

    /* Ask AI Styles */
    .ask-ai-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .ask-ai-tab {
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid var(--border);
      background: var(--bg-white);
      color: var(--text-secondary);
    }

    .ask-ai-tab.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .ask-ai-input-container {
      position: relative;
      margin-bottom: 16px;
    }

    .ask-ai-input {
      width: 100%;
      padding: 12px 16px;
      padding-right: 44px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 13px;
      outline: none;
    }

    .ask-ai-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1);
    }

    .ask-ai-send {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      width: 32px;
      height: 32px;
      border-radius: 6px;
      border: none;
      background: var(--primary);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .ask-ai-response {
      background: var(--bg-gray);
      border-radius: 8px;
      padding: 16px;
      font-size: 13px;
      line-height: 1.6;
      color: var(--text-secondary);
      max-height: 300px;
      overflow-y: auto;
    }

    /* Summarize for Patient Styles */
    .patient-summary-box {
      background: linear-gradient(135deg, #F0FDFA 0%, #ECFDF5 100%);
      border: 1px solid #A7F3D0;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .patient-summary-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }

    .patient-summary-header h4 {
      font-size: 14px;
      font-weight: 600;
      color: var(--primary-dark);
    }

    .patient-summary-content {
      font-size: 14px;
      line-height: 1.7;
      color: var(--text-primary);
    }

    .reading-level-selector {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .reading-level-selector label {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .reading-level-selector select {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 13px;
      outline: none;
    }

    /* Create Handout Styles */
    .handout-options {
      margin-bottom: 16px;
    }

    .handout-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
    }

    .handout-option:last-child {
      border-bottom: none;
    }

    .handout-option input {
      accent-color: var(--primary);
    }

    .handout-option label {
      font-size: 13px;
      color: var(--text-primary);
    }

    .handout-preview {
      background: var(--bg-gray);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      font-size: 13px;
      line-height: 1.6;
    }

    .handout-preview h5 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--text-primary);
    }

    .handout-export-btns {
      display: flex;
      gap: 8px;
    }

    .handout-export-btn {
      flex: 1;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid var(--border);
      background: var(--bg-white);
      color: var(--text-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .handout-export-btn:hover {
      background: var(--bg-gray);
    }

    .handout-export-btn.primary {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    /* AI Context Section */
    .ai-context-section {
      background: var(--bg-gray);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 16px;
      border: 1px dashed var(--border);
    }

    .ai-context-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
    }

    .ai-context-header h5 {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .ai-context-toggle {
      font-size: 11px;
      color: var(--primary);
      cursor: pointer;
    }

    .ai-context-preview {
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-secondary);
      max-height: 60px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .ai-context-full {
      display: none;
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-secondary);
      max-height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    .ai-context-section.expanded .ai-context-preview {
      display: none;
    }

    .ai-context-section.expanded .ai-context-full {
      display: block;
    }

    /* Loading spinner for AI */
    .ai-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
    }

    .ai-loading-spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* AI Live Listening Indicator */
    .ai-live-indicator {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
      border: 1px solid #F59E0B;
      border-radius: 10px;
      margin-bottom: 16px;
    }

    .ai-live-icon {
      position: relative;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .ai-live-icon .pulse-ring {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: rgba(239, 68, 68, 0.3);
      animation: pulse-live 1.5s ease-out infinite;
    }

    .ai-live-icon .pulse-ring:nth-child(2) {
      animation-delay: 0.5s;
    }

    .ai-live-icon .core {
      position: relative;
      width: 20px;
      height: 20px;
      background: #EF4444;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1;
    }

    .ai-live-icon .core svg {
      color: white;
    }

    @keyframes pulse-live {
      0% {
        transform: scale(0.5);
        opacity: 1;
      }
      100% {
        transform: scale(1.5);
        opacity: 0;
      }
    }

    .ai-live-text {
      flex: 1;
    }

    .ai-live-text h5 {
      font-size: 13px;
      font-weight: 600;
      color: #92400E;
      margin-bottom: 2px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .ai-live-text h5 .live-dot {
      width: 8px;
      height: 8px;
      background: #EF4444;
      border-radius: 50%;
      animation: blink-live 1s ease-in-out infinite;
    }

    @keyframes blink-live {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    .ai-live-text p {
      font-size: 11px;
      color: #A16207;
    }

    /* Sound wave bars animation */
    .sound-waves {
      display: flex;
      align-items: center;
      gap: 2px;
      height: 20px;
    }

    .sound-waves .bar {
      width: 3px;
      background: #EF4444;
      border-radius: 2px;
      animation: sound-wave 0.8s ease-in-out infinite;
    }

    .sound-waves .bar:nth-child(1) { height: 8px; animation-delay: 0s; }
    .sound-waves .bar:nth-child(2) { height: 14px; animation-delay: 0.1s; }
    .sound-waves .bar:nth-child(3) { height: 10px; animation-delay: 0.2s; }
    .sound-waves .bar:nth-child(4) { height: 16px; animation-delay: 0.3s; }
    .sound-waves .bar:nth-child(5) { height: 12px; animation-delay: 0.4s; }

    @keyframes sound-wave {
      0%, 100% { transform: scaleY(1); }
      50% { transform: scaleY(0.4); }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Top Navigation -->
    <nav class="top-nav">
      <div class="nav-left">
        <div class="logo">
          <svg viewBox="0 0 32 32" fill="none">
            <circle cx="16" cy="16" r="14" fill="#0D9488"/>
            <path d="M10 16C10 12.686 12.686 10 16 10C19.314 10 22 12.686 22 16C22 19.314 19.314 22 16 22" stroke="white" stroke-width="2" stroke-linecap="round"/>
            <circle cx="16" cy="16" r="3" fill="white"/>
          </svg>
        </div>
        <div class="search-bar">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
          </svg>
          <input type="text" placeholder="Search for patient name or MRN">
        </div>
        <div class="queue-filters">
          <span class="queue-pill">Acute Care <strong>0</strong></span>
          <span class="queue-pill">Rounding <strong>0</strong></span>
          <span class="queue-pill">EEG <strong>0</strong></span>
          <span class="queue-pill active">Outpatient <strong>1</strong></span>
        </div>
      </div>
      <div class="nav-right">
        <div class="timer">
          <span>MD2</span>
          <span id="timer">08:20:22</span>
        </div>
        <div class="nav-icon" title="PHI Mode">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0110 0v4"/>
          </svg>
        </div>
        <div class="nav-icon" title="Notifications" style="position: relative;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/>
          </svg>
          <span class="notification-badge">2</span>
        </div>
        <div class="nav-icon" id="dark-mode-toggle" title="Toggle Dark Mode" onclick="toggleDarkMode()" style="cursor: pointer;">
          <svg id="dark-mode-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>
          </svg>
        </div>
        <!-- Guided Tour Button -->
        <button class="tour-start-btn" onclick="startTour()" title="Take a Tour">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/>
          </svg>
          Tour
        </button>
        <!-- Global AI Launcher -->
        <div class="ai-launcher-container">
          <button class="ai-launcher-btn" onclick="toggleAiLauncherMenu()" title="AI Tools">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
            </svg>
          </button>
          <div class="ai-launcher-menu" id="ai-launcher-menu">
            <div class="ai-launcher-menu-header">
              <h4>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                </svg>
                AI Tools
              </h4>
            </div>
            <div class="ai-launcher-menu-item" onclick="openAiDrawer('chart-prep')">
              <div class="ai-launcher-menu-icon">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/><path d="M10 9H8"/>
                </svg>
              </div>
              <div class="ai-launcher-menu-text">
                <h5>Chart Prep</h5>
                <p>AI-generated visit summary</p>
              </div>
            </div>
            <div class="ai-launcher-menu-item" onclick="openAiDrawer('document')">
              <div class="ai-launcher-menu-icon">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
              </div>
              <div class="ai-launcher-menu-text">
                <h5>Document Interaction</h5>
                <p>Transcribe and document visit</p>
              </div>
            </div>
            <div class="ai-launcher-menu-item" onclick="openAiDrawer('ask-ai')">
              <div class="ai-launcher-menu-icon">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
                </svg>
              </div>
              <div class="ai-launcher-menu-text">
                <h5>Ask AI / Search VERA</h5>
                <p>Query clinical guidelines</p>
              </div>
            </div>
            <div class="ai-launcher-menu-item" onclick="openAiDrawer('summarize')">
              <div class="ai-launcher-menu-icon">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/>
                </svg>
              </div>
              <div class="ai-launcher-menu-text">
                <h5>Summarize for Patient</h5>
                <p>Plain-language explanation</p>
              </div>
            </div>
            <div class="ai-launcher-menu-item" onclick="openAiDrawer('handout')">
              <div class="ai-launcher-menu-icon">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 01-8 0"/>
                </svg>
              </div>
              <div class="ai-launcher-menu-text">
                <h5>Create Patient Handout</h5>
                <p>Generate take-home materials</p>
              </div>
            </div>
          </div>
        </div>
        <div class="user-avatar">SA</div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Left Sidebar -->
      <aside class="left-sidebar">
        <div class="patient-card">
          <div class="patient-header">
            <div class="patient-avatar">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#9CA3AF" stroke-width="2">
                <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/>
              </svg>
            </div>
            <div class="patient-info">
              <h3>Marshall</h3>
              <p style="display: flex; align-items: center; gap: 4px;">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>
                </svg>
                <span id="local-time-marshall">--:-- PST</span>
              </p>
            </div>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-left: auto; cursor: pointer;">
              <path d="M7 17l9.2-9.2M17 17V7H7"/>
            </svg>
          </div>
          <div style="margin-bottom: 12px;">
            <div class="patient-header" style="margin-bottom: 8px;">
              <div class="patient-avatar">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#9CA3AF" stroke-width="2">
                  <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/>
                </svg>
              </div>
              <div class="patient-info">
                <h3>Test Test</h3>
                <p>50, M #123123</p>
              </div>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-left: auto; cursor: pointer;">
                <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
              </svg>
            </div>
          </div>
          <div class="action-buttons">
            <button class="btn-video">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
              </svg>
              Video
            </button>
            <button class="btn-phone">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"/>
              </svg>
            </button>
          </div>
        </div>

        <div class="sidebar-links">
          <a href="#">PACS viewer</a> | <a href="#">VizAI</a> | <a href="#">Epic</a>
        </div>

        <div class="sidebar-section">
          <div class="sidebar-section-header">
            <h4>Prior Visits</h4>
            <div class="ai-toggle">
              <span style="font-size: 11px; color: var(--text-muted);">AI Summary</span>
              <div class="toggle-switch active" onclick="this.classList.toggle('active')"></div>
            </div>
          </div>
          <div class="sidebar-section-content">
            <div class="prior-visit-card expanded" onclick="toggleVisitCard(this)">
              <div class="visit-header">
                <span class="visit-date">Jan 10, 2026</span>
                <span class="visit-type badge badge-blue">Follow-up</span>
              </div>
              <div class="visit-chief">Headache, memory concerns</div>
              <div class="visit-provider">Dr. Smith</div>
              <div class="visit-expanded-content">
                <div class="ai-summary-box">
                  <div class="ai-summary-header">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                    </svg>
                    AI Summary
                  </div>
                  <div class="ai-summary-content">
                    Patient reports improved headache frequency with current prophylaxis. MoCA stable at 26/30. Continue current regimen.
                  </div>
                </div>
              </div>
            </div>
            <div class="prior-visit-card" onclick="toggleVisitCard(this)">
              <div class="visit-header">
                <span class="visit-date">Dec 15, 2025</span>
                <span class="visit-type badge badge-green">New Patient</span>
              </div>
              <div class="visit-chief">New onset headaches, 3 months</div>
              <div class="visit-provider">Dr. Johnson</div>
              <div class="visit-expanded-content">
                <div class="ai-summary-box">
                  <div class="ai-summary-header">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                    </svg>
                    AI Summary
                  </div>
                  <div class="ai-summary-content">
                    Initial evaluation for chronic daily headache. Started on topiramate 25mg. MRI brain ordered.
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Score History Section -->
        <div class="score-history-section">
          <div class="score-history-header" onclick="toggleScoreHistory(this)">
            <h4>
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/>
              </svg>
              Score History
            </h4>
            <svg class="score-history-toggle" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"/>
            </svg>
          </div>
          <div class="score-history-content">
            <!-- MIDAS - Clickable -->
            <div class="score-card">
              <div class="score-card-header">
                <span class="score-card-title">MIDAS</span>
                <span class="score-card-trend improving">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                    <polyline points="17 6 23 6 23 12"/>
                  </svg>
                  Improving
                </span>
              </div>
              <div class="score-history-list">
                <div class="score-history-item clickable" onclick="showScoreDetail('midas', 'Jan 16, 2026', 18, 'Moderate')">
                  <span class="date">Jan 16, 2026</span>
                  <span class="value">18 <span class="interpretation">Moderate</span></span>
                </div>
                <div class="score-history-item clickable" onclick="showScoreDetail('midas', 'Jan 10, 2026', 24, 'Moderate')">
                  <span class="date">Jan 10, 2026</span>
                  <span class="value">24 <span class="interpretation">Moderate</span></span>
                </div>
                <div class="score-history-item clickable" onclick="showScoreDetail('midas', 'Dec 15, 2025', 42, 'Severe')">
                  <span class="date">Dec 15, 2025</span>
                  <span class="value">42 <span class="interpretation">Severe</span></span>
                </div>
                <div class="score-history-item clickable" onclick="showScoreDetail('midas', 'Nov 1, 2025', 56, 'Severe')">
                  <span class="date">Nov 1, 2025</span>
                  <span class="value">56 <span class="interpretation">Severe</span></span>
                </div>
              </div>
            </div>

            <!-- HIT-6 - Non-clickable -->
            <div class="score-card">
              <div class="score-card-header">
                <span class="score-card-title">HIT-6</span>
                <span class="score-card-trend stable">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="5" y1="12" x2="19" y2="12"/>
                  </svg>
                  Stable
                </span>
              </div>
              <div class="score-history-list">
                <div class="score-history-item">
                  <span class="date">Jan 16, 2026</span>
                  <span class="value">58 <span class="interpretation">Substantial</span></span>
                </div>
                <div class="score-history-item">
                  <span class="date">Jan 10, 2026</span>
                  <span class="value">60 <span class="interpretation">Severe</span></span>
                </div>
                <div class="score-history-item">
                  <span class="date">Dec 15, 2025</span>
                  <span class="value">62 <span class="interpretation">Severe</span></span>
                </div>
              </div>
            </div>

            <!-- PHQ-9 - Non-clickable -->
            <div class="score-card">
              <div class="score-card-header">
                <span class="score-card-title">PHQ-9</span>
                <span class="score-card-trend improving">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                    <polyline points="17 6 23 6 23 12"/>
                  </svg>
                  Improving
                </span>
              </div>
              <div class="score-history-list">
                <div class="score-history-item">
                  <span class="date">Jan 16, 2026</span>
                  <span class="value">6 <span class="interpretation">Mild</span></span>
                </div>
                <div class="score-history-item">
                  <span class="date">Dec 15, 2025</span>
                  <span class="value">11 <span class="interpretation">Moderate</span></span>
                </div>
              </div>
            </div>
          </div>
        </div>

      </aside>

      <!-- Center Panel -->
      <main class="center-panel" id="center-panel">
        <div class="tab-nav-wrapper" id="tab-nav-wrapper">
          <div class="tab-nav" id="tab-nav">
            <button class="tab-btn active" draggable="true" data-tab="history" onclick="switchTab('history')">History</button>
            <button class="tab-btn" draggable="true" data-tab="imaging" onclick="switchTab('imaging')">Imaging/results</button>
            <button class="tab-btn" draggable="true" data-tab="exam" onclick="switchTab('exam')">Physical exams</button>
            <button class="tab-btn" draggable="true" data-tab="recommendation" onclick="switchTab('recommendation')">Recommendation</button>
          </div>
          <button class="view-toggle-btn" id="view-toggle-btn" onclick="toggleVerticalView()" title="Toggle vertical scroll view">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/>
            </svg>
            <span id="view-toggle-text">Scroll View</span>
          </button>
        </div>

        <div class="tab-content" id="tab-content">
          <!-- History Tab -->
          <div id="history-tab" class="tab-pane active" data-order="0">
            <div class="section-divider">
              <div class="section-icon">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                </svg>
              </div>
              <h3>History</h3>
            </div>
            <div class="form-section">
              <div class="section-header">
                <span class="section-title">Reason for visit</span>
                <span class="required-badge">Required</span>
              </div>
              <div class="chips-container">
                <span class="chip" onclick="toggleChip(this)">Altered mental status</span>
                <span class="chip" onclick="toggleChip(this)">Amnesia</span>
                <span class="chip" onclick="toggleChip(this)">Blurry vision</span>
                <span class="chip" onclick="toggleChip(this)">Chronic pain</span>
                <span class="chip" onclick="toggleChip(this)">Dizziness/Vertigo</span>
                <span class="chip" onclick="toggleChip(this)">Double vision</span>
                <span class="chip selected" onclick="toggleChip(this)">Headache</span>
                <span class="chip" onclick="toggleChip(this)">Memory problem</span>
                <span class="chip" onclick="toggleChip(this)">Movement problem</span>
                <span class="chip" onclick="toggleChip(this)">Neuropathy</span>
                <span class="chip" onclick="toggleChip(this)">Numbness</span>
                <span class="chip" onclick="toggleChip(this)">Parkinson Disease</span>
                <span class="chip" onclick="toggleChip(this)">Seizure</span>
                <span class="chip" onclick="toggleChip(this)">Stroke like symptoms</span>
                <span class="chip" onclick="toggleChip(this)">Syncope</span>
                <span class="chip" onclick="toggleChip(this)">TIA</span>
                <span class="chip" onclick="toggleChip(this)">Tremor</span>
                <span class="chip" onclick="toggleChip(this)">Vision loss</span>
                <span class="chip" onclick="toggleChip(this)">Weakness</span>
                <span class="chip" onclick="toggleChip(this)">Other</span>
              </div>
            </div>

            <div class="form-section">
              <div class="section-header">
                <span class="section-title">History of presenting illness</span>
                <span class="required-badge">Required</span>
              </div>
              <div class="ai-textarea-wrapper">
                <div class="recording-waveform">
                  <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
                  <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
                  <span class="recording-text"><span class="rec-dot"></span>Recording...</span>
                </div>
                <div class="ai-textarea-icons">
                  <div style="position: relative;">
                    <button class="quick-phrases-btn" onclick="toggleQuickPhrases(this)" title="Quick Phrases">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 7V4h16v3"/><path d="M9 20h6"/><path d="M12 4v16"/>
                      </svg>
                    </button>
                    <div class="quick-phrases-dropdown">
                      <div class="quick-phrases-header">Quick Phrases</div>
                      <div class="quick-phrase-item" onclick="insertQuickPhrase(this, 'Patient denies any recent changes in symptoms.')"><span class="phrase-shortcut">.deny</span>Patient denies any recent changes...</div>
                      <div class="quick-phrase-item" onclick="insertQuickPhrase(this, 'No new neurological deficits noted on examination.')"><span class="phrase-shortcut">.neuro</span>No new neurological deficits...</div>
                      <div class="quick-phrase-item" onclick="insertQuickPhrase(this, 'Patient reports compliance with current medication regimen.')"><span class="phrase-shortcut">.comp</span>Patient reports compliance...</div>
                      <div class="quick-phrase-item" onclick="insertQuickPhrase(this, 'Symptoms are stable compared to last visit.')"><span class="phrase-shortcut">.stable</span>Symptoms are stable...</div>
                      <div class="quick-phrase-item" onclick="insertQuickPhrase(this, 'Will continue current treatment plan and reassess at next visit.')"><span class="phrase-shortcut">.cont</span>Will continue current treatment...</div>
                    </div>
                  </div>
                  <button class="ai-icon-btn" onclick="toggleRecording(this)" title="Dictate with AI">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/>
                    </svg>
                  </button>
                  <div style="position: relative;">
                    <button class="ai-icon-btn sparkle" onclick="toggleAiDropdown(this)" title="AI Actions">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                      </svg>
                    </button>
                    <div class="ai-actions-dropdown">
                      <div class="ai-action-item" onclick="triggerAiAction('question', this)">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/>
                        </svg>
                        <span>Ask a question about this</span>
                      </div>
                      <div class="ai-action-item" onclick="triggerAiAction('improve', this)">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                        </svg>
                        <span>Improve this text</span>
                      </div>
                      <div class="ai-action-item" onclick="triggerAiAction('summarize', this)">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <line x1="21" y1="10" x2="3" y2="10"/><line x1="21" y1="6" x2="3" y2="6"/><line x1="21" y1="14" x2="3" y2="14"/><line x1="21" y1="18" x2="3" y2="18"/>
                        </svg>
                        <span>Summarize</span>
                      </div>
                    </div>
                  </div>
                </div>
                <textarea class="form-textarea" placeholder="Min. 25 words" style="padding-right: 80px;">50-year-old male presents for follow-up of chronic daily headaches. Patient reports headaches have improved from daily to approximately 3-4 per week since starting topiramate. Current dose is 50mg twice daily. Denies aura, nausea, or photophobia with recent episodes.</textarea>
              </div>
            </div>

            <div class="form-section">
              <div class="section-header">
                <span class="section-title">Clinical Scales</span>
                <span class="optional-badge">Optional</span>
              </div>

              <div class="accordion open" onclick="toggleAccordion(this)">
                <div class="accordion-header">
                  <span class="accordion-title">
                    <span class="status-dot filled"></span>
                    Headache Scales
                  </span>
                  <svg class="accordion-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"/>
                  </svg>
                </div>
                <div class="accordion-content" onclick="event.stopPropagation()">
                  <div class="scale-item">
                    <span class="scale-name">MIDAS Score</span>
                    <input type="number" class="scale-input" value="18" placeholder="0-270">
                    <select class="form-select scale-interpretation">
                      <option>Moderate disability</option>
                      <option>Little/No disability</option>
                      <option>Mild disability</option>
                      <option>Severe disability</option>
                    </select>
                  </div>
                  <div class="scale-item">
                    <span class="scale-name">HIT-6 Score</span>
                    <input type="number" class="scale-input" value="58" placeholder="36-78">
                    <select class="form-select scale-interpretation">
                      <option>Substantial impact</option>
                      <option>Little/No impact</option>
                      <option>Some impact</option>
                      <option>Severe impact</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="accordion" onclick="toggleAccordion(this)">
                <div class="accordion-header">
                  <span class="accordion-title">
                    <span class="status-dot"></span>
                    Cognitive Scales
                  </span>
                  <svg class="accordion-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"/>
                  </svg>
                </div>
                <div class="accordion-content" onclick="event.stopPropagation()">
                  <div class="scale-item">
                    <span class="scale-name">MoCA Score</span>
                    <input type="number" class="scale-input" placeholder="0-30">
                    <select class="form-select scale-interpretation">
                      <option value="">Select...</option>
                      <option>Normal (26+)</option>
                      <option>Mild impairment (18-25)</option>
                      <option>Moderate impairment (10-17)</option>
                      <option>Severe impairment (&lt;10)</option>
                    </select>
                  </div>
                  <div class="scale-item">
                    <span class="scale-name">Mini-Cog</span>
                    <input type="number" class="scale-input" placeholder="0-5">
                    <select class="form-select scale-interpretation">
                      <option value="">Select...</option>
                      <option>Normal (3-5)</option>
                      <option>Abnormal (0-2)</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="accordion" onclick="toggleAccordion(this)">
                <div class="accordion-header">
                  <span class="accordion-title">
                    <span class="status-dot"></span>
                    Mental Health Screens
                  </span>
                  <svg class="accordion-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"/>
                  </svg>
                </div>
                <div class="accordion-content" onclick="event.stopPropagation()">
                  <div class="scale-item">
                    <span class="scale-name">PHQ-9</span>
                    <input type="number" class="scale-input" placeholder="0-27">
                    <select class="form-select scale-interpretation">
                      <option value="">Select...</option>
                      <option>Minimal (0-4)</option>
                      <option>Mild (5-9)</option>
                      <option>Moderate (10-14)</option>
                      <option>Mod-Severe (15-19)</option>
                      <option>Severe (20-27)</option>
                    </select>
                  </div>
                  <div class="scale-item">
                    <span class="scale-name">GAD-7</span>
                    <input type="number" class="scale-input" placeholder="0-21">
                    <select class="form-select scale-interpretation">
                      <option value="">Select...</option>
                      <option>Minimal (0-4)</option>
                      <option>Mild (5-9)</option>
                      <option>Moderate (10-14)</option>
                      <option>Severe (15-21)</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <div class="form-section">
              <div class="section-header">
                <span class="section-title">Review of systems</span>
                <span class="required-badge">Required</span>
              </div>
              <div class="option-group">
                <label class="option-item">
                  <input type="radio" name="ros" checked> Reviewed
                </label>
                <label class="option-item">
                  <input type="radio" name="ros"> Unable to obtain due to:
                </label>
                <label class="option-item">
                  <input type="radio" name="ros"> Other
                </label>
              </div>
            </div>

            <div class="form-section">
              <div class="section-header">
                <span class="section-title">Allergies</span>
                <span class="required-badge">Required</span>
              </div>
              <div class="option-group">
                <label class="option-item">
                  <input type="radio" name="allergies" checked> NKDA
                </label>
                <label class="option-item">
                  <input type="radio" name="allergies"> Reviewed in EHR
                </label>
                <label class="option-item">
                  <input type="radio" name="allergies"> Unknown
                </label>
                <label class="option-item">
                  <input type="radio" name="allergies"> Other
                </label>
              </div>
            </div>

            <div class="form-section">
              <div class="section-header">
                <span class="section-title">Is medical, surgical, family and social history available?</span>
                <span class="optional-badge">Optional</span>
              </div>
              <div class="option-group">
                <label class="option-item">
                  <input type="radio" name="history" checked> Yes
                </label>
                <label class="option-item">
                  <input type="radio" name="history"> No, due to patient limitation
                </label>
                <label class="option-item">
                  <input type="radio" name="history"> N/A due to phone consult
                </label>
              </div>
            </div>
          </div>

          <!-- Imaging Tab -->
          <div id="imaging-tab" class="tab-pane" data-order="1">
            <div class="section-divider">
              <div class="section-icon">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/>
                </svg>
              </div>
              <h3>Imaging/Results</h3>
            </div>
            <div class="form-section">
              <div class="section-header">
                <span class="section-title">Imaging Studies</span>
                <span class="optional-badge">Optional</span>
              </div>

              <div class="study-card open" onclick="toggleStudyCard(this)">
                <div class="study-card-header">
                  <div class="study-card-title">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                    </svg>
                    <span>MRI Brain</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 12px;">
                    <span class="study-card-summary">01/05/2026 - Normal</span>
                    <svg class="study-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.2s;">
                      <polyline points="6 9 12 15 18 9"/>
                    </svg>
                  </div>
                </div>
                <div class="study-card-content" onclick="event.stopPropagation()">
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">Date</label>
                      <input type="date" class="form-input" value="2026-01-05">
                    </div>
                    <div class="form-group">
                      <label class="form-label">Interpretation</label>
                      <select class="form-select">
                        <option selected>Normal</option>
                        <option>Abnormal - acute</option>
                        <option>Abnormal - chronic</option>
                        <option>Pending</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="form-label">Findings</label>
                    <div class="ai-textarea-wrapper">
                      <div class="recording-waveform">
                        <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
                        <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
                        <span class="recording-text"><span class="rec-dot"></span>Recording...</span>
                      </div>
                      <div class="ai-textarea-icons">
                        <div style="position: relative;">
                          <button class="quick-phrases-btn" onclick="toggleQuickPhrases(this)" title="Quick Phrases">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <path d="M4 7V4h16v3"/><path d="M9 20h6"/><path d="M12 4v16"/>
                            </svg>
                          </button>
                          <div class="quick-phrases-dropdown">
                            <div class="quick-phrases-header">Quick Phrases</div>
                            <div class="quick-phrase-item" onclick="insertQuickPhrase(this, 'No acute intracranial abnormality.')"><span class="phrase-shortcut">.normal</span>No acute intracranial abnormality</div>
                            <div class="quick-phrase-item" onclick="insertQuickPhrase(this, 'No evidence of acute hemorrhage, mass effect, or midline shift.')"><span class="phrase-shortcut">.neg</span>No hemorrhage, mass effect...</div>
                            <div class="quick-phrase-item" onclick="insertQuickPhrase(this, 'Findings consistent with prior study.')"><span class="phrase-shortcut">.prior</span>Consistent with prior study</div>
                            <div class="quick-phrase-item" onclick="insertQuickPhrase(this, 'Recommend clinical correlation.')"><span class="phrase-shortcut">.corr</span>Recommend clinical correlation</div>
                          </div>
                        </div>
                        <button class="ai-icon-btn" onclick="toggleRecording(this)" title="Dictate with AI">
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/>
                          </svg>
                        </button>
                        <div style="position: relative;">
                          <button class="ai-icon-btn sparkle" onclick="toggleAiDropdown(this)" title="AI Actions">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                            </svg>
                          </button>
                          <div class="ai-actions-dropdown">
                            <div class="ai-action-item" onclick="triggerAiAction('question', this)">
                              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/>
                              </svg>
                              <span>Ask a question about this</span>
                            </div>
                            <div class="ai-action-item" onclick="triggerAiAction('improve', this)">
                              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                              </svg>
                              <span>Improve this text</span>
                            </div>
                            <div class="ai-action-item" onclick="triggerAiAction('summarize', this)">
                              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="21" y1="10" x2="3" y2="10"/><line x1="21" y1="6" x2="3" y2="6"/><line x1="21" y1="14" x2="3" y2="14"/><line x1="21" y1="18" x2="3" y2="18"/>
                              </svg>
                              <span>Summarize</span>
                            </div>
                          </div>
                        </div>
                      </div>
                      <textarea class="form-textarea" style="min-height: 80px; padding-right: 80px;">No acute intracranial abnormality. No evidence of mass, hemorrhage, or territorial infarct. Mild nonspecific white matter changes, likely age-related.</textarea>
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="form-label">Link to PACS</label>
                    <input type="url" class="form-input" placeholder="https://pacs.hospital.com/...">
                  </div>
                </div>
              </div>

              <div class="study-card" onclick="toggleStudyCard(this)">
                <div class="study-card-header">
                  <div class="study-card-title">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                    </svg>
                    <span>CT Head</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 12px;">
                    <span class="study-card-summary" style="color: var(--text-muted);">Not documented</span>
                    <svg class="study-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.2s;">
                      <polyline points="6 9 12 15 18 9"/>
                    </svg>
                  </div>
                </div>
                <div class="study-card-content" onclick="event.stopPropagation()">
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">Date</label>
                      <input type="date" class="form-input">
                    </div>
                    <div class="form-group">
                      <label class="form-label">Interpretation</label>
                      <select class="form-select">
                        <option value="">Select...</option>
                        <option>Normal</option>
                        <option>Abnormal - acute</option>
                        <option>Abnormal - chronic</option>
                        <option>Pending</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="form-label">Findings</label>
                    <div class="ai-textarea-wrapper">
                      <div class="recording-waveform">
                        <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
                        <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
                        <span class="recording-text"><span class="rec-dot"></span>Recording...</span>
                      </div>
                      <div class="ai-textarea-icons">
                        <div style="position: relative;">
                          <button class="quick-phrases-btn" onclick="toggleQuickPhrases(this)" title="Quick Phrases">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <path d="M4 7V4h16v3"/><path d="M9 20h6"/><path d="M12 4v16"/>
                            </svg>
                          </button>
                          <div class="quick-phrases-dropdown">
                            <div class="quick-phrases-header">Quick Phrases</div>
                            <div class="quick-phrase-item" onclick="insertQuickPhrase(this, 'No acute intracranial abnormality.')"><span class="phrase-shortcut">.normal</span>No acute intracranial abnormality</div>
                            <div class="quick-phrase-item" onclick="insertQuickPhrase(this, 'No evidence of acute hemorrhage, mass effect, or midline shift.')"><span class="phrase-shortcut">.neg</span>No hemorrhage, mass effect...</div>
                            <div class="quick-phrase-item" onclick="insertQuickPhrase(this, 'Findings consistent with prior study.')"><span class="phrase-shortcut">.prior</span>Consistent with prior study</div>
                            <div class="quick-phrase-item" onclick="insertQuickPhrase(this, 'Recommend clinical correlation.')"><span class="phrase-shortcut">.corr</span>Recommend clinical correlation</div>
                          </div>
                        </div>
                        <button class="ai-icon-btn" onclick="toggleRecording(this)" title="Dictate with AI">
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/>
                          </svg>
                        </button>
                        <div style="position: relative;">
                          <button class="ai-icon-btn sparkle" onclick="toggleAiDropdown(this)" title="AI Actions">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                            </svg>
                          </button>
                          <div class="ai-actions-dropdown">
                            <div class="ai-action-item" onclick="triggerAiAction('question', this)">
                              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/>
                              </svg>
                              <span>Ask a question about this</span>
                            </div>
                            <div class="ai-action-item" onclick="triggerAiAction('improve', this)">
                              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                              </svg>
                              <span>Improve this text</span>
                            </div>
                            <div class="ai-action-item" onclick="triggerAiAction('summarize', this)">
                              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="21" y1="10" x2="3" y2="10"/><line x1="21" y1="6" x2="3" y2="6"/><line x1="21" y1="14" x2="3" y2="14"/><line x1="21" y1="18" x2="3" y2="18"/>
                              </svg>
                              <span>Summarize</span>
                            </div>
                          </div>
                        </div>
                      </div>
                      <textarea class="form-textarea" style="min-height: 80px; padding-right: 80px;" placeholder="Enter imaging findings..."></textarea>
                    </div>
                  </div>
                </div>
              </div>

              <div class="study-card" onclick="toggleStudyCard(this)">
                <div class="study-card-header">
                  <div class="study-card-title">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                    </svg>
                    <span>CTA Head & Neck</span>
                  </div>
                  <svg class="study-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"/>
                  </svg>
                </div>
                <div class="study-card-content" onclick="event.stopPropagation()">
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">Date</label>
                      <input type="date" class="form-input">
                    </div>
                    <div class="form-group">
                      <label class="form-label">Interpretation</label>
                      <select class="form-select">
                        <option value="">Select...</option>
                        <option>Normal</option>
                        <option>Abnormal - acute</option>
                        <option>Abnormal - chronic</option>
                        <option>Pending</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="form-label">Findings</label>
                    <div class="ai-textarea-wrapper">
                      <div class="recording-waveform">
                        <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
                        <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
                        <span class="recording-text"><span class="rec-dot"></span>Recording...</span>
                      </div>
                      <div class="ai-textarea-icons">
                        <div style="position: relative;">
                          <button class="quick-phrases-btn" onclick="toggleQuickPhrases(this)" title="Quick Phrases">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <path d="M4 7V4h16v3"/><path d="M9 20h6"/><path d="M12 4v16"/>
                            </svg>
                          </button>
                          <div class="quick-phrases-dropdown">
                            <div class="quick-phrases-header">Quick Phrases</div>
                            <div class="quick-phrase-item" onclick="insertQuickPhrase(this, 'No acute intracranial abnormality.')"><span class="phrase-shortcut">.normal</span>No acute intracranial abnormality</div>
                            <div class="quick-phrase-item" onclick="insertQuickPhrase(this, 'No evidence of acute hemorrhage, mass effect, or midline shift.')"><span class="phrase-shortcut">.neg</span>No hemorrhage, mass effect...</div>
                            <div class="quick-phrase-item" onclick="insertQuickPhrase(this, 'Findings consistent with prior study.')"><span class="phrase-shortcut">.prior</span>Consistent with prior study</div>
                            <div class="quick-phrase-item" onclick="insertQuickPhrase(this, 'Recommend clinical correlation.')"><span class="phrase-shortcut">.corr</span>Recommend clinical correlation</div>
                          </div>
                        </div>
                        <button class="ai-icon-btn" onclick="toggleRecording(this)" title="Dictate with AI">
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/>
                          </svg>
                        </button>
                        <div style="position: relative;">
                          <button class="ai-icon-btn sparkle" onclick="toggleAiDropdown(this)" title="AI Actions">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                            </svg>
                          </button>
                          <div class="ai-actions-dropdown">
                            <div class="ai-action-item" onclick="triggerAiAction('question', this)">
                              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/>
                              </svg>
                              <span>Ask a question about this</span>
                            </div>
                            <div class="ai-action-item" onclick="triggerAiAction('improve', this)">
                              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                              </svg>
                              <span>Improve this text</span>
                            </div>
                            <div class="ai-action-item" onclick="triggerAiAction('summarize', this)">
                              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="21" y1="10" x2="3" y2="10"/><line x1="21" y1="6" x2="3" y2="6"/><line x1="21" y1="14" x2="3" y2="14"/><line x1="21" y1="18" x2="3" y2="18"/>
                              </svg>
                              <span>Summarize</span>
                            </div>
                          </div>
                        </div>
                      </div>
                      <textarea class="form-textarea" style="min-height: 80px; padding-right: 80px;" placeholder="Enter imaging findings..."></textarea>
                    </div>
                  </div>
                </div>
              </div>

              <button style="display: flex; align-items: center; gap: 6px; padding: 10px 16px; background: var(--bg-gray); border: 1px dashed var(--border); border-radius: 8px; color: var(--primary); cursor: pointer; width: 100%; justify-content: center; margin-top: 8px;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                Add Study
              </button>
            </div>

            <div class="form-section">
              <div class="section-header">
                <span class="section-title">Neurodiagnostic Studies</span>
                <span class="optional-badge">Optional</span>
              </div>

              <div class="study-card" onclick="toggleStudyCard(this)">
                <div class="study-card-header">
                  <div class="study-card-title">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                    </svg>
                    <span>EEG</span>
                  </div>
                  <svg class="study-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"/>
                  </svg>
                </div>
                <div class="study-card-content" onclick="event.stopPropagation()">
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">Date</label>
                      <input type="date" class="form-input">
                    </div>
                    <div class="form-group">
                      <label class="form-label">Type</label>
                      <select class="form-select">
                        <option>Routine</option>
                        <option>LTM</option>
                        <option>Ambulatory</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label class="form-label">Duration</label>
                      <input type="text" class="form-input" placeholder="e.g., 20 min">
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="form-label">Findings</label>
                    <div class="ai-textarea-wrapper">
                      <div class="recording-waveform">
                        <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
                        <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
                        <span class="recording-text"><span class="rec-dot"></span>Recording...</span>
                      </div>
                      <div class="ai-textarea-icons">
                        <div style="position: relative;">
                          <button class="quick-phrases-btn" onclick="toggleQuickPhrases(this)" title="Quick Phrases">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <path d="M4 7V4h16v3"/><path d="M9 20h6"/><path d="M12 4v16"/>
                            </svg>
                          </button>
                          <div class="quick-phrases-dropdown">
                            <div class="quick-phrases-header">Quick Phrases</div>
                            <div class="quick-phrase-item" onclick="insertQuickPhrase(this, 'No acute intracranial abnormality.')"><span class="phrase-shortcut">.normal</span>No acute intracranial abnormality</div>
                            <div class="quick-phrase-item" onclick="insertQuickPhrase(this, 'No evidence of acute hemorrhage, mass effect, or midline shift.')"><span class="phrase-shortcut">.neg</span>No hemorrhage, mass effect...</div>
                            <div class="quick-phrase-item" onclick="insertQuickPhrase(this, 'Findings consistent with prior study.')"><span class="phrase-shortcut">.prior</span>Consistent with prior study</div>
                            <div class="quick-phrase-item" onclick="insertQuickPhrase(this, 'Recommend clinical correlation.')"><span class="phrase-shortcut">.corr</span>Recommend clinical correlation</div>
                          </div>
                        </div>
                        <button class="ai-icon-btn" onclick="toggleRecording(this)" title="Dictate with AI">
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/>
                          </svg>
                        </button>
                        <div style="position: relative;">
                          <button class="ai-icon-btn sparkle" onclick="toggleAiDropdown(this)" title="AI Actions">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                            </svg>
                          </button>
                          <div class="ai-actions-dropdown">
                            <div class="ai-action-item" onclick="triggerAiAction('question', this)">
                              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/>
                              </svg>
                              <span>Ask a question about this</span>
                            </div>
                            <div class="ai-action-item" onclick="triggerAiAction('improve', this)">
                              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                              </svg>
                              <span>Improve this text</span>
                            </div>
                            <div class="ai-action-item" onclick="triggerAiAction('summarize', this)">
                              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="21" y1="10" x2="3" y2="10"/><line x1="21" y1="6" x2="3" y2="6"/><line x1="21" y1="14" x2="3" y2="14"/><line x1="21" y1="18" x2="3" y2="18"/>
                              </svg>
                              <span>Summarize</span>
                            </div>
                          </div>
                        </div>
                      </div>
                      <textarea class="form-textarea" style="min-height: 80px; padding-right: 80px;" placeholder="Enter EEG findings..."></textarea>
                    </div>
                  </div>
                </div>
              </div>

              <div class="study-card" onclick="toggleStudyCard(this)">
                <div class="study-card-header">
                  <div class="study-card-title">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                    </svg>
                    <span>EMG/NCS</span>
                  </div>
                  <svg class="study-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"/>
                  </svg>
                </div>
                <div class="study-card-content" onclick="event.stopPropagation()">
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">Date</label>
                      <input type="date" class="form-input">
                    </div>
                    <div class="form-group">
                      <label class="form-label">Interpretation</label>
                      <select class="form-select">
                        <option value="">Select...</option>
                        <option>Normal</option>
                        <option>Abnormal</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="form-label">Findings</label>
                    <div class="ai-textarea-wrapper">
                      <div class="recording-waveform">
                        <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
                        <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
                        <span class="recording-text"><span class="rec-dot"></span>Recording...</span>
                      </div>
                      <div class="ai-textarea-icons">
                        <div style="position: relative;">
                          <button class="quick-phrases-btn" onclick="toggleQuickPhrases(this)" title="Quick Phrases">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <path d="M4 7V4h16v3"/><path d="M9 20h6"/><path d="M12 4v16"/>
                            </svg>
                          </button>
                          <div class="quick-phrases-dropdown">
                            <div class="quick-phrases-header">Quick Phrases</div>
                            <div class="quick-phrase-item" onclick="insertQuickPhrase(this, 'No acute intracranial abnormality.')"><span class="phrase-shortcut">.normal</span>No acute intracranial abnormality</div>
                            <div class="quick-phrase-item" onclick="insertQuickPhrase(this, 'No evidence of acute hemorrhage, mass effect, or midline shift.')"><span class="phrase-shortcut">.neg</span>No hemorrhage, mass effect...</div>
                            <div class="quick-phrase-item" onclick="insertQuickPhrase(this, 'Findings consistent with prior study.')"><span class="phrase-shortcut">.prior</span>Consistent with prior study</div>
                            <div class="quick-phrase-item" onclick="insertQuickPhrase(this, 'Recommend clinical correlation.')"><span class="phrase-shortcut">.corr</span>Recommend clinical correlation</div>
                          </div>
                        </div>
                        <button class="ai-icon-btn" onclick="toggleRecording(this)" title="Dictate with AI">
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/>
                          </svg>
                        </button>
                        <div style="position: relative;">
                          <button class="ai-icon-btn sparkle" onclick="toggleAiDropdown(this)" title="AI Actions">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                            </svg>
                          </button>
                          <div class="ai-actions-dropdown">
                            <div class="ai-action-item" onclick="triggerAiAction('question', this)">
                              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/>
                              </svg>
                              <span>Ask a question about this</span>
                            </div>
                            <div class="ai-action-item" onclick="triggerAiAction('improve', this)">
                              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                              </svg>
                              <span>Improve this text</span>
                            </div>
                            <div class="ai-action-item" onclick="triggerAiAction('summarize', this)">
                              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="21" y1="10" x2="3" y2="10"/><line x1="21" y1="6" x2="3" y2="6"/><line x1="21" y1="14" x2="3" y2="14"/><line x1="21" y1="18" x2="3" y2="18"/>
                              </svg>
                              <span>Summarize</span>
                            </div>
                          </div>
                        </div>
                      </div>
                      <textarea class="form-textarea" style="min-height: 80px; padding-right: 80px;" placeholder="Enter EMG/NCS findings..."></textarea>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="form-section">
              <div class="section-header">
                <span class="section-title">Laboratory Results</span>
                <span class="optional-badge">Optional</span>
              </div>
              <div class="chips-container">
                <span class="chip" onclick="toggleChip(this)">CBC</span>
                <span class="chip" onclick="toggleChip(this)">CMP</span>
                <span class="chip" onclick="toggleChip(this)">TSH</span>
                <span class="chip" onclick="toggleChip(this)">Lipid panel</span>
                <span class="chip" onclick="toggleChip(this)">HbA1c</span>
                <span class="chip" onclick="toggleChip(this)">Vitamin B12</span>
                <span class="chip" onclick="toggleChip(this)">Vitamin D</span>
                <span class="chip" onclick="toggleChip(this)">Drug levels</span>
                <span class="chip" onclick="toggleChip(this)">Other labs</span>
              </div>
            </div>
          </div>

          <!-- Physical Exam Tab -->
          <div id="exam-tab" class="tab-pane" data-order="2">
            <div class="section-divider">
              <div class="section-icon">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M16 4h2a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/><path d="M9 14l2 2 4-4"/>
                </svg>
              </div>
              <h3>Physical Exams</h3>
            </div>
            <div class="form-section">
              <div class="section-header">
                <span class="section-title">Initial Assessment</span>
                <span class="optional-badge">Optional</span>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Select date</label>
                  <input type="date" class="form-input" value="2026-01-16">
                </div>
                <div class="form-group">
                  <label class="form-label">Military Time (PST)</label>
                  <div style="display: flex; gap: 8px; align-items: center;">
                    <input type="text" class="form-input" style="width: 60px;" placeholder="HH" value="14">
                    <span>:</span>
                    <input type="text" class="form-input" style="width: 60px;" placeholder="MM" value="30">
                    <button style="padding: 10px 16px; background: var(--bg-gray); border: 1px solid var(--border); border-radius: 6px; cursor: pointer;">Now</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="form-section">
              <div class="section-header">
                <span class="section-title">Vital Signs</span>
                <span class="optional-badge">Optional</span>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Blood Pressure (mm/Hg)</label>
                  <input type="text" class="form-input" placeholder="120/80">
                </div>
                <div class="form-group">
                  <label class="form-label">Pulse (bpm)</label>
                  <input type="text" class="form-input" placeholder="72">
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Oxygen saturation (%)</label>
                  <input type="text" class="form-input" placeholder="98">
                </div>
                <div class="form-group">
                  <label class="form-label">Temperature</label>
                  <input type="text" class="form-input" placeholder="98.6">
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Fever symptoms</label>
                <div style="display: flex; gap: 8px; margin-top: 6px;">
                  <button class="chip" onclick="toggleChip(this)">Febrile</button>
                  <button class="chip selected" onclick="toggleChip(this)">Afebrile</button>
                </div>
              </div>
            </div>

            <div class="form-section">
              <div class="section-header">
                <span class="section-title">Neurological Examination</span>
                <span class="optional-badge">Optional</span>
              </div>

              <button class="exam-quick-btn" onclick="fillNormalExam()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"/>
                </svg>
                Normal Neurological Exam
              </button>

              <div class="accordion open" onclick="toggleAccordion(this)">
                <div class="accordion-header">
                  <span class="accordion-title">
                    <span class="status-dot filled"></span>
                    General Appearance
                  </span>
                  <svg class="accordion-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"/>
                  </svg>
                </div>
                <div class="accordion-content" onclick="event.stopPropagation()">
                  <select class="form-select">
                    <option selected>In no apparent distress</option>
                    <option>Appears uncomfortable</option>
                    <option>Appears ill</option>
                    <option>Appears anxious</option>
                  </select>
                </div>
              </div>

              <div class="accordion open" onclick="toggleAccordion(this)">
                <div class="accordion-header">
                  <span class="accordion-title">
                    <span class="status-dot filled"></span>
                    Mental Status
                  </span>
                  <svg class="accordion-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"/>
                  </svg>
                </div>
                <div class="accordion-content" onclick="event.stopPropagation()">
                  <div class="exam-subsection">
                    <h5>Level of Consciousness</h5>
                    <div class="exam-grid">
                      <label class="option-item"><input type="radio" name="loc" checked> Awake, Alert</label>
                      <label class="option-item"><input type="radio" name="loc"> Drowsy</label>
                      <label class="option-item"><input type="radio" name="loc"> Obtunded</label>
                      <label class="option-item"><input type="radio" name="loc"> Comatose</label>
                    </div>
                  </div>
                  <div class="exam-subsection">
                    <h5>Orientation</h5>
                    <div class="exam-grid">
                      <label class="option-item"><input type="checkbox" checked> Name</label>
                      <label class="option-item"><input type="checkbox" checked> Date</label>
                      <label class="option-item"><input type="checkbox" checked> Location</label>
                      <label class="option-item"><input type="checkbox" checked> Situation</label>
                    </div>
                  </div>
                  <div class="exam-subsection">
                    <label class="option-item"><input type="checkbox" checked> Following commands</label>
                  </div>
                </div>
              </div>

              <div class="accordion open" onclick="toggleAccordion(this)">
                <div class="accordion-header">
                  <span class="accordion-title">
                    <span class="status-dot filled"></span>
                    Cranial Nerves
                  </span>
                  <svg class="accordion-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"/>
                  </svg>
                </div>
                <div class="accordion-content" onclick="event.stopPropagation()">
                  <div class="exam-grid">
                    <label class="option-item"><input type="checkbox" checked> Visual fields full to confrontation</label>
                    <label class="option-item"><input type="checkbox" checked> Pupils equal and reactive</label>
                    <label class="option-item"><input type="checkbox" checked> EOMs full, no nystagmus</label>
                    <label class="option-item"><input type="checkbox" checked> Facial sensation intact</label>
                    <label class="option-item"><input type="checkbox" checked> Face symmetric</label>
                    <label class="option-item"><input type="checkbox" checked> Hearing grossly intact</label>
                    <label class="option-item"><input type="checkbox" checked> Palate elevates symmetrically</label>
                    <label class="option-item"><input type="checkbox" checked> Tongue midline</label>
                  </div>
                </div>
              </div>

              <div class="accordion open" onclick="toggleAccordion(this)">
                <div class="accordion-header">
                  <span class="accordion-title">
                    <span class="status-dot filled"></span>
                    Motor
                  </span>
                  <svg class="accordion-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"/>
                  </svg>
                </div>
                <div class="accordion-content" onclick="event.stopPropagation()">
                  <div class="exam-grid">
                    <label class="option-item"><input type="checkbox" checked> Normal bulk</label>
                    <label class="option-item"><input type="checkbox" checked> Normal tone</label>
                    <label class="option-item"><input type="checkbox" checked> Strength 5/5 all extremities</label>
                    <label class="option-item"><input type="checkbox" checked> No pronator drift</label>
                  </div>
                </div>
              </div>

              <div class="accordion open" onclick="toggleAccordion(this)">
                <div class="accordion-header">
                  <span class="accordion-title">
                    <span class="status-dot filled"></span>
                    Sensation
                  </span>
                  <svg class="accordion-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"/>
                  </svg>
                </div>
                <div class="accordion-content" onclick="event.stopPropagation()">
                  <div class="exam-grid">
                    <label class="option-item"><input type="checkbox" checked> Light touch intact</label>
                    <label class="option-item"><input type="checkbox" checked> Pinprick intact</label>
                    <label class="option-item"><input type="checkbox" checked> Vibration intact</label>
                    <label class="option-item"><input type="checkbox" checked> Proprioception intact</label>
                  </div>
                </div>
              </div>

              <div class="accordion open" onclick="toggleAccordion(this)">
                <div class="accordion-header">
                  <span class="accordion-title">
                    <span class="status-dot filled"></span>
                    Coordination
                  </span>
                  <svg class="accordion-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"/>
                  </svg>
                </div>
                <div class="accordion-content" onclick="event.stopPropagation()">
                  <div class="exam-grid">
                    <label class="option-item"><input type="checkbox" checked> Finger-to-nose intact</label>
                    <label class="option-item"><input type="checkbox" checked> Heel-to-shin intact</label>
                    <label class="option-item"><input type="checkbox" checked> Rapid alternating movements intact</label>
                  </div>
                </div>
              </div>

              <div class="accordion" onclick="toggleAccordion(this)">
                <div class="accordion-header">
                  <span class="accordion-title">
                    <span class="status-dot"></span>
                    Gait
                  </span>
                  <svg class="accordion-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"/>
                  </svg>
                </div>
                <div class="accordion-content" onclick="event.stopPropagation()">
                  <div class="option-group" style="margin-bottom: 12px;">
                    <label class="option-item"><input type="radio" name="gait" checked> Evaluated</label>
                    <label class="option-item"><input type="radio" name="gait"> Not evaluated</label>
                  </div>
                  <div class="exam-grid">
                    <label class="option-item"><input type="checkbox"> Station normal</label>
                    <label class="option-item"><input type="checkbox"> Casual gait normal</label>
                    <label class="option-item"><input type="checkbox"> Tandem gait normal</label>
                    <label class="option-item"><input type="checkbox"> Romberg negative</label>
                  </div>
                </div>
              </div>
            </div>

            <div class="form-section">
              <div class="section-header">
                <span class="section-title">General Notes</span>
                <span class="optional-badge">Optional</span>
              </div>
              <div class="ai-textarea-wrapper">
                <div class="recording-waveform">
                  <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
                  <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
                  <span class="recording-text"><span class="rec-dot"></span>Recording...</span>
                </div>
                <div class="ai-textarea-icons">
                  <div style="position: relative;">
                    <button class="quick-phrases-btn" onclick="toggleQuickPhrases(this)" title="Quick Phrases">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 7V4h16v3"/><path d="M9 20h6"/><path d="M12 4v16"/>
                      </svg>
                    </button>
                    <div class="quick-phrases-dropdown">
                      <div class="quick-phrases-header">Quick Phrases</div>
                      <div class="quick-phrase-item" onclick="insertQuickPhrase(this, 'Patient denies any recent changes in symptoms.')"><span class="phrase-shortcut">.deny</span>Patient denies any recent changes...</div>
                      <div class="quick-phrase-item" onclick="insertQuickPhrase(this, 'No new neurological deficits noted on examination.')"><span class="phrase-shortcut">.neuro</span>No new neurological deficits...</div>
                      <div class="quick-phrase-item" onclick="insertQuickPhrase(this, 'Patient reports compliance with current medication regimen.')"><span class="phrase-shortcut">.comp</span>Patient reports compliance...</div>
                      <div class="quick-phrase-item" onclick="insertQuickPhrase(this, 'Symptoms are stable compared to last visit.')"><span class="phrase-shortcut">.stable</span>Symptoms are stable...</div>
                      <div class="quick-phrase-item" onclick="insertQuickPhrase(this, 'Will continue current treatment plan and reassess at next visit.')"><span class="phrase-shortcut">.cont</span>Will continue current treatment...</div>
                    </div>
                  </div>
                  <button class="ai-icon-btn" onclick="toggleRecording(this)" title="Dictate with AI">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/>
                    </svg>
                  </button>
                  <div style="position: relative;">
                    <button class="ai-icon-btn sparkle" onclick="toggleAiDropdown(this)" title="AI Actions">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                      </svg>
                    </button>
                    <div class="ai-actions-dropdown">
                      <div class="ai-action-item" onclick="triggerAiAction('question', this)">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/>
                        </svg>
                        <span>Ask a question about this</span>
                      </div>
                      <div class="ai-action-item" onclick="triggerAiAction('improve', this)">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                        </svg>
                        <span>Improve this text</span>
                      </div>
                      <div class="ai-action-item" onclick="triggerAiAction('summarize', this)">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <line x1="21" y1="10" x2="3" y2="10"/><line x1="21" y1="6" x2="3" y2="6"/><line x1="21" y1="14" x2="3" y2="14"/><line x1="21" y1="18" x2="3" y2="18"/>
                        </svg>
                        <span>Summarize</span>
                      </div>
                    </div>
                  </div>
                </div>
                <textarea class="form-textarea" placeholder="Additional examination notes..." style="padding-right: 80px;"></textarea>
              </div>
            </div>
          </div>

          <!-- Recommendation Tab -->
          <div id="recommendation-tab" class="tab-pane" data-order="3">
            <div class="section-divider">
              <div class="section-icon">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/>
                </svg>
              </div>
              <h3>Recommendation</h3>
            </div>
            <div class="form-section">
              <div class="section-header">
                <span class="section-title">Differential diagnosis</span>
                <span class="required-badge">Required</span>
              </div>

              <div class="diagnosis-search">
                <svg class="diagnosis-search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
                </svg>
                <input type="text" class="diagnosis-input" placeholder="Search ICD-10 diagnosis..." oninput="showDiagnosisDropdown(this)" onfocus="showDiagnosisDropdown(this)">
                <div class="diagnosis-dropdown" id="diagnosis-dropdown">
                  <div class="diagnosis-option" onclick="selectDiagnosis('G43.909', 'Migraine, unspecified', 'Headache')">
                    <div>
                      <span class="diagnosis-code">G43.909</span>
                      <span class="diagnosis-name"> - Migraine, unspecified</span>
                    </div>
                    <span class="diagnosis-category">Headache</span>
                  </div>
                  <div class="diagnosis-option" onclick="selectDiagnosis('G43.711', 'Chronic migraine without aura, intractable', 'Headache')">
                    <div>
                      <span class="diagnosis-code">G43.711</span>
                      <span class="diagnosis-name"> - Chronic migraine without aura, intractable</span>
                    </div>
                    <span class="diagnosis-category">Headache</span>
                  </div>
                  <div class="diagnosis-option" onclick="selectDiagnosis('G44.52', 'New daily persistent headache', 'Headache')">
                    <div>
                      <span class="diagnosis-code">G44.52</span>
                      <span class="diagnosis-name"> - New daily persistent headache</span>
                    </div>
                    <span class="diagnosis-category">Headache</span>
                  </div>
                  <div class="diagnosis-option" onclick="selectDiagnosis('G40.909', 'Epilepsy, unspecified', 'Seizure')">
                    <div>
                      <span class="diagnosis-code">G40.909</span>
                      <span class="diagnosis-name"> - Epilepsy, unspecified</span>
                    </div>
                    <span class="diagnosis-category">Seizure</span>
                  </div>
                  <div class="diagnosis-option" onclick="selectDiagnosis('G35', 'Multiple sclerosis', 'Demyelinating')">
                    <div>
                      <span class="diagnosis-code">G35</span>
                      <span class="diagnosis-name"> - Multiple sclerosis</span>
                    </div>
                    <span class="diagnosis-category">Demyelinating</span>
                  </div>
                </div>
              </div>

              <div class="selected-diagnoses" id="selected-diagnoses">
                <div class="diagnosis-pill">
                  <span>G43.711 - Chronic migraine</span>
                  <button class="plan-btn" onclick="openPlanBuilder()" title="Open Plan Builder">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/>
                    </svg>
                  </button>
                  <button class="remove-btn" onclick="this.parentElement.remove()"></button>
                </div>
              </div>
            </div>

            <div class="form-section">
              <div class="section-header">
                <span class="section-title">Assessment</span>
                <span class="required-badge">Required</span>
              </div>

              <button class="ai-generate-btn" onclick="generateAssessment()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                </svg>
                Generate assessment
              </button>

              <div class="ai-textarea-wrapper">
                <div class="recording-waveform">
                  <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
                  <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
                  <span class="recording-text"><span class="rec-dot"></span>Recording...</span>
                </div>
                <div class="ai-textarea-icons">
                  <div style="position: relative;">
                    <button class="quick-phrases-btn" onclick="toggleQuickPhrases(this)" title="Quick Phrases">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 7V4h16v3"/><path d="M9 20h6"/><path d="M12 4v16"/>
                      </svg>
                    </button>
                    <div class="quick-phrases-dropdown">
                      <div class="quick-phrases-header">Quick Phrases</div>
                      <div class="quick-phrase-item" onclick="insertQuickPhrase(this, 'Patient denies any recent changes in symptoms.')"><span class="phrase-shortcut">.deny</span>Patient denies any recent changes...</div>
                      <div class="quick-phrase-item" onclick="insertQuickPhrase(this, 'No new neurological deficits noted on examination.')"><span class="phrase-shortcut">.neuro</span>No new neurological deficits...</div>
                      <div class="quick-phrase-item" onclick="insertQuickPhrase(this, 'Patient reports compliance with current medication regimen.')"><span class="phrase-shortcut">.comp</span>Patient reports compliance...</div>
                      <div class="quick-phrase-item" onclick="insertQuickPhrase(this, 'Symptoms are stable compared to last visit.')"><span class="phrase-shortcut">.stable</span>Symptoms are stable...</div>
                      <div class="quick-phrase-item" onclick="insertQuickPhrase(this, 'Will continue current treatment plan and reassess at next visit.')"><span class="phrase-shortcut">.cont</span>Will continue current treatment...</div>
                    </div>
                  </div>
                  <button class="ai-icon-btn" onclick="toggleRecording(this)" title="Dictate with AI">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/>
                    </svg>
                  </button>
                  <div style="position: relative;">
                    <button class="ai-icon-btn sparkle" onclick="toggleAiDropdown(this)" title="AI Actions">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                      </svg>
                    </button>
                    <div class="ai-actions-dropdown">
                      <div class="ai-action-item" onclick="triggerAiAction('question', this)">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/>
                        </svg>
                        <span>Ask a question about this</span>
                      </div>
                      <div class="ai-action-item" onclick="triggerAiAction('improve', this)">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                        </svg>
                        <span>Improve this text</span>
                      </div>
                      <div class="ai-action-item" onclick="triggerAiAction('summarize', this)">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <line x1="21" y1="10" x2="3" y2="10"/><line x1="21" y1="6" x2="3" y2="6"/><line x1="21" y1="14" x2="3" y2="14"/><line x1="21" y1="18" x2="3" y2="18"/>
                        </svg>
                        <span>Summarize</span>
                      </div>
                    </div>
                  </div>
                </div>
                <textarea class="form-textarea" id="assessment-text" placeholder="Enter a detailed assessment..." style="padding-right: 80px;">50-year-old male with chronic daily headache, likely chronic migraine without aura based on clinical presentation. Patient reports improvement with current prophylactic therapy (topiramate 50mg BID). Headache frequency reduced from daily to 3-4 per week. No red flags present. MRI brain unremarkable. MIDAS score indicates moderate disability (18), HIT-6 indicates substantial impact (58). Plan to continue current regimen and reassess at next visit.</textarea>
              </div>
            </div>

            <div class="form-section">
              <div class="section-header">
                <span class="section-title">Recommendations</span>
                <span class="required-badge">Required</span>
              </div>

              <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                <span class="chip selected" onclick="toggleChip(this)">Pro-note template</span>
                <span class="chip" onclick="toggleChip(this)">Free-text recommendations</span>
              </div>

              <div class="ai-textarea-wrapper">
                <div class="recording-waveform">
                  <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
                  <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
                  <span class="recording-text"><span class="rec-dot"></span>Recording...</span>
                </div>
                <div class="ai-textarea-icons">
                  <div style="position: relative;">
                    <button class="quick-phrases-btn" onclick="toggleQuickPhrases(this)" title="Quick Phrases">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 7V4h16v3"/><path d="M9 20h6"/><path d="M12 4v16"/>
                      </svg>
                    </button>
                    <div class="quick-phrases-dropdown">
                      <div class="quick-phrases-header">Quick Phrases</div>
                      <div class="quick-phrase-item" onclick="insertQuickPhrase(this, 'Patient denies any recent changes in symptoms.')"><span class="phrase-shortcut">.deny</span>Patient denies any recent changes...</div>
                      <div class="quick-phrase-item" onclick="insertQuickPhrase(this, 'No new neurological deficits noted on examination.')"><span class="phrase-shortcut">.neuro</span>No new neurological deficits...</div>
                      <div class="quick-phrase-item" onclick="insertQuickPhrase(this, 'Patient reports compliance with current medication regimen.')"><span class="phrase-shortcut">.comp</span>Patient reports compliance...</div>
                      <div class="quick-phrase-item" onclick="insertQuickPhrase(this, 'Symptoms are stable compared to last visit.')"><span class="phrase-shortcut">.stable</span>Symptoms are stable...</div>
                      <div class="quick-phrase-item" onclick="insertQuickPhrase(this, 'Will continue current treatment plan and reassess at next visit.')"><span class="phrase-shortcut">.cont</span>Will continue current treatment...</div>
                    </div>
                  </div>
                  <button class="ai-icon-btn" onclick="toggleRecording(this)" title="Dictate with AI">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/>
                    </svg>
                  </button>
                  <div style="position: relative;">
                    <button class="ai-icon-btn sparkle" onclick="toggleAiDropdown(this)" title="AI Actions">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                      </svg>
                    </button>
                    <div class="ai-actions-dropdown">
                      <div class="ai-action-item" onclick="triggerAiAction('question', this)">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/>
                        </svg>
                        <span>Ask a question about this</span>
                      </div>
                      <div class="ai-action-item" onclick="triggerAiAction('improve', this)">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                        </svg>
                        <span>Improve this text</span>
                      </div>
                      <div class="ai-action-item" onclick="triggerAiAction('summarize', this)">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <line x1="21" y1="10" x2="3" y2="10"/><line x1="21" y1="6" x2="3" y2="6"/><line x1="21" y1="14" x2="3" y2="14"/><line x1="21" y1="18" x2="3" y2="18"/>
                        </svg>
                        <span>Summarize</span>
                      </div>
                    </div>
                  </div>
                </div>
                <textarea class="form-textarea" id="recommendations-text" style="padding-right: 80px;">1. Continue topiramate 50mg twice daily
2. May increase to 75mg BID if headaches persist at current frequency
3. Headache diary - continue tracking frequency, severity, triggers
4. Avoid known triggers (stress, irregular sleep, skipped meals)
5. Follow up in 3 months or sooner if worsening
6. Call clinic if experiencing new neurological symptoms
7. Consider CGRP antagonist if inadequate response to topiramate optimization</textarea>
              </div>
            </div>

            <div class="form-section">
              <div class="section-header">
                <span class="section-title">Final recommendation time</span>
                <span class="optional-badge">Optional</span>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Select date</label>
                  <input type="date" class="form-input" value="2026-01-16">
                </div>
                <div class="form-group">
                  <label class="form-label">Military Time (PST)</label>
                  <div style="display: flex; gap: 8px; align-items: center;">
                    <input type="text" class="form-input" style="width: 60px;" placeholder="HH" value="15">
                    <span>:</span>
                    <input type="text" class="form-input" style="width: 60px;" placeholder="MM" value="00">
                    <button style="padding: 10px 16px; background: var(--bg-gray); border: 1px solid var(--border); border-radius: 6px; cursor: pointer;">Now</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="output-preview">
              <div class="output-preview-header">
                <h4>Note Preview (Plain Text for EHR)</h4>
                <button class="copy-btn" onclick="copyToClipboard()">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
                  </svg>
                  Copy for EHR
                </button>
              </div>
              <pre>NEUROLOGY OUTPATIENT CONSULTATION

PATIENT: Test Test | 50 M | MRN: 123123
DATE: 01/16/2026

REASON FOR VISIT: Headache

HPI: 50-year-old male presents for follow-up of chronic
daily headaches. Patient reports headaches have improved
from daily to approximately 3-4 per week since starting
topiramate.

CLINICAL SCALES:
- MIDAS: 18 (Moderate disability)
- HIT-6: 58 (Substantial impact)

NEUROLOGICAL EXAMINATION:
General: In no apparent distress
Mental Status: Awake, alert, oriented x4
Cranial Nerves: II-XII intact
Motor: 5/5 strength all extremities, normal tone
Sensory: Intact to light touch
Coordination: FTN, HTS intact bilaterally

IMAGING: MRI Brain (01/05/2026) - Normal

ASSESSMENT:
Chronic migraine without aura (G43.711)
- Improved on current prophylaxis
- No red flags

PLAN:
1. Continue topiramate 50mg twice daily
2. May increase to 75mg BID if needed
3. Continue headache diary
4. Follow up in 3 months
5. Consider CGRP antagonist if inadequate response

Electronically signed by: Dr. Steve Arbogast
01/16/2026 15:00 PST</pre>
            </div>
          </div>
        </div>
      </main>

      <!-- Right Action Bar -->
      <aside class="right-action-bar">
        <button class="action-btn" title="More options">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/>
          </svg>
        </button>
        <button class="action-btn" title="Thumbs up">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 9V5a3 3 0 00-3-3l-4 9v11h11.28a2 2 0 002-1.7l1.38-9a2 2 0 00-2-2.3zM7 22H4a2 2 0 01-2-2v-7a2 2 0 012-2h3"/>
          </svg>
        </button>
        <button class="action-btn" title="Voice record">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/>
          </svg>
        </button>
        <button class="action-btn action-btn-primary" title="Add">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
          </svg>
        </button>
        <button class="action-btn" title="Copy">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
          </svg>
        </button>

        <div class="action-spacer"></div>

        <button class="pend-btn">Pend</button>
        <button class="sign-btn" onclick="showToast('Note signed and completed!', 'success')">Sign & complete</button>
      </aside>
    </div>
  </div>

  <!-- Plan Builder Modal -->
  <div class="modal-overlay" id="plan-builder-modal">
    <div class="plan-builder-modal">
      <div class="plan-builder-header">
        <h2>Recommendation plan for Chronic Migraine</h2>
        <div class="plan-builder-tabs">
          <button class="plan-tab active">Customize</button>
          <button class="plan-tab">Use standard</button>
        </div>
      </div>
      <div class="plan-builder-content">
        <div class="plan-section">
          <div class="plan-section-header">
            <span class="plan-section-title">Laboratory Testing</span>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"/>
            </svg>
          </div>
          <div class="plan-checkbox-list">
            <div class="plan-checkbox-item">
              <input type="checkbox" id="lab-cbc">
              <label for="lab-cbc">CBC</label>
            </div>
            <div class="plan-checkbox-item">
              <input type="checkbox" id="lab-cmp">
              <label for="lab-cmp">CMP</label>
            </div>
            <div class="plan-checkbox-item">
              <input type="checkbox" id="lab-tsh">
              <label for="lab-tsh">TSH</label>
            </div>
            <div class="plan-checkbox-item">
              <input type="checkbox" id="lab-mg">
              <label for="lab-mg">Magnesium level</label>
            </div>
          </div>
        </div>

        <div class="plan-section">
          <div class="plan-section-header">
            <span class="plan-section-title">Diagnostic Studies</span>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"/>
            </svg>
          </div>
          <div class="plan-checkbox-list">
            <div class="plan-checkbox-item">
              <input type="checkbox" id="img-mri" checked>
              <label for="img-mri">MRI brain without contrast</label>
            </div>
            <div class="plan-checkbox-item">
              <input type="checkbox" id="img-mra">
              <label for="img-mra">MRA head</label>
            </div>
            <div class="plan-checkbox-item">
              <input type="checkbox" id="img-ct">
              <label for="img-ct">CT head without contrast</label>
            </div>
          </div>
        </div>

        <div class="plan-section">
          <div class="plan-section-header">
            <span class="plan-section-title">Treatments - Preventive</span>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"/>
            </svg>
          </div>
          <div class="plan-checkbox-list">
            <div class="plan-checkbox-item">
              <input type="checkbox" id="med-topiramate" checked>
              <label for="med-topiramate">Topiramate 25-100mg BID</label>
            </div>
            <div class="plan-checkbox-item">
              <input type="checkbox" id="med-propranolol">
              <label for="med-propranolol">Propranolol 40-160mg daily</label>
            </div>
            <div class="plan-checkbox-item">
              <input type="checkbox" id="med-amitriptyline">
              <label for="med-amitriptyline">Amitriptyline 10-50mg QHS</label>
            </div>
            <div class="plan-checkbox-item">
              <input type="checkbox" id="med-cgrp">
              <label for="med-cgrp">CGRP antagonist (Aimovig, Ajovy, Emgality)</label>
            </div>
            <div class="plan-checkbox-item">
              <input type="checkbox" id="med-botox">
              <label for="med-botox">OnabotulinumtoxinA (Botox) q12 weeks</label>
            </div>
          </div>
        </div>

        <div class="plan-section">
          <div class="plan-section-header">
            <span class="plan-section-title">Treatments - Abortive</span>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"/>
            </svg>
          </div>
          <div class="plan-checkbox-list">
            <div class="plan-checkbox-item">
              <input type="checkbox" id="med-triptan" checked>
              <label for="med-triptan">Sumatriptan 50-100mg PRN</label>
            </div>
            <div class="plan-checkbox-item">
              <input type="checkbox" id="med-nsaid">
              <label for="med-nsaid">NSAIDs (Ibuprofen, Naproxen) PRN</label>
            </div>
            <div class="plan-checkbox-item">
              <input type="checkbox" id="med-gepant">
              <label for="med-gepant">Ubrogepant/Rimegepant PRN</label>
            </div>
          </div>
        </div>

        <div class="plan-section">
          <div class="plan-section-header">
            <span class="plan-section-title">Referrals</span>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"/>
            </svg>
          </div>
          <div class="plan-checkbox-list">
            <div class="plan-checkbox-item">
              <input type="checkbox" id="ref-neuro">
              <label for="ref-neuro">Neurology follow-up</label>
            </div>
            <div class="plan-checkbox-item">
              <input type="checkbox" id="ref-headache">
              <label for="ref-headache">Headache specialist</label>
            </div>
            <div class="plan-checkbox-item">
              <input type="checkbox" id="ref-psych">
              <label for="ref-psych">Psychology/CBT for headache</label>
            </div>
            <div class="plan-checkbox-item">
              <input type="checkbox" id="ref-pt">
              <label for="ref-pt">Physical therapy</label>
            </div>
          </div>
        </div>

        <div class="plan-section">
          <div class="plan-section-header">
            <span class="plan-section-title">Patient Education</span>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"/>
            </svg>
          </div>
          <div class="plan-checkbox-list">
            <div class="plan-checkbox-item">
              <input type="checkbox" id="edu-diary" checked>
              <label for="edu-diary">Maintain headache diary</label>
            </div>
            <div class="plan-checkbox-item">
              <input type="checkbox" id="edu-triggers" checked>
              <label for="edu-triggers">Avoid known triggers</label>
            </div>
            <div class="plan-checkbox-item">
              <input type="checkbox" id="edu-sleep">
              <label for="edu-sleep">Regular sleep schedule</label>
            </div>
            <div class="plan-checkbox-item">
              <input type="checkbox" id="edu-moh">
              <label for="edu-moh">Medication overuse headache counseling</label>
            </div>
          </div>
        </div>
      </div>
      <div class="plan-builder-footer">
        <button class="btn-cancel" onclick="closePlanBuilder()">Cancel</button>
        <button class="btn-apply" onclick="applyPlan()">Apply to Recommendations</button>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div class="toast" id="toast">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <polyline points="20 6 9 17 4 12"/>
    </svg>
    <span id="toast-message">Copied to clipboard!</span>
  </div>

  <!-- AI Response Modal -->
  <div class="ai-response-modal" id="ai-response-modal">
    <div class="ai-response-content">
      <div class="ai-response-header">
        <h3>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
          </svg>
          <span id="ai-modal-title">AI Assistant</span>
        </h3>
        <button class="ai-response-close" onclick="closeAiModal()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="ai-response-body">
        <div class="ai-thinking" id="ai-thinking">
          <div class="ai-thinking-dots">
            <span></span><span></span><span></span>
          </div>
          <span>AI is thinking...</span>
        </div>
        <div class="ai-response-text" id="ai-response-text" style="display: none;"></div>
      </div>
      <div class="ai-response-footer" id="ai-response-footer" style="display: none;">
        <button class="ai-btn-secondary" onclick="closeAiModal()">Cancel</button>
        <button class="ai-btn-primary" onclick="applyAiResponse()">Apply</button>
      </div>
    </div>
  </div>

  <!-- MIDAS Score Detail Modal -->
  <div class="score-detail-modal" id="score-detail-modal">
    <div class="score-detail-content">
      <div class="score-detail-header">
        <h3 id="score-detail-title">MIDAS Score Details</h3>
        <button class="ai-response-close" onclick="closeScoreDetailModal()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="score-detail-body">
        <div class="score-detail-summary">
          <div>
            <div class="score-detail-value" id="score-detail-value">18</div>
            <div class="score-detail-interpretation" id="score-detail-interp">Moderate Disability</div>
          </div>
          <div style="text-align: right;">
            <div style="font-size: 12px; color: var(--text-muted);" id="score-detail-date">Jan 16, 2026</div>
          </div>
        </div>
        <div class="score-detail-questions">
          <h4>Question Responses</h4>
          <div id="score-questions-list">
            <!-- Filled dynamically -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Guided Tour Overlay and Tooltip -->
  <div class="tour-overlay" id="tour-overlay"></div>
  <div class="tour-tooltip" id="tour-tooltip">
    <div class="tour-tooltip-header">
      <div class="tour-tooltip-icon">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
        </svg>
      </div>
      <div>
        <div class="tour-tooltip-title" id="tour-title">Welcome</div>
        <div class="tour-tooltip-step" id="tour-step">Step 1 of 7</div>
      </div>
    </div>
    <div class="tour-tooltip-content" id="tour-content">
      Welcome to the Sevaro Outpatient Clinical Note demo. This tour will guide you through the key features.
    </div>
    <div class="tour-tooltip-footer">
      <div class="tour-dots" id="tour-dots"></div>
      <div class="tour-buttons">
        <button class="tour-btn tour-btn-skip" onclick="endTour()">Skip</button>
        <button class="tour-btn tour-btn-prev" id="tour-prev-btn" onclick="prevTourStep()" style="display: none;">Back</button>
        <button class="tour-btn tour-btn-next" id="tour-next-btn" onclick="nextTourStep()">Next</button>
      </div>
    </div>
  </div>

  <!-- AI Drawer Overlay and Panel -->
  <div class="ai-drawer-overlay" id="ai-drawer-overlay" onclick="closeAiDrawer()"></div>
  <div class="ai-drawer" id="ai-drawer">
    <div class="ai-drawer-header">
      <div class="ai-drawer-header-left">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
        </svg>
        <h3 id="ai-drawer-title">AI Tools</h3>
      </div>
      <button class="ai-drawer-close" onclick="closeAiDrawer()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div class="ai-drawer-tabs">
      <button class="ai-drawer-tab active" onclick="switchAiDrawerTab('chart-prep')">Chart Prep</button>
      <button class="ai-drawer-tab" onclick="switchAiDrawerTab('document')">Document</button>
      <button class="ai-drawer-tab" onclick="switchAiDrawerTab('ask-ai')">Ask AI</button>
      <button class="ai-drawer-tab" onclick="switchAiDrawerTab('summarize')">Summarize</button>
      <button class="ai-drawer-tab" onclick="switchAiDrawerTab('handout')">Handout</button>
    </div>
    <div class="ai-drawer-content">
      <!-- Chart Prep Pane -->
      <div class="ai-drawer-pane active" id="pane-chart-prep">
        <!-- AI Live Listening Indicator -->
        <div class="ai-live-indicator">
          <div class="ai-live-icon">
            <div class="pulse-ring"></div>
            <div class="pulse-ring"></div>
            <div class="core">
              <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                <path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/>
              </svg>
            </div>
          </div>
          <div class="ai-live-text">
            <h5>
              <span class="live-dot"></span>
              AI Listening
            </h5>
            <p>Monitoring conversation for real-time chart updates</p>
          </div>
          <div class="sound-waves">
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
          </div>
        </div>

        <div class="ai-context-section" onclick="toggleAiContext(this)">
          <div class="ai-context-header">
            <h5>AI Context (from chart)</h5>
            <span class="ai-context-toggle">Show more</span>
          </div>
          <div class="ai-context-preview" id="chart-prep-context-preview">Loading patient data...</div>
          <div class="ai-context-full" id="chart-prep-context-full"></div>
        </div>

        <div class="chart-prep-section">
          <h4>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/>
            </svg>
            Patient Overview
          </h4>
          <div class="chart-prep-content" id="chart-prep-overview">
            <strong>Test Test</strong> - 50 y/o male presenting for follow-up of chronic migraines. Patient has history of episodic migraines evolving to chronic pattern over 2 years.
          </div>
        </div>

        <div class="chart-prep-section">
          <h4>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
            </svg>
            Recent Results Summary
          </h4>
          <div class="chart-prep-content">
            <ul>
              <li><strong>MRI Brain (Dec 2025):</strong> <span class="chart-prep-badge normal">Normal</span> - No acute intracranial abnormality</li>
              <li><strong>CT Head (Nov 2025):</strong> <span class="chart-prep-badge normal">Normal</span> - No hemorrhage or mass effect</li>
              <li><strong>EEG (Oct 2025):</strong> <span class="chart-prep-badge abnormal">Abnormal</span> - Mild diffuse slowing</li>
            </ul>
          </div>
        </div>

        <div class="chart-prep-section">
          <h4>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20v-4"/>
            </svg>
            Scale Trends
          </h4>
          <div class="chart-prep-content">
            <ul>
              <li><strong>MIDAS:</strong> 56  42  24  18 (improving, -68% from baseline)</li>
              <li><strong>HIT-6:</strong> 68  62  58 (improving trend)</li>
              <li><strong>PHQ-9:</strong> 12  8  6 (mild depression, improving)</li>
            </ul>
          </div>
        </div>

        <div class="chart-prep-section">
          <h4>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/>
            </svg>
            Suggested Discussion Points
          </h4>
          <div class="chart-prep-content">
            <ul>
              <li>Review current preventive medication efficacy (topiramate 100mg)</li>
              <li>Discuss MIDAS score improvement and treatment response</li>
              <li>Consider CGRP inhibitor if further optimization needed</li>
              <li>Address sleep hygiene and trigger avoidance</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Document Interaction Pane -->
      <div class="ai-drawer-pane" id="pane-document">
        <!-- AI Live Listening Indicator -->
        <div class="ai-live-indicator">
          <div class="ai-live-icon">
            <div class="pulse-ring"></div>
            <div class="pulse-ring"></div>
            <div class="core">
              <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                <path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/>
              </svg>
            </div>
          </div>
          <div class="ai-live-text">
            <h5>
              <span class="live-dot"></span>
              AI Listening
            </h5>
            <p>Transcribing and documenting patient interaction</p>
          </div>
          <div class="sound-waves">
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
          </div>
        </div>

        <div class="ai-context-section" onclick="toggleAiContext(this)">
          <div class="ai-context-header">
            <h5>AI Context (from chart)</h5>
            <span class="ai-context-toggle">Show more</span>
          </div>
          <div class="ai-context-preview" id="doc-context-preview">Loading patient data...</div>
          <div class="ai-context-full" id="doc-context-full"></div>
        </div>

        <div class="doc-interaction-section">
          <div class="doc-interaction-label" style="display: flex; align-items: center; justify-content: space-between;">
            <span>HPI (History of Present Illness)</span>
            <span class="ai-confidence high">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
              High Confidence
              <span class="confidence-bar"><span class="bar filled"></span><span class="bar filled"></span><span class="bar filled"></span></span>
            </span>
          </div>
          <textarea class="doc-interaction-textarea" id="doc-hpi" placeholder="AI-generated HPI will appear here...">Patient is a 50-year-old male presenting for follow-up of chronic migraines. Reports headache frequency has decreased from daily to approximately 3-4 times per week since starting current preventive regimen. Headaches are described as bilateral, throbbing, moderate intensity (6/10), lasting 4-6 hours. Associated with photophobia and occasional nausea. Denies visual aura. Current abortive therapy (sumatriptan) provides relief within 2 hours.</textarea>
        </div>

        <div class="doc-interaction-section">
          <div class="doc-interaction-label" style="display: flex; align-items: center; justify-content: space-between;">
            <span>Assessment</span>
            <span class="ai-confidence high">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
              High Confidence
              <span class="confidence-bar"><span class="bar filled"></span><span class="bar filled"></span><span class="bar filled"></span></span>
            </span>
          </div>
          <textarea class="doc-interaction-textarea" id="doc-assessment" placeholder="AI-generated assessment will appear here...">1. Chronic migraine without aura (G43.709) - improving on current regimen
2. Medication overuse headache - resolved with current management
3. Mild depression (F32.0) - stable on current treatment</textarea>
        </div>

        <div class="doc-interaction-section">
          <div class="doc-interaction-label" style="display: flex; align-items: center; justify-content: space-between;">
            <span>Plan</span>
            <span class="ai-confidence medium">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
              Medium Confidence
              <span class="confidence-bar"><span class="bar filled"></span><span class="bar filled"></span><span class="bar"></span></span>
            </span>
          </div>
          <textarea class="doc-interaction-textarea" id="doc-plan" placeholder="AI-generated plan will appear here...">1. Continue topiramate 100mg BID - good tolerance and efficacy
2. Continue sumatriptan 100mg PRN for acute attacks (limit to 2x/week)
3. Maintain headache diary
4. Return in 3 months or sooner if worsening
5. Consider CGRP inhibitor if frequency does not continue to improve</textarea>
        </div>

        <!-- Drug Interaction Alert -->
        <div class="drug-interaction-alert" id="drug-alert-1">
          <div class="drug-interaction-icon">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg>
          </div>
          <div class="drug-interaction-content">
            <h5>
              Potential Interaction Detected
            </h5>
            <p><strong>Topiramate + Sumatriptan:</strong> Monitor for CNS depression. Both medications may increase sedation risk. Consider spacing doses or reducing if drowsiness reported.</p>
          </div>
          <button class="drug-interaction-dismiss" onclick="dismissDrugAlert('drug-alert-1')" title="Dismiss">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
          </button>
        </div>

        <div class="doc-interaction-actions">
          <button class="doc-interaction-btn secondary" onclick="regenerateDocumentation()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
            </svg>
            Regenerate
          </button>
          <button class="doc-interaction-btn primary" onclick="saveToFields()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><path d="M17 21v-8H7v8"/><path d="M7 3v5h8"/>
            </svg>
            Save to Note Fields
          </button>
        </div>
      </div>

      <!-- Ask AI / Search VERA Pane -->
      <div class="ai-drawer-pane" id="pane-ask-ai">
        <div class="ask-ai-tabs">
          <button class="ask-ai-tab active" onclick="switchAskAiTab('ask')">Ask AI</button>
          <button class="ask-ai-tab" onclick="switchAskAiTab('vera')">Search VERA Health</button>
        </div>

        <div class="ai-context-section" onclick="toggleAiContext(this)">
          <div class="ai-context-header">
            <h5>AI Context (from chart)</h5>
            <span class="ai-context-toggle">Show more</span>
          </div>
          <div class="ai-context-preview" id="ask-context-preview">Loading patient data...</div>
          <div class="ai-context-full" id="ask-context-full"></div>
        </div>

        <div class="ask-ai-input-container">
          <input type="text" class="ask-ai-input" id="ask-ai-input" placeholder="Ask a clinical question..." onkeypress="if(event.key==='Enter')submitAskAi()">
          <button class="ask-ai-send" onclick="submitAskAi()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
            </svg>
          </button>
        </div>

        <div class="ask-ai-response" id="ask-ai-response">
          <p style="color: var(--text-muted); font-style: italic;">Ask a question about this patient's case, treatment options, or clinical guidelines. The AI will provide context-aware responses based on the current chart data.</p>
          <p style="margin-top: 12px; color: var(--text-muted); font-size: 12px;">Example questions:</p>
          <ul style="color: var(--text-muted); font-size: 12px; margin-top: 4px;">
            <li>"What are the CGRP inhibitor options for this patient?"</li>
            <li>"Is this patient a candidate for Botox?"</li>
            <li>"What are the contraindications for triptans?"</li>
          </ul>
        </div>
      </div>

      <!-- Summarize for Patient Pane -->
      <div class="ai-drawer-pane" id="pane-summarize">
        <div class="reading-level-selector">
          <label>Reading Level:</label>
          <select id="reading-level" onchange="updatePatientSummary()">
            <option value="simple">Simple (5th grade)</option>
            <option value="standard" selected>Standard (8th grade)</option>
            <option value="detailed">Detailed (12th grade)</option>
          </select>
        </div>

        <div class="patient-summary-box">
          <div class="patient-summary-header">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
            </svg>
            <h4>Summary for Patient</h4>
          </div>
          <div class="patient-summary-content" id="patient-summary-content">
            <p><strong>What we found:</strong> Your headaches are getting better with your current treatment. Your MIDAS score went from 56 to 18, which means your headaches are affecting your daily life much less than before.</p>
            <p style="margin-top: 12px;"><strong>Your brain scans:</strong> The MRI and CT scans of your brain look normal. There are no concerning findings.</p>
            <p style="margin-top: 12px;"><strong>Your treatment plan:</strong> Continue taking your current medications as prescribed. Keep track of your headaches in your diary. If your headaches get worse or you have any concerns, call the office right away.</p>
            <p style="margin-top: 12px;"><strong>Next steps:</strong> We'll see you again in 3 months to check on your progress.</p>
          </div>
        </div>

        <div class="doc-interaction-actions">
          <button class="doc-interaction-btn secondary" onclick="copyPatientSummary()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
            </svg>
            Copy to Clipboard
          </button>
          <button class="doc-interaction-btn primary" onclick="printPatientSummary()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M6 9V2h12v7"/><path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/>
            </svg>
            Print
          </button>
        </div>
      </div>

      <!-- Create Patient Handout Pane -->
      <div class="ai-drawer-pane" id="pane-handout">
        <div class="handout-options">
          <h4 style="font-size: 13px; font-weight: 600; margin-bottom: 12px;">Include in Handout:</h4>
          <div class="handout-option">
            <input type="checkbox" id="handout-diagnosis" checked>
            <label for="handout-diagnosis">Diagnosis Summary</label>
          </div>
          <div class="handout-option">
            <input type="checkbox" id="handout-medications" checked>
            <label for="handout-medications">Medication Instructions</label>
          </div>
          <div class="handout-option">
            <input type="checkbox" id="handout-lifestyle" checked>
            <label for="handout-lifestyle">Lifestyle Recommendations</label>
          </div>
          <div class="handout-option">
            <input type="checkbox" id="handout-warning">
            <label for="handout-warning">Warning Signs to Watch For</label>
          </div>
          <div class="handout-option">
            <input type="checkbox" id="handout-followup" checked>
            <label for="handout-followup">Follow-up Instructions</label>
          </div>
        </div>

        <div class="handout-preview" id="handout-preview">
          <h5>Patient Handout Preview</h5>
          <p><strong>Your Diagnosis:</strong> Chronic Migraine</p>
          <p style="margin-top: 8px;"><strong>Your Medications:</strong></p>
          <ul style="margin: 4px 0 8px 16px;">
            <li>Topiramate 100mg - Take twice daily for prevention</li>
            <li>Sumatriptan 100mg - Take as needed for acute headache (max 2x/week)</li>
          </ul>
          <p><strong>Lifestyle Tips:</strong></p>
          <ul style="margin: 4px 0 8px 16px;">
            <li>Keep a regular sleep schedule</li>
            <li>Stay hydrated</li>
            <li>Avoid known triggers (bright lights, certain foods)</li>
            <li>Manage stress with relaxation techniques</li>
          </ul>
          <p><strong>Next Appointment:</strong> 3 months</p>
        </div>

        <div class="handout-export-btns">
          <button class="handout-export-btn" onclick="exportHandout('pdf')">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/><path d="M12 18v-6"/><path d="M9 15l3 3 3-3"/>
            </svg>
            PDF
          </button>
          <button class="handout-export-btn" onclick="exportHandout('print')">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M6 9V2h12v7"/><path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/>
            </svg>
            Print
          </button>
          <button class="handout-export-btn primary" onclick="exportHandout('email')">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/>
            </svg>
            Email
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Tab switching
    function switchTab(tabName) {
      // Don't switch tabs in vertical view
      const tabContent = document.getElementById('tab-content');
      if (tabContent.classList.contains('vertical-view')) return;

      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));

      document.querySelector(`.tab-btn[data-tab="${tabName}"]`).classList.add('active');
      document.getElementById(tabName + '-tab').classList.add('active');
    }

    // =====================================================
    // DRAG AND DROP TAB REORDERING
    // =====================================================

    let draggedTab = null;

    function initDraggableTabs() {
      const tabNav = document.getElementById('tab-nav');
      const tabs = tabNav.querySelectorAll('.tab-btn');

      tabs.forEach(tab => {
        tab.addEventListener('dragstart', handleDragStart);
        tab.addEventListener('dragend', handleDragEnd);
        tab.addEventListener('dragover', handleDragOver);
        tab.addEventListener('dragenter', handleDragEnter);
        tab.addEventListener('dragleave', handleDragLeave);
        tab.addEventListener('drop', handleDrop);
      });

      // Load saved tab order
      loadTabOrder();
    }

    function handleDragStart(e) {
      draggedTab = this;
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', this.dataset.tab);
    }

    function handleDragEnd(e) {
      this.classList.remove('dragging');
      document.querySelectorAll('.tab-btn').forEach(tab => {
        tab.classList.remove('drag-over');
      });
      draggedTab = null;
    }

    function handleDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
    }

    function handleDragEnter(e) {
      e.preventDefault();
      if (this !== draggedTab) {
        this.classList.add('drag-over');
      }
    }

    function handleDragLeave(e) {
      this.classList.remove('drag-over');
    }

    function handleDrop(e) {
      e.preventDefault();
      this.classList.remove('drag-over');

      if (draggedTab && this !== draggedTab) {
        const tabNav = document.getElementById('tab-nav');
        const allTabs = [...tabNav.querySelectorAll('.tab-btn')];
        const draggedIndex = allTabs.indexOf(draggedTab);
        const dropIndex = allTabs.indexOf(this);

        if (draggedIndex < dropIndex) {
          this.parentNode.insertBefore(draggedTab, this.nextSibling);
        } else {
          this.parentNode.insertBefore(draggedTab, this);
        }

        // Also reorder the tab panes
        reorderTabPanes();

        // Save the new order
        saveTabOrder();

        showToast('Tab order saved');
      }
    }

    function reorderTabPanes() {
      const tabNav = document.getElementById('tab-nav');
      const tabContent = document.getElementById('tab-content');
      const tabs = tabNav.querySelectorAll('.tab-btn');

      tabs.forEach((tab, index) => {
        const tabId = tab.dataset.tab;
        const pane = document.getElementById(tabId + '-tab');
        if (pane) {
          pane.dataset.order = index;
        }
      });

      // Sort panes by order
      const panes = [...tabContent.querySelectorAll('.tab-pane')];
      panes.sort((a, b) => parseInt(a.dataset.order) - parseInt(b.dataset.order));
      panes.forEach(pane => tabContent.appendChild(pane));
    }

    function saveTabOrder() {
      const tabNav = document.getElementById('tab-nav');
      const tabs = tabNav.querySelectorAll('.tab-btn');
      const order = [...tabs].map(tab => tab.dataset.tab);
      localStorage.setItem('sevaro-tab-order', JSON.stringify(order));
    }

    function loadTabOrder() {
      const saved = localStorage.getItem('sevaro-tab-order');
      if (saved) {
        try {
          const order = JSON.parse(saved);
          const tabNav = document.getElementById('tab-nav');
          const tabContent = document.getElementById('tab-content');

          order.forEach((tabId, index) => {
            const tab = document.querySelector(`.tab-btn[data-tab="${tabId}"]`);
            const pane = document.getElementById(tabId + '-tab');
            if (tab) {
              tabNav.appendChild(tab);
            }
            if (pane) {
              pane.dataset.order = index;
            }
          });

          // Sort panes
          const panes = [...tabContent.querySelectorAll('.tab-pane')];
          panes.sort((a, b) => parseInt(a.dataset.order) - parseInt(b.dataset.order));
          panes.forEach(pane => tabContent.appendChild(pane));
        } catch (e) {
          console.log('Could not load tab order');
        }
      }
    }

    // =====================================================
    // VERTICAL SCROLL VIEW TOGGLE
    // =====================================================

    let isVerticalView = false;

    function toggleVerticalView() {
      const tabContent = document.getElementById('tab-content');
      const tabNavWrapper = document.getElementById('tab-nav-wrapper');
      const toggleBtn = document.getElementById('view-toggle-btn');
      const toggleText = document.getElementById('view-toggle-text');

      isVerticalView = !isVerticalView;

      if (isVerticalView) {
        tabContent.classList.add('vertical-view');
        tabNavWrapper.classList.add('vertical-mode');
        toggleBtn.classList.add('active');
        toggleText.textContent = 'Tab View';

        // Make all panes visible
        document.querySelectorAll('.tab-pane').forEach(pane => {
          pane.classList.add('active');
        });

        showToast('Vertical scroll view enabled');
      } else {
        tabContent.classList.remove('vertical-view');
        tabNavWrapper.classList.remove('vertical-mode');
        toggleBtn.classList.remove('active');
        toggleText.textContent = 'Scroll View';

        // Restore tab behavior - show only active tab
        document.querySelectorAll('.tab-pane').forEach(pane => {
          pane.classList.remove('active');
        });

        // Activate the first tab
        const firstTab = document.querySelector('.tab-btn');
        if (firstTab) {
          const tabId = firstTab.dataset.tab;
          document.querySelector(`.tab-btn[data-tab="${tabId}"]`).classList.add('active');
          document.getElementById(tabId + '-tab').classList.add('active');
        }

        showToast('Tab view enabled');
      }

      // Save preference
      localStorage.setItem('sevaro-vertical-view', isVerticalView);
    }

    function loadViewPreference() {
      const saved = localStorage.getItem('sevaro-vertical-view');
      if (saved === 'true') {
        toggleVerticalView();
      }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      initDraggableTabs();
      loadViewPreference();
    });

    // Chip toggle
    function toggleChip(chip) {
      chip.classList.toggle('selected');
    }

    // Accordion toggle
    function toggleAccordion(accordion) {
      accordion.classList.toggle('open');
    }

    // Study card toggle
    function toggleStudyCard(card) {
      card.classList.toggle('open');
    }

    // Visit card toggle
    function toggleVisitCard(card) {
      document.querySelectorAll('.prior-visit-card').forEach(c => {
        if (c !== card) c.classList.remove('expanded');
      });
      card.classList.toggle('expanded');
    }

    // Diagnosis dropdown
    function showDiagnosisDropdown(input) {
      const dropdown = document.getElementById('diagnosis-dropdown');
      if (input.value.length > 0) {
        dropdown.classList.add('show');
      } else {
        dropdown.classList.remove('show');
      }
    }

    function selectDiagnosis(code, name, category) {
      const container = document.getElementById('selected-diagnoses');
      const pill = document.createElement('div');
      pill.className = 'diagnosis-pill';
      pill.innerHTML = `
        <span>${code} - ${name}</span>
        <button class="plan-btn" onclick="openPlanBuilder()" title="Open Plan Builder">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/>
          </svg>
        </button>
        <button class="remove-btn" onclick="this.parentElement.remove()"></button>
      `;
      container.appendChild(pill);

      document.querySelector('.diagnosis-input').value = '';
      document.getElementById('diagnosis-dropdown').classList.remove('show');
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.diagnosis-search')) {
        document.getElementById('diagnosis-dropdown').classList.remove('show');
      }
    });

    // Plan Builder
    function openPlanBuilder() {
      document.getElementById('plan-builder-modal').classList.add('show');
    }

    function closePlanBuilder() {
      document.getElementById('plan-builder-modal').classList.remove('show');
    }

    function applyPlan() {
      closePlanBuilder();
      showToast('Plan applied to recommendations', 'success');
    }

    // Close modal when clicking overlay
    document.getElementById('plan-builder-modal').addEventListener('click', function(e) {
      if (e.target === this) {
        closePlanBuilder();
      }
    });

    // Generate assessment
    function generateAssessment() {
      const btn = event.target.closest('button');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg> Generating...';
      btn.disabled = true;

      setTimeout(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
        document.getElementById('assessment-text').value = `50-year-old male with chronic daily headache, likely chronic migraine without aura based on clinical presentation. Patient reports improvement with current prophylactic therapy (topiramate 50mg BID). Headache frequency reduced from daily to 3-4 per week. No red flags present. MRI brain unremarkable. MIDAS score indicates moderate disability (18), HIT-6 indicates substantial impact (58). Plan to continue current regimen and reassess at next visit.`;
        showToast('Assessment generated', 'success');
      }, 1500);
    }

    // Fill normal exam
    function fillNormalExam() {
      document.querySelectorAll('#exam-tab .accordion').forEach(acc => {
        acc.classList.add('open');
        acc.querySelector('.status-dot')?.classList.add('filled');
      });
      document.querySelectorAll('#exam-tab input[type="checkbox"]').forEach(cb => {
        if (!cb.closest('.accordion-content')?.querySelector('h5')?.textContent.includes('Gait')) {
          cb.checked = true;
        }
      });
      showToast('Normal exam populated', 'success');
    }

    // Copy to clipboard
    function copyToClipboard() {
      const preText = document.querySelector('.output-preview pre').textContent;
      navigator.clipboard.writeText(preText).then(() => {
        showToast('Copied to clipboard!', 'success');
      });
    }

    // Toast notification
    function showToast(message, type) {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toast-message');
      toastMessage.textContent = message;
      toast.className = 'toast show';
      if (type === 'success') {
        toast.classList.add('toast-success');
      }
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // Timer
    function updateTimer() {
      const now = new Date();
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
      document.getElementById('timer').textContent = hours + ':' + minutes + ':' + seconds;
    }
    setInterval(updateTimer, 1000);

    // Add CSS animation for spinner
    const style = document.createElement('style');
    style.textContent = '@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }';
    document.head.appendChild(style);

    // ==========================================
    // AI Text Input Features
    // ==========================================

    // Toggle recording state
    function toggleRecording(btn) {
      btn.classList.toggle('recording');
      const wrapper = btn.closest('.ai-textarea-wrapper');
      const waveform = wrapper.querySelector('.recording-waveform');

      if (btn.classList.contains('recording')) {
        // Show waveform
        if (waveform) waveform.classList.add('active');
        showToast('Recording started... Speak now');
        // Simulate stopping after 3 seconds
        setTimeout(() => {
          if (btn.classList.contains('recording')) {
            btn.classList.remove('recording');
            if (waveform) waveform.classList.remove('active');
            // Find the textarea in the wrapper and add simulated dictation
            const textarea = wrapper.querySelector('textarea');
            if (textarea) {
              const currentText = textarea.value;
              const dictatedText = " The patient also reports occasional aura with visual disturbances approximately 30 minutes before headache onset.";
              textarea.value = currentText + dictatedText;
            }
            showToast('Dictation complete');
          }
        }, 3000);
      } else {
        // Hide waveform
        if (waveform) waveform.classList.remove('active');
        showToast('Recording stopped');
      }
    }

    // Toggle AI actions dropdown
    function toggleAiDropdown(btn) {
      // Close all other dropdowns first
      document.querySelectorAll('.ai-actions-dropdown').forEach(d => d.classList.remove('show'));
      document.querySelectorAll('.quick-phrases-dropdown').forEach(d => d.classList.remove('show'));
      const dropdown = btn.nextElementSibling;
      dropdown.classList.toggle('show');
      event.stopPropagation();
    }

    // Toggle quick phrases dropdown
    function toggleQuickPhrases(btn) {
      // Close all other dropdowns first
      document.querySelectorAll('.ai-actions-dropdown').forEach(d => d.classList.remove('show'));
      document.querySelectorAll('.quick-phrases-dropdown').forEach(d => d.classList.remove('show'));
      const dropdown = btn.nextElementSibling;
      dropdown.classList.toggle('show');
      event.stopPropagation();
    }

    // Insert quick phrase into textarea
    function insertQuickPhrase(element, phrase) {
      const wrapper = element.closest('.ai-textarea-wrapper');
      const textarea = wrapper.querySelector('textarea');
      if (textarea) {
        const currentText = textarea.value;
        const cursorPos = textarea.selectionStart;
        const needsSpace = currentText.length > 0 && !currentText.endsWith(' ') && !currentText.endsWith('\n');
        const textToInsert = (needsSpace ? ' ' : '') + phrase;
        textarea.value = currentText.slice(0, cursorPos) + textToInsert + currentText.slice(cursorPos);
        textarea.focus();
        textarea.selectionStart = textarea.selectionEnd = cursorPos + textToInsert.length;
      }
      // Close the dropdown
      document.querySelectorAll('.quick-phrases-dropdown').forEach(d => d.classList.remove('show'));
      showToast('Phrase inserted');
    }

    // Dismiss drug interaction alert
    function dismissDrugAlert(alertId) {
      const alert = document.getElementById(alertId);
      if (alert) {
        alert.style.opacity = '0';
        alert.style.transform = 'translateX(20px)';
        alert.style.transition = 'all 0.3s ease';
        setTimeout(() => {
          alert.style.display = 'none';
        }, 300);
        showToast('Alert dismissed');
      }
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.ai-textarea-icons')) {
        document.querySelectorAll('.ai-actions-dropdown').forEach(d => d.classList.remove('show'));
        document.querySelectorAll('.quick-phrases-dropdown').forEach(d => d.classList.remove('show'));
      }
    });

    // Current textarea being worked on
    let currentAiTextarea = null;

    // Trigger AI action
    function triggerAiAction(action, element) {
      // Find the textarea
      const wrapper = element.closest('.ai-textarea-wrapper');
      currentAiTextarea = wrapper.querySelector('textarea');
      const text = currentAiTextarea.value;

      // Close dropdown
      document.querySelectorAll('.ai-actions-dropdown').forEach(d => d.classList.remove('show'));

      // Open modal
      const modal = document.getElementById('ai-response-modal');
      const title = document.getElementById('ai-modal-title');
      const thinking = document.getElementById('ai-thinking');
      const responseText = document.getElementById('ai-response-text');
      const footer = document.getElementById('ai-response-footer');

      // Set title based on action
      if (action === 'question') {
        title.textContent = 'Ask AI About This Text';
      } else if (action === 'improve') {
        title.textContent = 'Improve Text';
      } else if (action === 'summarize') {
        title.textContent = 'Summarize Text';
      }

      // Show modal with thinking state
      modal.classList.add('show');
      thinking.style.display = 'flex';
      responseText.style.display = 'none';
      footer.style.display = 'none';

      // Simulate AI response after delay
      setTimeout(() => {
        thinking.style.display = 'none';
        responseText.style.display = 'block';
        footer.style.display = 'flex';

        if (action === 'question') {
          responseText.innerHTML = `
            <p style="margin-bottom: 12px;"><strong>Based on the clinical information provided:</strong></p>
            <ul style="margin-left: 20px; margin-bottom: 12px;">
              <li style="margin-bottom: 8px;">The patient appears to have <strong>chronic migraine without aura</strong> based on the frequency (3-4 headaches/week) and response to topiramate.</li>
              <li style="margin-bottom: 8px;">Current MIDAS score of 18 indicates <strong>moderate disability</strong>, which is an improvement from the initial severe disability.</li>
              <li style="margin-bottom: 8px;">No red flag symptoms mentioned. Consider asking about: sudden onset, positional component, associated fever, or neurological deficits.</li>
            </ul>
            <p style="color: var(--text-muted); font-size: 12px; font-style: italic;">Would you like me to elaborate on any of these points?</p>
          `;
        } else if (action === 'improve') {
          responseText.innerHTML = `
            <p style="margin-bottom: 12px;"><strong>Suggested improvements:</strong></p>
            <div style="background: var(--bg-gray); padding: 12px; border-radius: 8px; font-size: 13px; line-height: 1.6;">
              50-year-old male presents for routine follow-up of chronic migraine without aura. <span style="background: #D1FAE5; padding: 2px 4px; border-radius: 2px;">He reports significant improvement in headache frequency, decreasing from daily episodes to 3-4 per week</span> since initiating topiramate prophylaxis. Current dosage is 50mg twice daily, which he tolerates well without significant side effects. <span style="background: #D1FAE5; padding: 2px 4px; border-radius: 2px;">Notably, he denies typical migraine accompaniments including visual aura, nausea, vomiting, photophobia, and phonophobia</span> with recent episodes.
            </div>
            <p style="color: var(--text-muted); font-size: 12px; margin-top: 12px; font-style: italic;">Changes highlighted in green. Click Apply to replace the original text.</p>
          `;
        } else if (action === 'summarize') {
          responseText.innerHTML = `
            <p style="margin-bottom: 12px;"><strong>Summary:</strong></p>
            <div style="background: var(--bg-gray); padding: 12px; border-radius: 8px; font-size: 13px; line-height: 1.6;">
              <strong>Key Points:</strong>
              <ul style="margin: 8px 0 0 20px;">
                <li>50 y/o M with chronic daily headache</li>
                <li>Improved on topiramate 50mg BID (daily  3-4/week)</li>
                <li>No aura, nausea, or photophobia</li>
              </ul>
            </div>
          `;
        }
      }, 1500);
    }

    // Close AI modal
    function closeAiModal() {
      document.getElementById('ai-response-modal').classList.remove('show');
      currentAiTextarea = null;
    }

    // Apply AI response to textarea
    function applyAiResponse() {
      if (currentAiTextarea) {
        // For demo, just show a toast - in real app would update the textarea
        showToast('AI suggestion applied', 'success');
      }
      closeAiModal();
    }

    // Close modal when clicking overlay
    document.getElementById('ai-response-modal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeAiModal();
      }
    });

    // ==========================================
    // Score History Features
    // ==========================================

    // Toggle score history section
    function toggleScoreHistory(header) {
      header.classList.toggle('collapsed');
      const content = header.nextElementSibling;
      content.classList.toggle('hidden');
    }

    // MIDAS sample data for different dates
    const midasData = {
      'Jan 16, 2026': {
        score: 18,
        interpretation: 'Moderate Disability',
        questions: [
          { q: 'Days missed work/school due to headache', a: '2 days' },
          { q: 'Days productivity reduced by half at work/school', a: '4 days' },
          { q: 'Days missed household work due to headache', a: '3 days' },
          { q: 'Days productivity reduced by half for household work', a: '5 days' },
          { q: 'Days missed family/social activities', a: '4 days' }
        ]
      },
      'Jan 10, 2026': {
        score: 24,
        interpretation: 'Moderate Disability',
        questions: [
          { q: 'Days missed work/school due to headache', a: '3 days' },
          { q: 'Days productivity reduced by half at work/school', a: '5 days' },
          { q: 'Days missed household work due to headache', a: '4 days' },
          { q: 'Days productivity reduced by half for household work', a: '6 days' },
          { q: 'Days missed family/social activities', a: '6 days' }
        ]
      },
      'Dec 15, 2025': {
        score: 42,
        interpretation: 'Severe Disability',
        questions: [
          { q: 'Days missed work/school due to headache', a: '6 days' },
          { q: 'Days productivity reduced by half at work/school', a: '10 days' },
          { q: 'Days missed household work due to headache', a: '8 days' },
          { q: 'Days productivity reduced by half for household work', a: '10 days' },
          { q: 'Days missed family/social activities', a: '8 days' }
        ]
      },
      'Nov 1, 2025': {
        score: 56,
        interpretation: 'Severe Disability',
        questions: [
          { q: 'Days missed work/school due to headache', a: '8 days' },
          { q: 'Days productivity reduced by half at work/school', a: '12 days' },
          { q: 'Days missed household work due to headache', a: '10 days' },
          { q: 'Days productivity reduced by half for household work', a: '14 days' },
          { q: 'Days missed family/social activities', a: '12 days' }
        ]
      }
    };

    // Show score detail modal
    function showScoreDetail(scale, date, score, interpretation) {
      if (scale !== 'midas') return; // Only MIDAS is clickable

      const modal = document.getElementById('score-detail-modal');
      const data = midasData[date];

      if (!data) return;

      document.getElementById('score-detail-title').textContent = 'MIDAS Score Details';
      document.getElementById('score-detail-value').textContent = data.score;
      document.getElementById('score-detail-interp').textContent = data.interpretation;
      document.getElementById('score-detail-date').textContent = date;

      // Build questions list
      const questionsList = document.getElementById('score-questions-list');
      questionsList.innerHTML = data.questions.map(item => `
        <div class="score-question-item">
          <span class="score-question-text">${item.q}</span>
          <span class="score-question-value">${item.a}</span>
        </div>
      `).join('');

      modal.classList.add('show');
    }

    // Close score detail modal
    function closeScoreDetailModal() {
      document.getElementById('score-detail-modal').classList.remove('show');
    }

    // Close modal when clicking overlay
    document.getElementById('score-detail-modal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeScoreDetailModal();
      }
    });

    // =====================================================
    // GLOBAL AI LAUNCHER & DRAWER FUNCTIONS
    // =====================================================

    // Toggle AI Launcher Menu
    function toggleAiLauncherMenu() {
      const menu = document.getElementById('ai-launcher-menu');
      menu.classList.toggle('show');
    }

    // Close AI Launcher Menu when clicking outside
    document.addEventListener('click', function(e) {
      const container = document.querySelector('.ai-launcher-container');
      const menu = document.getElementById('ai-launcher-menu');
      if (container && !container.contains(e.target)) {
        menu.classList.remove('show');
      }
    });

    // Open AI Drawer with specific tab
    function openAiDrawer(tabId) {
      const menu = document.getElementById('ai-launcher-menu');
      const overlay = document.getElementById('ai-drawer-overlay');
      const drawer = document.getElementById('ai-drawer');

      menu.classList.remove('show');
      overlay.classList.add('show');
      drawer.classList.add('show');

      switchAiDrawerTab(tabId);
      updateAiContext();
    }

    // Close AI Drawer
    function closeAiDrawer() {
      const overlay = document.getElementById('ai-drawer-overlay');
      const drawer = document.getElementById('ai-drawer');

      overlay.classList.remove('show');
      drawer.classList.remove('show');
    }

    // Close drawer on ESC key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeAiDrawer();
        document.getElementById('ai-launcher-menu').classList.remove('show');
      }
    });

    // Switch AI Drawer Tab
    function switchAiDrawerTab(tabId) {
      // Update tab buttons
      document.querySelectorAll('.ai-drawer-tab').forEach(tab => tab.classList.remove('active'));
      const tabs = document.querySelectorAll('.ai-drawer-tab');
      const tabNames = ['chart-prep', 'document', 'ask-ai', 'summarize', 'handout'];
      const tabIndex = tabNames.indexOf(tabId);
      if (tabIndex >= 0 && tabs[tabIndex]) {
        tabs[tabIndex].classList.add('active');
      }

      // Update panes
      document.querySelectorAll('.ai-drawer-pane').forEach(pane => pane.classList.remove('active'));
      const pane = document.getElementById('pane-' + tabId);
      if (pane) {
        pane.classList.add('active');
      }

      // Update drawer title
      const titles = {
        'chart-prep': 'Chart Prep',
        'document': 'Document Interaction',
        'ask-ai': 'Ask AI / Search VERA',
        'summarize': 'Summarize for Patient',
        'handout': 'Create Patient Handout'
      };
      document.getElementById('ai-drawer-title').textContent = titles[tabId] || 'AI Tools';
    }

    // Toggle AI Context expansion
    function toggleAiContext(section) {
      section.classList.toggle('expanded');
      const toggle = section.querySelector('.ai-context-toggle');
      toggle.textContent = section.classList.contains('expanded') ? 'Show less' : 'Show more';
    }

    // Get AI Context from page fields
    function getAiContext() {
      const context = {
        patient: {
          name: 'Test Test',
          age: 50,
          sex: 'Male',
          mrn: '123123'
        },
        chiefComplaint: 'Chronic migraines - follow-up',
        visitType: document.querySelector('.chip.selected')?.textContent || 'Follow-up',
        hpi: '',
        assessment: '',
        recommendations: '',
        generalNotes: '',
        imaging: {
          mriBrain: '',
          ctHead: '',
          ctaHeadNeck: '',
          eeg: '',
          emgNcs: ''
        },
        scales: {
          midas: { current: 18, history: [56, 42, 24, 18] },
          hit6: { current: 58, history: [68, 62, 58] },
          phq9: { current: 6, history: [12, 8, 6] }
        }
      };

      // Read from HPI textarea
      const hpiTextarea = document.querySelector('#hpi-tab .form-textarea, #hpi-tab textarea');
      if (hpiTextarea) context.hpi = hpiTextarea.value;

      // Read from Assessment textarea
      const assessmentTextarea = document.querySelector('#recommendation-tab .form-section:nth-child(2) textarea');
      if (assessmentTextarea) context.assessment = assessmentTextarea.value;

      // Read from Recommendations textarea
      const recsTextarea = document.querySelector('#recommendation-tab .form-section:nth-child(3) textarea');
      if (recsTextarea) context.recommendations = recsTextarea.value;

      // Read imaging results
      const imagingTextareas = document.querySelectorAll('#imaging-tab textarea');
      const imagingFields = ['mriBrain', 'ctHead', 'ctaHeadNeck', 'eeg', 'emgNcs'];
      imagingTextareas.forEach((ta, i) => {
        if (imagingFields[i]) context.imaging[imagingFields[i]] = ta.value;
      });

      return context;
    }

    // Format context for display
    function formatContextPreview(context) {
      return `Patient: ${context.patient.name}, ${context.patient.age}y/o ${context.patient.sex} | Chief Complaint: ${context.chiefComplaint} | MIDAS: ${context.scales.midas.current}`;
    }

    function formatContextFull(context) {
      let text = `PATIENT INFORMATION\n`;
      text += `Name: ${context.patient.name}\n`;
      text += `Age: ${context.patient.age} | Sex: ${context.patient.sex} | MRN: ${context.patient.mrn}\n\n`;
      text += `CHIEF COMPLAINT\n${context.chiefComplaint}\n\n`;
      text += `VISIT TYPE\n${context.visitType}\n\n`;

      if (context.hpi) {
        text += `HPI\n${context.hpi}\n\n`;
      }

      text += `SCALE SCORES\n`;
      text += `MIDAS: ${context.scales.midas.current} (history: ${context.scales.midas.history.join('  ')})\n`;
      text += `HIT-6: ${context.scales.hit6.current} (history: ${context.scales.hit6.history.join('  ')})\n`;
      text += `PHQ-9: ${context.scales.phq9.current} (history: ${context.scales.phq9.history.join('  ')})\n\n`;

      if (context.imaging.mriBrain) {
        text += `IMAGING - MRI Brain\n${context.imaging.mriBrain}\n\n`;
      }
      if (context.imaging.ctHead) {
        text += `IMAGING - CT Head\n${context.imaging.ctHead}\n\n`;
      }

      return text;
    }

    // Update AI Context displays
    function updateAiContext() {
      const context = getAiContext();
      const preview = formatContextPreview(context);
      const full = formatContextFull(context);

      // Update all context sections
      const previewIds = ['chart-prep-context-preview', 'doc-context-preview', 'ask-context-preview'];
      const fullIds = ['chart-prep-context-full', 'doc-context-full', 'ask-context-full'];

      previewIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = preview;
      });

      fullIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = full;
      });
    }

    // =====================================================
    // DOCUMENT INTERACTION FUNCTIONS
    // =====================================================

    function regenerateDocumentation() {
      const hpi = document.getElementById('doc-hpi');
      const assessment = document.getElementById('doc-assessment');
      const plan = document.getElementById('doc-plan');

      // Simulate regeneration with slight variation
      hpi.value = "Patient is a 50-year-old male with chronic migraines presenting for routine follow-up. He reports significant improvement in headache frequency, now experiencing 3-4 headaches per week compared to daily headaches at baseline. Headaches remain bilateral with throbbing quality, rated 6/10 in intensity, duration 4-6 hours. Associated symptoms include photophobia and mild nausea. No aura reported. Sumatriptan continues to provide effective acute relief.";

      assessment.value = "1. Chronic migraine without aura (G43.709) - responding well to current therapy\n2. History of medication overuse headache - resolved\n3. Comorbid mild depression (F32.0) - stable";

      plan.value = "1. Continue topiramate 100mg twice daily for migraine prevention\n2. Sumatriptan 100mg as needed for breakthrough headaches, limit to twice weekly\n3. Continue headache diary to track patterns\n4. Follow up in 3 months\n5. If headaches remain frequent, consider adding CGRP inhibitor therapy";

      showToast('Documentation regenerated');
    }

    function saveToFields() {
      const hpi = document.getElementById('doc-hpi').value;
      const assessment = document.getElementById('doc-assessment').value;
      const plan = document.getElementById('doc-plan').value;

      // Find and update the main form textareas
      const hpiTextarea = document.querySelector('#hpi-tab .ai-textarea-wrapper textarea');
      if (hpiTextarea) hpiTextarea.value = hpi;

      const assessmentTextarea = document.querySelector('#recommendation-tab .form-section:nth-child(2) .ai-textarea-wrapper textarea');
      if (assessmentTextarea) assessmentTextarea.value = assessment;

      const recsTextarea = document.querySelector('#recommendation-tab .form-section:nth-child(3) .ai-textarea-wrapper textarea');
      if (recsTextarea) recsTextarea.value = plan;

      showToast('Saved to note fields');
      closeAiDrawer();
    }

    // =====================================================
    // ASK AI FUNCTIONS
    // =====================================================

    function switchAskAiTab(mode) {
      document.querySelectorAll('.ask-ai-tab').forEach(tab => tab.classList.remove('active'));
      event.target.classList.add('active');

      const input = document.getElementById('ask-ai-input');
      if (mode === 'ask') {
        input.placeholder = 'Ask a clinical question...';
      } else {
        input.placeholder = 'Search VERA Health guidelines...';
      }
    }

    function submitAskAi() {
      const input = document.getElementById('ask-ai-input');
      const response = document.getElementById('ask-ai-response');
      const question = input.value.trim();

      if (!question) return;

      // Show loading
      response.innerHTML = '<div class="ai-loading"><div class="ai-loading-spinner"></div></div>';

      // Simulate AI response
      setTimeout(() => {
        let answer = '';

        if (question.toLowerCase().includes('cgrp')) {
          answer = `<p><strong>CGRP Inhibitors for Migraine Prevention</strong></p>
          <p style="margin-top: 8px;">Based on this patient's profile (chronic migraine with partial response to topiramate), CGRP inhibitors could be considered. Options include:</p>
          <ul style="margin: 8px 0 8px 16px;">
            <li><strong>Erenumab (Aimovig)</strong> - 70mg or 140mg monthly SC injection</li>
            <li><strong>Fremanezumab (Ajovy)</strong> - 225mg monthly or 675mg quarterly SC</li>
            <li><strong>Galcanezumab (Emgality)</strong> - 240mg loading, then 120mg monthly SC</li>
            <li><strong>Eptinezumab (Vyepti)</strong> - 100mg or 300mg IV quarterly</li>
          </ul>
          <p style="margin-top: 8px;">Given the patient's MIDAS improvement (5618), you might consider continuing current therapy before adding CGRP inhibitor, or adding it for further optimization.</p>`;
        } else if (question.toLowerCase().includes('botox')) {
          answer = `<p><strong>Botox Candidacy Assessment</strong></p>
          <p style="margin-top: 8px;">This patient meets criteria for OnabotulinumtoxinA (Botox) based on:</p>
          <ul style="margin: 8px 0 8px 16px;">
            <li>Diagnosis of chronic migraine (15 headache days/month)</li>
            <li>Age 18 years</li>
            <li>Trial of preventive medication (topiramate)</li>
          </ul>
          <p style="margin-top: 8px;">However, given the significant improvement on current therapy (MIDAS decreased 68%), you may want to continue monitoring before adding Botox. Typical dosing is 155-195 units across 31-39 injection sites every 12 weeks.</p>`;
        } else {
          answer = `<p>Based on the current patient context and your question about "${question}", here is a clinical summary:</p>
          <p style="margin-top: 8px;">The patient is responding well to current therapy with significant improvement in disability scores. Consider maintaining the current regimen while monitoring for continued improvement. If symptoms plateau, additional therapies such as CGRP inhibitors or Botox could be considered.</p>
          <p style="margin-top: 12px; font-size: 12px; color: var(--text-muted);">Note: This is a simulated AI response for demonstration purposes.</p>`;
        }

        response.innerHTML = answer;
      }, 1500);

      input.value = '';
    }

    // =====================================================
    // PATIENT SUMMARY FUNCTIONS
    // =====================================================

    function updatePatientSummary() {
      const level = document.getElementById('reading-level').value;
      const content = document.getElementById('patient-summary-content');

      if (level === 'simple') {
        content.innerHTML = `
          <p><strong>Your headaches:</strong> Your headaches are much better! The medicine is working well.</p>
          <p style="margin-top: 12px;"><strong>Your tests:</strong> Your brain pictures look good. Nothing to worry about.</p>
          <p style="margin-top: 12px;"><strong>What to do:</strong> Keep taking your pills every day. Write down when you get headaches. Call us if they get worse.</p>
          <p style="margin-top: 12px;"><strong>Next visit:</strong> Come back in 3 months.</p>
        `;
      } else if (level === 'detailed') {
        content.innerHTML = `
          <p><strong>Clinical Assessment:</strong> Your chronic migraine condition has shown significant improvement with the current preventive regimen. Your MIDAS (Migraine Disability Assessment) score has decreased from 56 to 18, representing a 68% reduction in migraine-related disability. This indicates a transition from severe to moderate disability category.</p>
          <p style="margin-top: 12px;"><strong>Diagnostic Imaging:</strong> Your MRI and CT imaging studies demonstrate no acute intracranial abnormalities, mass lesions, or vascular malformations. These findings are reassuring and rule out secondary causes of headache.</p>
          <p style="margin-top: 12px;"><strong>Treatment Plan:</strong> Continue topiramate 100mg twice daily for migraine prophylaxis. Use sumatriptan 100mg for acute attacks, limiting use to twice weekly to prevent medication overuse headache. Maintain your headache diary for pattern analysis.</p>
          <p style="margin-top: 12px;"><strong>Follow-up:</strong> Return in 3 months for reassessment. If improvement plateaus, we may consider adding CGRP inhibitor therapy.</p>
        `;
      } else {
        content.innerHTML = `
          <p><strong>What we found:</strong> Your headaches are getting better with your current treatment. Your MIDAS score went from 56 to 18, which means your headaches are affecting your daily life much less than before.</p>
          <p style="margin-top: 12px;"><strong>Your brain scans:</strong> The MRI and CT scans of your brain look normal. There are no concerning findings.</p>
          <p style="margin-top: 12px;"><strong>Your treatment plan:</strong> Continue taking your current medications as prescribed. Keep track of your headaches in your diary. If your headaches get worse or you have any concerns, call the office right away.</p>
          <p style="margin-top: 12px;"><strong>Next steps:</strong> We'll see you again in 3 months to check on your progress.</p>
        `;
      }
    }

    function copyPatientSummary() {
      const content = document.getElementById('patient-summary-content').innerText;
      navigator.clipboard.writeText(content).then(() => {
        showToast('Summary copied to clipboard');
      });
    }

    function printPatientSummary() {
      const content = document.getElementById('patient-summary-content').innerHTML;
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <html>
          <head>
            <title>Patient Summary</title>
            <style>
              body { font-family: Arial, sans-serif; padding: 40px; max-width: 600px; margin: 0 auto; }
              h1 { color: #0D9488; font-size: 24px; margin-bottom: 24px; }
              p { line-height: 1.6; margin-bottom: 12px; }
            </style>
          </head>
          <body>
            <h1>Your Visit Summary</h1>
            ${content}
          </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.print();
    }

    // =====================================================
    // HANDOUT FUNCTIONS
    // =====================================================

    function exportHandout(format) {
      if (format === 'print') {
        const content = document.getElementById('handout-preview').innerHTML;
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
          <html>
            <head>
              <title>Patient Handout</title>
              <style>
                body { font-family: Arial, sans-serif; padding: 40px; max-width: 600px; margin: 0 auto; }
                h5 { color: #0D9488; font-size: 20px; margin-bottom: 20px; }
                p { line-height: 1.6; margin-bottom: 8px; }
                ul { margin: 8px 0 16px 20px; }
                li { margin-bottom: 4px; }
              </style>
            </head>
            <body>${content}</body>
          </html>
        `);
        printWindow.document.close();
        printWindow.print();
      } else if (format === 'pdf') {
        showToast('PDF export would generate downloadable file');
      } else if (format === 'email') {
        showToast('Email dialog would open here');
      }
    }

    // =====================================================
    // GUIDED TOUR FUNCTIONS
    // =====================================================

    // Tour steps configuration
    const tourSteps = [
      {
        title: 'Welcome to Sevaro',
        content: 'Welcome to the Sevaro Outpatient Clinical Note demo. This tour will guide you through the key AI-powered features designed to streamline clinical documentation.',
        element: null, // No highlight for welcome
        position: 'center'
      },
      {
        title: 'AI Tools Launcher',
        content: 'Click the star icon to access the Global AI Tools menu. This gives you quick access to Chart Prep, Document Interaction, Ask AI, Patient Summary, and Handout generation.',
        element: '.ai-launcher-btn',
        position: 'bottom-left'
      },
      {
        title: 'Dark Mode Toggle',
        content: 'Switch between light and dark mode for comfortable viewing in any environment. Click the moon icon to toggle.',
        element: '#dark-mode-toggle',
        position: 'bottom-left'
      },
      {
        title: 'Patient Summary Card',
        content: 'View the patient\'s key information at a glance, including their MIDAS score history showing treatment progress. The AI-generated summary highlights important clinical details.',
        element: '.patient-summary-box',
        position: 'right'
      },
      {
        title: 'Voice Dictation',
        content: 'Click the microphone icon in any text field to start voice dictation. Watch for the animated waveform indicating active recording.',
        element: '.mic-btn',
        position: 'top'
      },
      {
        title: 'Quick Phrases',
        content: 'Click the lightning bolt icon to insert common clinical phrases quickly. These are contextual - different phrases appear for different sections.',
        element: '.quick-phrases-btn',
        position: 'top'
      },
      {
        title: 'AI Text Actions',
        content: 'Use the sparkle menu on any text field to ask AI questions, improve text clarity, or generate summaries of your clinical notes.',
        element: '.ai-actions-btn',
        position: 'top'
      },
      {
        title: 'Customizable Tabs',
        content: 'Drag and drop tabs to reorder them to your preference. Your custom order is saved automatically for your next visit.',
        element: '.tab-nav',
        position: 'bottom'
      },
      {
        title: 'Vertical Scroll View',
        content: 'Click "Scroll View" to see all note sections in a continuous vertical layout instead of tabs. Great for reviewing the complete note.',
        element: '#view-toggle-btn',
        position: 'bottom'
      },
      {
        title: 'You\'re Ready!',
        content: 'That\'s the tour! Explore the demo to discover more features like drug interaction alerts, AI confidence indicators, and the full AI drawer experience.',
        element: null,
        position: 'center'
      }
    ];

    let currentTourStep = 0;
    let previousHighlight = null;

    function startTour() {
      currentTourStep = 0;
      showTourStep(0);
    }

    function showTourStep(stepIndex) {
      const overlay = document.getElementById('tour-overlay');
      const tooltip = document.getElementById('tour-tooltip');
      const title = document.getElementById('tour-title');
      const step = document.getElementById('tour-step');
      const content = document.getElementById('tour-content');
      const dots = document.getElementById('tour-dots');
      const prevBtn = document.getElementById('tour-prev-btn');
      const nextBtn = document.getElementById('tour-next-btn');

      // Remove previous highlight
      if (previousHighlight) {
        previousHighlight.classList.remove('tour-highlight');
        previousHighlight = null;
      }

      const tourStep = tourSteps[stepIndex];

      // Update content
      title.textContent = tourStep.title;
      step.textContent = `Step ${stepIndex + 1} of ${tourSteps.length}`;
      content.textContent = tourStep.content;

      // Update dots
      dots.innerHTML = tourSteps.map((_, i) => {
        let className = 'tour-dot';
        if (i < stepIndex) className += ' completed';
        if (i === stepIndex) className += ' active';
        return `<div class="${className}"></div>`;
      }).join('');

      // Update buttons
      prevBtn.style.display = stepIndex > 0 ? 'block' : 'none';
      nextBtn.textContent = stepIndex === tourSteps.length - 1 ? 'Finish' : 'Next';

      // Show overlay
      overlay.classList.add('active');
      tooltip.classList.add('active');

      // Highlight element if specified
      if (tourStep.element) {
        const el = document.querySelector(tourStep.element);
        if (el) {
          el.classList.add('tour-highlight');
          previousHighlight = el;

          // Position tooltip relative to element
          const rect = el.getBoundingClientRect();
          positionTooltip(tooltip, rect, tourStep.position);
        }
      } else {
        // Center tooltip for welcome/end steps
        tooltip.style.top = '50%';
        tooltip.style.left = '50%';
        tooltip.style.transform = 'translate(-50%, -50%)';
      }
    }

    function positionTooltip(tooltip, rect, position) {
      const tooltipRect = tooltip.getBoundingClientRect();
      const padding = 16;

      tooltip.style.transform = 'none';

      switch (position) {
        case 'right':
          tooltip.style.top = rect.top + 'px';
          tooltip.style.left = (rect.right + padding) + 'px';
          break;
        case 'left':
          tooltip.style.top = rect.top + 'px';
          tooltip.style.left = (rect.left - tooltipRect.width - padding) + 'px';
          break;
        case 'top':
          tooltip.style.top = (rect.top - tooltipRect.height - padding) + 'px';
          tooltip.style.left = rect.left + 'px';
          break;
        case 'bottom':
          tooltip.style.top = (rect.bottom + padding) + 'px';
          tooltip.style.left = rect.left + 'px';
          break;
        case 'bottom-left':
          tooltip.style.top = (rect.bottom + padding) + 'px';
          tooltip.style.left = Math.max(padding, rect.left - 200) + 'px';
          break;
        default:
          tooltip.style.top = (rect.bottom + padding) + 'px';
          tooltip.style.left = rect.left + 'px';
      }

      // Ensure tooltip stays within viewport
      const newRect = tooltip.getBoundingClientRect();
      if (newRect.right > window.innerWidth - padding) {
        tooltip.style.left = (window.innerWidth - tooltipRect.width - padding) + 'px';
      }
      if (newRect.bottom > window.innerHeight - padding) {
        tooltip.style.top = (rect.top - tooltipRect.height - padding) + 'px';
      }
    }

    function nextTourStep() {
      if (currentTourStep < tourSteps.length - 1) {
        currentTourStep++;
        showTourStep(currentTourStep);
      } else {
        endTour();
      }
    }

    function prevTourStep() {
      if (currentTourStep > 0) {
        currentTourStep--;
        showTourStep(currentTourStep);
      }
    }

    function endTour() {
      const overlay = document.getElementById('tour-overlay');
      const tooltip = document.getElementById('tour-tooltip');

      overlay.classList.remove('active');
      tooltip.classList.remove('active');

      if (previousHighlight) {
        previousHighlight.classList.remove('tour-highlight');
        previousHighlight = null;
      }

      showToast('Tour completed! Explore the demo on your own.');
    }

    // Close tour on ESC key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const tooltip = document.getElementById('tour-tooltip');
        if (tooltip && tooltip.classList.contains('active')) {
          endTour();
        }
      }
    });

    // =====================================================
    // UTILITY FUNCTIONS
    // =====================================================

    // Dark Mode Toggle
    function toggleDarkMode() {
      const html = document.documentElement;
      const icon = document.getElementById('dark-mode-icon');
      const isDark = html.getAttribute('data-theme') === 'dark';

      if (isDark) {
        html.removeAttribute('data-theme');
        // Moon icon for light mode
        icon.innerHTML = '<path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>';
        showToast('Light mode enabled');
      } else {
        html.setAttribute('data-theme', 'dark');
        // Sun icon for dark mode
        icon.innerHTML = '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>';
        showToast('Dark mode enabled');
      }
    }

    function showToast(message) {
      // Create toast element
      let toast = document.getElementById('ai-toast');
      if (!toast) {
        toast = document.createElement('div');
        toast.id = 'ai-toast';
        toast.style.cssText = `
          position: fixed;
          bottom: 24px;
          left: 50%;
          transform: translateX(-50%);
          background: #1F2937;
          color: white;
          padding: 12px 24px;
          border-radius: 8px;
          font-size: 14px;
          z-index: 9999;
          opacity: 0;
          transition: opacity 0.3s;
        `;
        document.body.appendChild(toast);
      }

      toast.textContent = message;
      toast.style.opacity = '1';

      setTimeout(() => {
        toast.style.opacity = '0';
      }, 2500);
    }

    // Initialize context on page load
    document.addEventListener('DOMContentLoaded', function() {
      // Pre-populate context when drawer opens

      // Start the local time clock
      updateLocalTime();
      setInterval(updateLocalTime, 1000);
    });

    // Update local time display (PST/PDT)
    function updateLocalTime() {
      const now = new Date();

      // Format time for PST (America/Los_Angeles)
      const options = {
        hour: '2-digit',
        minute: '2-digit',
        hour12: true,
        timeZone: 'America/Los_Angeles'
      };

      const timeStr = now.toLocaleTimeString('en-US', options);

      // Determine if it's PST or PDT
      const janDate = new Date(now.getFullYear(), 0, 1);
      const julDate = new Date(now.getFullYear(), 6, 1);
      const janOffset = janDate.getTimezoneOffset();
      const julOffset = julDate.getTimezoneOffset();
      const stdOffset = Math.max(janOffset, julOffset);

      // Check if currently in DST for Pacific time
      const pacificFormatter = new Intl.DateTimeFormat('en-US', {
        timeZone: 'America/Los_Angeles',
        timeZoneName: 'short'
      });
      const tzName = pacificFormatter.format(now).split(' ').pop(); // Gets PST or PDT

      // Update the Marshall clock
      const marshallClock = document.getElementById('local-time-marshall');
      if (marshallClock) {
        marshallClock.textContent = timeStr + ' ' + tzName;
      }
    }
  </script>
</body>
</html>
