# Steel Man Test Report

**Project:** Sevaro Clinical - OPSAmplehtml
**Date:** 2026-02-17 (Updated)
**Tester:** Claude Code (Steel Man Testing Skill)
**Product Type:** Full Stack Web App (Next.js + Supabase)
**Live URL:** https://ops-amplehtml.vercel.app
**Repo:** https://github.com/blondarb/OPSAmplehtml
**Branch/Commit:** main @ 7e7073e

---

## Executive Summary

All four new features have been verified working on the production alias URL. Two bugs were found and fixed during testing:

1. **AI intake chat silently broke after 3-4 exchanges** (token limit truncation) â€” Fixed in commit `8beb7f4`
2. **AI intake chat looped infinitely at final field** (model failed to set `isComplete`) â€” Fixed in commit `7e7073e`

After fixes, the complete AI conversational intake flow works end-to-end: 9 questions answered conversationally, automatic completion, switch to pre-filled form.

**Overall Readiness:** ðŸŸ¢ **Ready for Demo Testing**

**Findings Summary:**

| Severity | Count |
|----------|-------|
| S0 â€” Ship Blocker | 0 (2 found & fixed) |
| S1 â€” Must Fix Before Launch | 1 |
| S2 â€” Should Fix Soon | 3 |
| S3 â€” Nice to Have | 2 |
| S4 â€” Observation | 2 |

---

## FIXED ISSUES (Previously S0)

### FIXED: AI Intake Chat Silent Failure After 3-4 Exchanges
**Area:** AI-Assisted Intake
**Original Severity:** S0
**Status:** âœ… Fixed in commit `8beb7f4`

**Root Cause:**
`max_completion_tokens: 500` was too restrictive. As conversation context grew (system prompt + collected data + message history), the model's response was truncated, producing malformed JSON without the `nextQuestion` field. The API returned HTTP 200 with an incomplete response. The frontend rendered an invisible empty message bubble, appearing "stuck."

**Fix Applied:**
- Increased `max_completion_tokens` from 500 to 1000
- Added server-side JSON parse error handling with fallback message
- Added server-side null check ensuring `nextQuestion` always exists
- Added client-side error field check and fallback text

---

### FIXED: AI Intake Conversation Infinite Loop at Final Field
**Area:** AI-Assisted Intake
**Original Severity:** S0
**Status:** âœ… Fixed in commit `7e7073e`

**Root Cause:**
Even with 1000 tokens, after collecting all 9 fields the model sometimes failed to set `isComplete: true` in its JSON response, causing the conversation to loop with fallback messages. The growing conversation history (18+ messages) consumed too many input tokens.

**Fix Applied:**
- Trim conversation history to last 10 messages (currentData already has all extracted info)
- Increased `max_completion_tokens` from 1000 to 2000 for summary responses
- Added server-side completion guarantee: if all 9 required fields are collected but model didn't set `isComplete`, force completion with a formatted summary
- Added `finish_reason` logging to detect future truncation issues

---

## MUST FIX BEFORE LAUNCH (S1)

### S1-1: Date of Birth Field Not Pre-Filled After AI Conversation
**Area:** AI Intake â†’ Form Pre-Fill
**Severity:** S1
**Impact:** 1 of 9 fields requires manual re-entry after AI conversation

**Description:**
After completing the AI conversation, all fields except Date of Birth are pre-filled in the form. The DOB field shows placeholder "mm/dd/yyyy" even though the AI collected "05/22/1988". This is because the HTML `<input type="date">` requires YYYY-MM-DD format, but the AI extracts dates in MM/DD/YYYY format.

**Repro Steps:**
1. Complete all 9 AI intake questions
2. View the pre-filled form
3. **Expected:** DOB field shows the collected date
4. **Actual:** DOB field shows placeholder "mm/dd/yyyy"

**Recommendation:**
In the `onComplete` handler in PatientPortal.tsx, convert the date format:
```typescript
// Convert MM/DD/YYYY to YYYY-MM-DD for date input
const parts = data.date_of_birth?.split('/')
const formattedDob = parts?.length === 3
  ? `${parts[2]}-${parts[0].padStart(2,'0')}-${parts[1].padStart(2,'0')}`
  : data.date_of_birth
```

---

## SHOULD FIX SOON (S2)

### S2-1: No Accessibility Labels on Mode Toggle
**Area:** Accessibility
**Severity:** S2
**Impact:** Screen reader users cannot understand toggle purpose

**Description:**
The "Fill Out Form" / "Chat with AI" toggle pills lack ARIA labels, roles, and keyboard navigation support.

**Recommendation:**
Add `role="tab"`, `aria-selected`, and `aria-controls` attributes to the mode toggle buttons.

---

### S2-2: Demo Banner Sections May Have Poor Color Contrast
**Area:** Accessibility
**Severity:** S2
**Impact:** Low vision users may struggle to read section headers

**Description:**
Section headers use `#a78bfa` (light purple) on dark background. Should verify WCAG AA compliance.

**Recommendation:**
Run contrast checker and adjust if below 4.5:1 ratio.

---

### S2-3: Demo Banner Dismissal Permanently Hides Critical Info
**Area:** Patient Portal Demo Banner
**Severity:** S2
**Impact:** Testers who dismiss banner cannot re-access guidance

**Description:**
The demo banner X button dismisses it permanently via localStorage. No way to re-show without clearing localStorage.

**Recommendation:**
Add a "Show Demo Info" link somewhere accessible, or use session-based dismissal.

---

## NICE TO HAVE (S3)

### S3-1: AI Intake Should Show Progress Indicator
**Area:** UX Enhancement
**Severity:** S3
**Impact:** Users don't know how many questions remain

**Description:**
During the AI conversation, there's no visual indicator of how many fields have been collected or how many remain. Users might wonder "how much longer?"

**Recommendation:**
Add a progress bar or "3 of 9 questions complete" indicator above the chat.

---

### S3-2: No Keyboard Shortcuts for Mode Toggle
**Area:** UX Enhancement
**Severity:** S3
**Impact:** Power users can't quickly switch modes

**Description:**
Switching between form and chat modes requires mouse click.

**Recommendation:**
Add keyboard shortcut (e.g., Ctrl+/) to toggle.

---

## OBSERVATIONS (S4)

### S4-1: AI Conversation Quality Is Excellent
**Area:** Product Quality
**Severity:** S4 (Positive)

**Description:**
The AI intake assistant produces natural, empathetic responses. It correctly:
- Addresses the patient by name throughout
- Acknowledges each answer before asking the next question
- Extracts structured data accurately from natural language
- Formats medical data appropriately (e.g., "Lisinopril 10 mg daily; Vitamin D 2000 IU daily")

---

### S4-2: No Analytics on Feature Usage
**Area:** Product Analytics
**Severity:** S4
**Impact:** Cannot measure if users prefer AI chat vs form

**Description:**
No tracking to see how often users choose "Chat with AI" vs "Fill Out Form."

**Recommendation:**
Add event tracking for mode selections to inform product decisions.

---

## Feature Verification Results

### Feature 1: Physician Testing Banner âœ…
- Yellow banner appears on physician dashboard with "February 4â€“6, 2026" message
- Dismiss button (X) works, persists via localStorage
- "Launch Tour" button triggers onboarding tour restart

### Feature 2: Patient Portal Demo Banner âœ…
- Purple collapsible banner appears below header
- Three expandable sections (Personas, Features, How-To) work correctly
- Demo scenario data loads from historianTypes.ts
- Dismiss works with localStorage persistence

### Feature 3: Voice Dictation for Messages âœ…
- Microphone buttons appear above Subject and Message fields
- Recording starts/stops correctly
- Transcribed text appends to input fields
- Placeholder text updated to mention voice dictation

### Feature 4: AI-Assisted Intake Form âœ… (after 2 bug fixes)
- "Chat with AI" / "Fill Out Form" toggle works
- AI conversation flows through all 9 required fields
- Completion triggers automatic switch to form view
- 8 of 9 fields pre-filled correctly (DOB format issue â€” see S1-1)
- "Switch to Form" button works mid-conversation
- Defense-in-depth: server-side fallbacks prevent silent failures

---

## Test Environment

- **Browser:** Chrome (via Claude in Chrome MCP)
- **Production URL Tested:** https://ops-amplehtml.vercel.app/patient
- **Physician URL Tested:** https://ops-amplehtml.vercel.app/physician
- **Network:** Production Vercel deployment
- **Tools Used:** Browser automation, DOM inspection, performance API, git
- **Duration:** ~90 minutes (including 2 bug fix cycles)
- **Test Conversations:** 3 complete end-to-end AI intake conversations

---

## Lessons Learned

1. **Always test against the production alias URL** (ops-amplehtml.vercel.app), not individual deployment URLs which may be stale
2. **Token limits in conversational AI need headroom** â€” multi-turn conversations grow context rapidly; use generous completion token limits and trim history
3. **Defense-in-depth is essential for AI features** â€” server-side fallbacks + client-side fallbacks + forced completion guarantee = resilient system
4. **The "stuck UI" wasn't actually stuck** â€” the loading state was false, but an empty message bubble was rendered. DOM inspection was needed to diagnose vs. visual inspection alone
