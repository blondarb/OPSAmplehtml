# Test Cases - Sevaro Clinical
# test_cases_version: 2.1
# Last updated: 2026-02-07
#
# Structure: Each case has id, title, preconditions, steps, expected, data_verification (optional).
# Organized by suite matching TEST_RUNBOOK.md sections.

---
smoke:
  - id: S1
    title: App loads and redirects (Desktop)
    preconditions: [deployed preview URL available, desktop browser]
    steps:
      - Navigate to root URL /
    expected: Redirects to /dashboard (if logged in) or /login (if logged out)

  - id: S2
    title: App loads and redirects (Mobile)
    preconditions: [deployed preview URL available, mobile browser or iPhone/Android]
    steps:
      - Navigate to root URL / on mobile device
    expected: Redirects to /mobile automatically

  - id: S3
    title: Login flow
    preconditions: [valid demo user credentials]
    steps:
      - Navigate to /login
      - Enter email and password
      - Click Sign In
    expected: Redirects to /dashboard, patient card visible in left sidebar

  - id: S4
    title: Tab navigation renders
    preconditions: [logged in, on /dashboard]
    steps:
      - Click History tab
      - Click Imaging/Results tab
      - Click Physical Exams tab
      - Click Recommendation tab
    expected: Each tab renders content without console errors or blank screen

  - id: S5
    title: Patient portal loads
    preconditions: [deployed preview URL available]
    steps:
      - Navigate to /patient
    expected: Three tabs visible (Intake Form, Messages, AI Historian)

  - id: S6
    title: Mobile app loads
    preconditions: [mobile device or 375px viewport]
    steps:
      - Navigate to /mobile
    expected: Patient list renders, red FAB visible, compact layout

  - id: S7
    title: Build passes
    preconditions: [local repo up to date]
    steps:
      - Run npm run build
    expected: Exit code 0, "Compiled successfully" in output

---
clinical_notes:
  - id: A1
    title: HPI text persists across tabs
    preconditions: [logged in, on History tab]
    steps:
      - Type "Patient reports 3-week history of headaches" in HPI field
      - Switch to Imaging tab
      - Switch back to History tab
    expected: HPI text still present with exact content

  - id: A2
    title: Reason for consult cascades
    preconditions: [logged in, on History tab]
    steps:
      - Click Headache category
      - Observe sub-options appear
      - Select "Migraine with aura"
    expected: |
      - Sub-options appear with teal highlight
      - Differential diagnosis section auto-populates "Migraine with aura" with ICD-10 code G43.1

  - id: A3
    title: Differential diagnosis management
    preconditions: [logged in, Recommendation tab]
    steps:
      - Click Add Diagnosis
      - Search "tension"
      - Select "Tension-type headache"
      - Remove a previously added diagnosis by clicking X
      - Switch tabs and return
    expected: |
      - Diagnosis added with ICD-10 badge (G44.2)
      - Removed diagnosis disappears and does not reappear on tab switch

  - id: A4
    title: Generate Note modal
    preconditions: [logged in, some note content entered]
    steps:
      - Enter text in HPI and Assessment fields
      - Click Generate Note button (purple)
      - Select note type and length
      - Click Generate
    expected: |
      - Modal opens with note type/length selection
      - Note preview renders with sections
      - AI suggestions panel may appear

  - id: A5
    title: Dot phrase expansion
    preconditions: [logged in, dot phrases seeded]
    steps:
      - Click lightning icon on any text field
      - Search for "exam"
      - Select the phrase
    expected: Phrase text expands into field, replacing or appending

  - id: A6
    title: Smart scale suggestions
    preconditions: [logged in, Headache category selected]
    steps:
      - Select Headache category
      - Scroll to Clinical Scales section
    expected: MIDAS and HIT-6 suggested with teal dot indicators

  - id: A7
    title: Imaging tab card interaction
    preconditions: [logged in, Imaging tab]
    steps:
      - Click MRI Brain card header to expand
      - Fill in findings textarea with "Normal exam"
      - Click PACS link
    expected: |
      - Card expands with date, impression, findings fields
      - Text persists when collapsing/expanding
      - PACS link is navigable (may open new tab)

  - id: A8
    title: No cross-patient data bleed
    preconditions: [logged in, multiple patients exist]
    steps:
      - Enter HPI text "Patient A specific data" for Patient A
      - Switch to Patient B in sidebar
      - Check HPI field
      - Switch back to Patient A
    expected: |
      - Patient B shows own data (or empty), not Patient A's
      - Patient A still has original data on return

  - id: A9
    title: Medication management
    preconditions: [logged in, on History tab]
    steps:
      - Click Add Medication
      - Type "lisinopril" in search
      - Select from formulary dropdown
      - Fill in dose "10mg daily"
      - Save
    expected: |
      - Medication appears in medication list
      - Shows dosage and frequency
      - Persists after tab switch

  - id: A10
    title: Allergy management
    preconditions: [logged in, on History tab]
    steps:
      - Click Add Allergy
      - Enter "Penicillin"
      - Select severity "Severe"
      - Select reaction "Anaphylaxis"
      - Save
    expected: |
      - Allergy appears in allergy chips
      - Red/orange severity indicator
      - Appears in left sidebar allergy banner

---
ai_features:
  - id: B1
    title: Ask AI returns response
    preconditions: [logged in, OpenAI key configured]
    steps:
      - Click AI star icon in action bar to open AI drawer
      - Type "What are common migraine triggers?"
      - Click Submit
    expected: AI response renders in drawer with relevant clinical information
    data_verification: Response relates to question, not random content

  - id: B2
    title: Field AI actions
    preconditions: [logged in, text in HPI field]
    steps:
      - Enter brief HPI "headache x 3 weeks"
      - Click star icon on HPI field
      - Select "Expand"
    expected: |
      - Expanded text replaces or appends to field
      - Text contains more clinical detail
    data_verification: Expansion doesn't add fabricated symptoms not implied

  - id: B3
    title: Voice drawer mic prompt
    preconditions: [logged in]
    steps:
      - Click red mic icon in action bar
    expected: Voice drawer opens, browser requests mic permission

  - id: B4
    title: Chart Prep summary
    preconditions: [logged in, Voice drawer open, Chart Prep tab]
    steps:
      - Click Start Recording
      - Dictate "The patient was referred for new onset headaches starting 3 weeks ago"
      - Stop recording
      - Wait for transcription
      - Click Generate Summary
    expected: |
      - Structured summary appears with sections
      - Alerts section (red) if concerning findings
      - Suggested Focus section (yellow)
      - Key Points section
    data_verification: Summary reflects dictated content accurately

  - id: B5
    title: Chart Prep to HPI flow
    preconditions: [Chart Prep summary generated]
    steps:
      - With Chart Prep summary visible
      - Click "Add All to Note"
    expected: Content appears in HPI field, properly formatted
    data_verification: HPI field contains Chart Prep summary content

  - id: B6
    title: Generate Assessment from diagnoses
    preconditions: [logged in, 1+ diagnosis added]
    steps:
      - Add "Migraine with aura" diagnosis
      - Navigate to Recommendation tab
      - Click Generate Assessment button
    expected: Assessment text populates based on selected diagnoses
    data_verification: Assessment mentions migraine, includes relevant clinical language

  - id: B7
    title: Patient-friendly summary
    preconditions: [logged in, clinical content entered]
    steps:
      - Open AI drawer
      - Click Summary tab
      - Select "Simple" level
      - Click Generate
    expected: Output is patient-readable, minimal medical jargon

  - id: B8
    title: Note review suggestions
    preconditions: [logged in, note content entered]
    steps:
      - Click Generate Note
      - Generate a note
      - Observe AI Review panel
    expected: |
      - Suggestions panel appears with improvement ideas
      - Each suggestion has type badge (consistency/completeness/quality)
      - "Go to section" links work

---
chart_prep_state:
  - id: CP1
    title: Auto-save on Home button
    priority: P0
    preconditions: [logged in, Voice drawer open, Chart Prep recording active]
    steps:
      - Start Chart Prep recording
      - Dictate some patient information
      - Click Home icon in IconSidebar (house icon)
    expected: |
      - Recording stops automatically
      - "Processing..." indicator appears
      - Data saved to localStorage
      - User navigated to appointments view
    data_verification: |
      localStorage has key 'chart-prep-{visitId}' with prepNotes and pendingAIProcessing flag

  - id: CP2
    title: Auto-save on patient switch
    priority: P0
    preconditions: [logged in, Voice drawer open, Chart Prep recording active, multiple patients exist]
    steps:
      - Start Chart Prep recording on Patient A
      - Dictate some patient information
      - Click on Patient B in left sidebar
    expected: |
      - Recording stops automatically
      - Patient A's data saved to localStorage
      - Patient B's chart loads with clean state (no Patient A data)
    data_verification: |
      localStorage has 'chart-prep-{patientA-visitId}' with saved content
      Patient B's Chart Prep area is empty

  - id: CP3
    title: localStorage persistence on drawer close
    priority: P0
    preconditions: [logged in, Chart Prep summary generated]
    steps:
      - Generate Chart Prep summary via Voice drawer
      - Close the Voice drawer
      - Reopen the Voice drawer
    expected: |
      - Chart Prep data still visible in drawer
      - prepNotes and chartPrepSections restored
      - "Add All to Note" button still available
    data_verification: |
      localStorage key 'chart-prep-{visitId}' contains chartPrepSections with summary, alerts, suggestedHPI

  - id: CP4
    title: Restore Chart Prep on patient return
    priority: P0
    preconditions: [logged in, Chart Prep processed for Patient A, switched away]
    steps:
      - Complete Chart Prep on Patient A (generate summary)
      - Switch to Patient B
      - Switch back to Patient A
    expected: |
      - LeftSidebar shows Chart Prep panel with summary sections
      - Alerts section (red) visible if present
      - Summary section visible
      - "View" button opens VoiceDrawer to Chart Prep tab
    data_verification: |
      chartPrepOutput state is restored from localStorage
      LeftSidebar renders ChartPrepPanel component

  - id: CP5
    title: Background processing completion
    priority: P1
    preconditions: [logged in, Voice drawer open, recording in progress]
    steps:
      - Start Chart Prep recording
      - Dictate patient information
      - Click outside drawer to minimize (floating bar appears)
      - Stop recording via floating bar
      - Wait for processing
    expected: |
      - Floating bar shows teal "Processing..." state
      - Processing completes while minimized
      - Results saved to localStorage
      - Drawer auto-expands when processing completes
    data_verification: |
      localStorage updated with chartPrepSections after processing

  - id: CP6
    title: LeftSidebar Chart Prep panel display
    priority: P1
    preconditions: [logged in, Chart Prep processing completed]
    steps:
      - Complete Chart Prep processing
      - Close Voice drawer if open
      - Observe LeftSidebar
    expected: |
      - Chart Prep panel appears in LeftSidebar (above Prior Visits)
      - Alerts section with red background (if alerts present)
      - Summary section visible
      - "View" button visible
    data_verification: |
      chartPrepOutput in ClinicalNote state matches localStorage data

  - id: CP7
    title: View button opens correct drawer tab
    priority: P1
    preconditions: [logged in, Chart Prep summary exists in LeftSidebar]
    steps:
      - Find Chart Prep panel in LeftSidebar
      - Click "View" button
    expected: |
      - VoiceDrawer opens
      - Chart Prep tab is active (not Document tab)
      - Previously generated summary is visible
      - "Add All to Note" button available
    data_verification: |
      VoiceDrawer activeTab is 'chart-prep'
      chartPrepSections displayed in drawer

  - id: CP8
    title: Multiple Chart Prep sessions combine
    priority: P1
    preconditions: [logged in, first Chart Prep completed]
    steps:
      - Complete first Chart Prep recording
      - Generate summary
      - Start a new Chart Prep recording (additional dictation)
      - Generate summary again
    expected: |
      - Combined summary includes content from both sessions
      - prepNotes array contains all recordings
      - Single comprehensive summary generated
    data_verification: |
      prepNotes array has 2+ entries
      chartPrepSections summary references content from both dictations

  - id: CP9
    title: Sign & Complete clears Chart Prep data
    priority: P2
    preconditions: [logged in, Chart Prep completed, note ready to sign]
    steps:
      - Complete Chart Prep and add to note
      - Click "Sign & Complete" button
      - Return to same patient (if possible) or check localStorage
    expected: |
      - Visit signed successfully
      - Chart Prep localStorage key cleared for that visit
      - Fresh Chart Prep state on return
    data_verification: |
      localStorage key 'chart-prep-{visitId}' removed or reset

  - id: CP10
    title: No cross-patient Chart Prep contamination
    priority: P0
    preconditions: [logged in, Chart Prep completed for Patient A, multiple patients exist]
    steps:
      - Complete Chart Prep on Patient A with specific content (e.g., "headaches for 3 weeks")
      - Switch to Patient B
      - Check LeftSidebar for Chart Prep section
      - Check Voice drawer Chart Prep tab
    expected: |
      - Patient B's LeftSidebar does NOT show Patient A's Chart Prep
      - Patient B's Voice drawer shows empty/fresh Chart Prep state
      - No Patient A content visible on Patient B
    data_verification: |
      chartPrepOutput is null or specific to Patient B's visit
      No cross-visit localStorage key confusion

---
chart_prep_recording:
  - id: CR1
    title: Minimized recording bar appears
    priority: P1
    preconditions: [logged in, Voice drawer open, Chart Prep recording active]
    steps:
      - Start Chart Prep recording
      - Click outside the Voice drawer (on center panel)
    expected: |
      - Voice drawer closes/minimizes
      - Floating red bar appears at bottom-right
      - Timer continues counting
      - Recording continues (audio still captured)
    data_verification: |
      isRecording state remains true
      showMinimizedBar condition met

  - id: CR2
    title: Minimized bar controls function correctly
    priority: P1
    preconditions: [Chart Prep recording active, minimized bar visible]
    steps:
      - Click Pause button on minimized bar
      - Observe timer pauses
      - Click Resume button
      - Click Stop button
    expected: |
      - Pause: Timer pauses, icon changes to play/resume
      - Resume: Timer resumes, recording continues
      - Stop: Recording stops, processing begins
    data_verification: |
      isPaused state toggles correctly
      Audio chunks captured throughout

  - id: CR3
    title: TopNav recording indicator shows
    priority: P1
    preconditions: [logged in, Chart Prep recording active]
    steps:
      - Start Chart Prep recording
      - Close/minimize Voice drawer
      - Look at TopNav area
    expected: |
      - Red recording indicator visible in TopNav
      - Timer displayed
      - Indicator visible regardless of drawer state
    data_verification: |
      TopNav receives isPrepRecording={true}

  - id: CR4
    title: Expand from minimized state
    priority: P1
    preconditions: [Chart Prep recording active, minimized bar visible]
    steps:
      - While minimized bar is showing
      - Click the expand button (arrow icon)
    expected: |
      - Voice drawer opens
      - Chart Prep tab active
      - Recording still in progress (timer, waveform)
      - All controls available (pause, stop, restart)
    data_verification: |
      Drawer state restored without interrupting recording

  - id: CR5
    title: Processing indicator in minimized state
    priority: P1
    preconditions: [Chart Prep recording active, minimized bar visible]
    steps:
      - While minimized, click Stop button
      - Observe minimized bar state
    expected: |
      - Bar turns teal (processing color)
      - Shows spinner/loading indicator
      - Text changes to "Processing..."
      - Bar remains visible until processing completes
    data_verification: |
      isPrepTranscribing or autoProcessing state true
      Bar shows processing UI, not recording UI

---
historian_physician:
  - id: C1
    title: Historian session list shows real patients
    preconditions: [logged in, historian sessions exist with patient_id FK]
    steps:
      - Look at left sidebar AI Historian section
    expected: Session cards show real patient names, not "Demo Patient"
    data_verification: Names match patients table

  - id: C2
    title: Historian session details
    preconditions: [historian session exists]
    steps:
      - Expand a session card in sidebar
      - Click Transcript tab
      - Click Summary tab
      - Click Structured Data tab
    expected: All three tabs render content correctly

  - id: C3
    title: Red flags display
    preconditions: [historian session with red flags]
    steps:
      - Find session with red flags
      - Expand session card
    expected: Red flag banner visible with severity indicator and description

  - id: C4
    title: Import HPI from historian
    preconditions: [historian session with structured output]
    steps:
      - Expand session card
      - Click "Import to Note"
      - Check HPI field
    expected: HPI field populates with interview summary
    data_verification: HPI contains chief complaint and symptom details from interview

  - id: C5
    title: Import medications from historian
    preconditions: [historian session where patient mentioned medications]
    steps:
      - Import session to note
      - Check medication list
    expected: Patient-stated medications appear in medication list
    data_verification: Medications match what patient said in interview

  - id: C6
    title: Import allergies from historian
    preconditions: [historian session where patient mentioned allergies]
    steps:
      - Import session to note
      - Check allergy section
    expected: Patient-stated allergies appear in allergy list
    data_verification: Allergies match what patient said in interview

  - id: C7
    title: Import all structured data
    preconditions: [complete historian session]
    steps:
      - Click Import All
      - Check all note fields
    expected: |
      - HPI populated
      - Medications populated
      - Allergies populated
      - PMH populated
      - ROS populated
    data_verification: All fields reflect interview content accurately

---
mobile_app:
  - id: M1
    title: Mobile auto-redirect
    preconditions: [mobile device, cookies cleared]
    steps:
      - Navigate to / on mobile browser
    expected: Auto-redirects to /mobile based on User-Agent

  - id: M2
    title: Patient list display
    preconditions: [on /mobile]
    steps:
      - View patient list
    expected: |
      - Compact patient cards
      - Status badges (Sched, Active, NEW, F/U)
      - Times visible

  - id: M3
    title: Patient search
    preconditions: [on /mobile, patients exist]
    steps:
      - Tap search bar
      - Type patient name partial
    expected: List filters in real-time to matching patients

  - id: M4
    title: Filter pills
    preconditions: [on /mobile]
    steps:
      - Tap "Scheduled" pill
      - Tap "Active" pill
      - Tap "All" pill
    expected: Patient list updates to show filtered results

  - id: M5
    title: Swipe gestures
    preconditions: [on /mobile, scheduled patient exists]
    steps:
      - Swipe right on a scheduled patient card
    expected: Check-in action triggers, patient status changes

  - id: M6
    title: FAB navigation
    preconditions: [on /mobile]
    steps:
      - Tap red microphone FAB
    expected: Navigates to /mobile/voice page

---
mobile_chart:
  - id: N1
    title: Chart access
    preconditions: [on /mobile]
    steps:
      - Tap on a patient card
    expected: Navigates to /mobile/chart/[id]

  - id: N2
    title: AI Summary card
    preconditions: [on patient chart]
    steps:
      - View AI Summary section
    expected: |
      - Shows referral context
      - Key considerations listed
      - Collapsible

  - id: N3
    title: Section navigation pills
    preconditions: [on patient chart]
    steps:
      - Tap HPI pill
      - Tap Exam pill
      - Tap Assessment pill
      - Tap Plan pill
    expected: Page scrolls to correct section each time

  - id: N4
    title: Section expand/collapse
    preconditions: [on patient chart]
    steps:
      - Tap HPI section card header
    expected: Section expands showing editable content

  - id: N5
    title: Section voice record
    preconditions: [section expanded]
    steps:
      - Tap microphone button on section
    expected: Voice recorder UI appears for that section

  - id: N6
    title: Section transcription
    preconditions: [recording in section]
    steps:
      - Record speech
      - Stop recording
    expected: Transcribed text appears in section field

---
mobile_voice:
  - id: O1
    title: Voice page navigation
    preconditions: [on /mobile]
    steps:
      - Tap FAB or section mic button
    expected: Voice recorder page/UI opens

  - id: O2
    title: Mic permission
    preconditions: [voice recorder open, permissions not yet granted]
    steps:
      - Tap Start Recording
    expected: Browser/device requests microphone permission

  - id: O3
    title: Recording visualization
    preconditions: [mic permission granted]
    steps:
      - Start recording
      - Speak into microphone
    expected: Audio level visualization animates in response to voice

  - id: O4
    title: Pause and resume
    preconditions: [actively recording]
    steps:
      - Tap Pause
      - Wait 2 seconds
      - Tap Resume
      - Stop recording
    expected: |
      - Recording pauses (visualization stops)
      - Timer pauses
      - Resume continues recording
      - Final transcription includes all audio

  - id: O5
    title: Transcription completes
    preconditions: [recording stopped]
    steps:
      - Stop recording
      - Wait for processing
    expected: Transcribed text displays on screen

  - id: O6
    title: Safari/iOS transcription
    preconditions: [iPhone with Safari browser]
    steps:
      - Navigate to /mobile/voice
      - Start recording
      - Speak "Testing transcription on iPhone"
      - Stop recording
    expected: |
      - Transcription succeeds (not "failed to transcribe")
      - Text displays correctly
    data_verification: MIME type is audio/mp4 or audio/aac, mapped to .m4a extension

  - id: O7
    title: Error retry
    preconditions: [transcription failed]
    steps:
      - If transcription fails, observe Retry button
      - Tap Retry
    expected: Retry attempts transcription again

  - id: O8
    title: AI cleanup of verbal corrections
    preconditions: [voice recorder ready]
    steps:
      - Record "The patient has pain in the left hand, no wait, the right hand"
      - Stop recording
    expected: Transcription shows "The patient has pain in the right hand"
    data_verification: Verbal corrections are applied, not kept literally

---
mobile_settings:
  - id: P1
    title: Settings page renders
    preconditions: [on /mobile]
    steps:
      - Tap Settings in bottom nav
    expected: Settings page loads with toggle switches

  - id: P2
    title: Switch to Desktop View
    preconditions: [on /mobile/settings]
    steps:
      - Tap "Switch to Desktop View" button
    expected: |
      - Redirects to /dashboard
      - Cookie 'preferred_view' set to 'desktop'

  - id: P3
    title: View preference persistence
    preconditions: [switched to desktop on mobile]
    steps:
      - Navigate to / on same mobile device
    expected: Stays on desktop view (respects cookie preference)

  - id: P4
    title: Reset preference
    preconditions: [mobile device]
    steps:
      - Clear cookies
      - Navigate to /
    expected: Auto-redirects to /mobile (default behavior restored)

---
mobile_fab:
  - id: Q1
    title: FAB visible on chart view
    preconditions: [on /mobile/chart/[id]]
    steps:
      - View bottom-right corner of screen
    expected: Teal FAB button visible with checkmark icon

  - id: Q2
    title: FAB expands on tap
    preconditions: [on chart view, FAB visible]
    steps:
      - Tap the FAB button
    expected: |
      - Menu expands with 3 vertically stacked buttons
      - Save Draft (amber), Prepare Note (teal), Sign & Complete (green)
      - Backdrop appears behind menu

  - id: Q3
    title: FAB Save Draft action
    preconditions: [FAB menu open, note has content]
    steps:
      - Tap Save Draft button
    expected: |
      - Note saves via PATCH /api/visits/[id]
      - Success feedback (toast or haptic)
      - Menu closes

  - id: Q4
    title: FAB Prepare Note action
    preconditions: [FAB menu open]
    steps:
      - Tap Prepare Note button
    expected: MobileNotePreview bottom sheet slides up

  - id: Q5
    title: FAB Sign & Complete action
    preconditions: [FAB menu open]
    steps:
      - Tap Sign & Complete button
    expected: |
      - Confirmation dialog or direct sign
      - Patient status changes to completed
      - Returns to patient list

  - id: Q6
    title: FAB collapses on outside tap
    preconditions: [FAB menu expanded]
    steps:
      - Tap on backdrop (outside menu)
    expected: Menu collapses, FAB returns to single button

  - id: Q7
    title: FAB haptic feedback
    preconditions: [real mobile device, FAB visible]
    steps:
      - Tap FAB to expand
      - Tap an action button
    expected: Haptic vibration felt on each tap

---
mobile_chart_prep:
  - id: R1
    title: Chart Prep mode opens
    preconditions: [on chart view, section expanded]
    steps:
      - Tap microphone button on a section in chart-prep mode
    expected: MobileVoiceRecorder opens in chart-prep mode

  - id: R2
    title: Chart Prep recording
    preconditions: [voice recorder open in chart-prep mode]
    steps:
      - Tap Start Recording
      - Dictate patient information for 10-15 seconds
    expected: Audio level bars animate during speech

  - id: R3
    title: Chart Prep processing
    preconditions: [recording stopped]
    steps:
      - Stop recording
      - Wait for processing
    expected: |
      - "Processing..." spinner appears
      - AI summary appears with categorized sections

  - id: R4
    title: Chart Prep results display
    preconditions: [Chart Prep processing complete]
    steps:
      - View results panel
    expected: |
      - Alerts section (red background) if concerning findings
      - Suggested Focus section (yellow background)
      - Key Points and other sections (gray background)

  - id: R5
    title: Add single Chart Prep item
    preconditions: [Chart Prep results visible]
    steps:
      - Tap "Add" on a specific section item
    expected: |
      - Item added to target note section
      - Visual confirmation

  - id: R6
    title: Add all Chart Prep items
    preconditions: [Chart Prep results visible]
    steps:
      - Tap "Add All to Note" button
    expected: |
      - All items added to respective note sections
      - Content wrapped with Chart Prep markers
      - Recorder closes or shows success

  - id: R7
    title: Chart Prep marker replacement
    preconditions: [previous Chart Prep content in note]
    steps:
      - Run Chart Prep again for same section
      - Add new content
    expected: |
      - Previous Chart Prep content replaced (not duplicated)
      - Only new AI content between markers
      - Manual content preserved
    data_verification: |
      Note section contains only one set of Chart Prep markers

---
mobile_note_preview:
  - id: S1
    title: Note preview opens from FAB
    preconditions: [on chart view]
    steps:
      - Tap FAB
      - Tap Prepare Note
    expected: MobileNotePreview bottom sheet slides up from bottom

  - id: S2
    title: Note type toggle
    preconditions: [note preview open]
    steps:
      - Tap "New Consult" button
      - Tap "Follow-up" button
    expected: |
      - Toggle visually updates (purple border on selected)
      - Selection persists

  - id: S3
    title: Note length toggle
    preconditions: [note preview open]
    steps:
      - Tap "Concise" button
      - Tap "Standard" button
    expected: Toggle visually updates with selection

  - id: S4
    title: Generate note with AI
    preconditions: [note preview open, note has content]
    steps:
      - Select type and length
      - Tap "Generate with AI" button
    expected: |
      - Loading spinner appears
      - Formatted note appears in preview area
      - Copy and Sign buttons appear in footer

  - id: S5
    title: Copy note to clipboard
    preconditions: [note generated]
    steps:
      - Tap Copy button
    expected: |
      - Clipboard contains note text
      - Button shows "Copied!" feedback

  - id: S6
    title: Sign from preview
    preconditions: [note generated]
    steps:
      - Tap "Sign & Complete" button
    expected: |
      - Note signed
      - Sheet closes
      - Patient status updated

  - id: S7
    title: Manual fallback on API failure
    preconditions: [note preview open, API will fail]
    steps:
      - Attempt to generate note when API is down
    expected: |
      - Error doesn't crash UI
      - Fallback formatting produces readable note
      - User can still copy and sign

---
mobile_recommendations:
  - id: T1
    title: Diagnosis pills appear
    preconditions: [on chart view, Assessment section visible]
    steps:
      - Add a diagnosis in Assessment section
    expected: |
      - Diagnosis pill appears with name and ICD-10 code
      - "Tap for Treatment Recommendations" hint visible

  - id: T2
    title: Recommendations sheet opens
    preconditions: [diagnosis pill visible]
    steps:
      - Tap on diagnosis pill
    expected: MobileRecommendationsSheet slides up from bottom

  - id: T3
    title: Plan loads in sheet
    preconditions: [recommendations sheet open]
    steps:
      - Wait for loading
    expected: |
      - Loading spinner while fetching
      - Plan title and ICD-10 badge displayed
      - Sections appear (first section auto-expanded)

  - id: T4
    title: Section expand/collapse
    preconditions: [plan loaded in sheet]
    steps:
      - Tap on collapsed section header
      - Tap on expanded section header
    expected: |
      - Section expands showing subsections and items
      - Section collapses hiding content
      - Chevron icon rotates

  - id: T5
    title: Select recommendation items
    preconditions: [section expanded with items]
    steps:
      - Tap checkbox on 3 items
    expected: |
      - Checkboxes fill with teal
      - Add button shows count "Add 3 to Plan"

  - id: T6
    title: Priority badges display
    preconditions: [plan with priority items]
    steps:
      - View items with priorities
    expected: |
      - STAT badge in red
      - URGENT badge in amber
      - ROUTINE badge in blue

  - id: T7
    title: Add selected to plan
    preconditions: [items selected]
    steps:
      - Tap "Add to Plan" button
    expected: |
      - Items added to Plan section in note
      - "Added!" confirmation shown
      - Sheet closes after brief delay
      - Haptic feedback felt

  - id: T8
    title: No plan available fallback
    preconditions: [diagnosis without treatment plan in database]
    steps:
      - Tap diagnosis pill
      - Wait for loading
    expected: |
      - Graceful error message "No treatment plan available for this diagnosis"
      - Sheet can be closed
      - App doesn't crash

---
patient_portal:
  - id: D1
    title: Intake form submission
    preconditions: [on /patient, Intake tab]
    steps:
      - Fill name, DOB, chief complaint
      - Submit
    expected: Success message, form resets

  - id: D2
    title: Send message
    preconditions: [on /patient, Messages tab]
    steps:
      - Fill name, subject, body
      - Submit
    expected: "Message sent successfully" toast

  - id: D3
    title: Portal accessible without auth
    preconditions: [logged out]
    steps:
      - Navigate to /patient
    expected: Portal renders, no auth redirect

---
historian_patient:
  - id: H1
    title: Patient picker shows patients
    preconditions: [on /patient, Historian tab]
    steps:
      - View patient list
    expected: Patient cards with names, referral reason, MRN

  - id: H2
    title: Add new patient
    preconditions: [on Historian tab]
    steps:
      - Click Add New Patient
      - Fill first name, last name, referral reason
      - Submit
    expected: Patient appears in list, form clears

  - id: H3
    title: Start interview
    preconditions: [patient selected]
    steps:
      - Click Start Voice Interview
      - Grant mic permission
    expected: |
      - Status changes to Connecting then Active
      - AI greeting plays

  - id: H4
    title: Voice capture
    preconditions: [interview active]
    steps:
      - Speak responses to AI questions
    expected: Transcript shows patient responses in real-time

  - id: H5
    title: Interview flow
    preconditions: [interview active]
    steps:
      - Answer AI questions about symptoms, medications, history
    expected: AI asks appropriate follow-up questions based on responses

  - id: H6
    title: Session complete
    preconditions: [interview finished]
    steps:
      - End interview
    expected: |
      - Success screen displays
      - Duration and question count shown

  - id: H7
    title: Session saved to database
    preconditions: [interview completed]
    steps:
      - Check historian_sessions table in Supabase
    expected: |
      - Row exists with session data
      - patient_id FK set correctly
      - structured_output JSON populated
    data_verification: Database record matches interview content

  - id: H8
    title: Demo scenario
    preconditions: [on Historian tab]
    steps:
      - Expand "Or try a demo scenario"
      - Select a scenario
    expected: Navigates to /patient/historian?scenario=<id>, mock context loads

---
historian_data_flow:
  - id: I1
    title: Chief complaint extraction
    preconditions: [interview active]
    steps:
      - When asked, say "I've been having terrible headaches"
    expected: Structured output chiefComplaint contains "headaches"
    data_verification: |
      structured_output.chiefComplaint includes "headaches"

  - id: I2
    title: HPI OLDCARTS extraction
    preconditions: [interview active]
    steps:
      - Describe symptoms with timing, location, severity
      - Say "Started 3 weeks ago, left side of my head, about 7 out of 10 pain"
    expected: HPI text includes onset (3 weeks), location (left side), severity (7/10)
    data_verification: |
      structured_output.hpi contains temporal, location, and severity info

  - id: I3
    title: Medication mention extraction
    preconditions: [interview active]
    steps:
      - When asked about medications, say "I take lisinopril 10mg daily for blood pressure"
    expected: Medication appears in structured medications array
    data_verification: |
      structured_output.medications contains:
        - name: lisinopril
        - dose: 10mg
        - frequency: daily

  - id: I4
    title: Allergy mention extraction
    preconditions: [interview active]
    steps:
      - When asked about allergies, say "I'm allergic to penicillin, I get hives"
    expected: Allergy appears in structured allergies array
    data_verification: |
      structured_output.allergies contains:
        - allergen: penicillin
        - reaction: hives

  - id: I5
    title: PMH extraction
    preconditions: [interview active]
    steps:
      - When asked, say "I have diabetes and high blood pressure"
    expected: Conditions appear in pastMedicalHistory
    data_verification: |
      structured_output.pastMedicalHistory contains:
        - diabetes
        - hypertension/high blood pressure

  - id: I6
    title: Family history extraction
    preconditions: [interview active]
    steps:
      - Say "My mother had migraines and my father had a stroke"
    expected: Conditions appear in familyHistory
    data_verification: |
      structured_output.familyHistory contains:
        - mother: migraines
        - father: stroke

  - id: I7
    title: Social history extraction
    preconditions: [interview active]
    steps:
      - Say "I smoke half a pack a day, drink socially, work as an accountant"
    expected: Details appear in socialHistory
    data_verification: |
      structured_output.socialHistory contains:
        - tobacco use
        - alcohol use
        - occupation

  - id: I8
    title: ROS positive findings
    preconditions: [interview active]
    steps:
      - Mention symptoms "I've also had some nausea and sensitivity to light"
    expected: Appears in reviewOfSystems with affected systems
    data_verification: |
      structured_output.reviewOfSystems contains:
        - GI: nausea
        - Neuro/Eyes: photophobia

  - id: I9
    title: Red flag detection
    preconditions: [interview active]
    steps:
      - Mention concerning symptom "The headache woke me up from sleep"
    expected: Red flag array populated
    data_verification: |
      structured_output.redFlags contains:
        - description: nocturnal headache
        - severity: moderate or high

  - id: I10
    title: Safety trigger escalation
    preconditions: [interview active]
    steps:
      - Say safety-concerning phrase (test carefully in controlled setting)
    expected: |
      - Safety escalation overlay appears
      - 911, 988, Crisis Text Line links visible
      - Interview pauses

  - id: I11
    title: Import to HPI field
    preconditions: [historian session completed, physician logged in]
    steps:
      - Find session in sidebar
      - Click Import to Note
      - Check HPI field in clinical note
    expected: HPI field contains interview summary
    data_verification: |
      HPI text includes:
        - Chief complaint
        - Symptom details from interview

  - id: I12
    title: Import medications to list
    preconditions: [historian session with medications mentioned]
    steps:
      - Import session to note
      - Check medication list
    expected: Medications from interview appear in list
    data_verification: |
      Medication list contains medications patient mentioned during interview

  - id: I13
    title: Import allergies to section
    preconditions: [historian session with allergies mentioned]
    steps:
      - Import session to note
      - Check allergy section
    expected: Allergies from interview appear
    data_verification: |
      Allergy section contains allergies patient mentioned during interview

  - id: I14
    title: Import all fields
    preconditions: [complete historian session]
    steps:
      - Click Import All on session
      - Check all relevant note fields
    expected: |
      All fields populated:
        - HPI: interview summary
        - Medications: patient-stated meds
        - Allergies: patient-stated allergies
        - PMH: mentioned conditions
        - ROS: mentioned symptoms
    data_verification: |
      No data loss between interview and imported fields

---
cross_platform:
  - id: E1
    title: iPhone SE layout (375px)
    preconditions: [browser devtools or real device, 375px width]
    steps:
      - Load /dashboard
      - Tap hamburger menu
      - Open any drawer
    expected: |
      - Sidebar slides in
      - Drawers full-screen
      - No horizontal overflow

  - id: E2
    title: iPad layout (768px)
    preconditions: [browser devtools, 768px width]
    steps:
      - Load /dashboard
    expected: Sidebar visible, reduced padding, content readable

  - id: E3
    title: Touch targets
    preconditions: [mobile viewport]
    steps:
      - Inspect action bar buttons with devtools
    expected: All interactive elements >= 44px min dimension

  - id: E4
    title: Portal on mobile
    preconditions: [375px viewport]
    steps:
      - Load /patient
      - Navigate all three tabs
    expected: Forms usable, no horizontal scroll

  - id: E5
    title: Mobile app layout
    preconditions: [375px viewport or mobile device]
    steps:
      - Load /mobile
      - Navigate to chart and settings
    expected: Optimized compact layout, no horizontal scroll

  - id: F1
    title: Dark mode rendering
    preconditions: [logged in]
    steps:
      - Toggle dark mode via TopNav
      - Check all tabs, drawers, forms
    expected: All text readable, no white-on-white, form fields styled

  - id: F2
    title: Auth guard on dashboard
    preconditions: [logged out]
    steps:
      - Navigate to /dashboard
    expected: Redirects to /login

  - id: F3
    title: Portal accessible without auth
    preconditions: [logged out]
    steps:
      - Navigate to /patient
    expected: Portal renders, no auth redirect

  - id: F4
    title: Graceful API error handling
    preconditions: [invalid or missing OpenAI key]
    steps:
      - Trigger an AI action (Ask AI, Generate Assessment)
    expected: Error message in UI, not white screen or unhandled exception

  - id: F5
    title: Mobile Safari transcription
    preconditions: [iPhone with Safari]
    steps:
      - Test voice transcription on iPhone Safari
    expected: Transcription works (MIME type fix applied)

  - id: F6
    title: Chrome desktop
    preconditions: [Chrome browser]
    steps:
      - Run through smoke suite on Chrome
    expected: All features work

  - id: F7
    title: Firefox desktop
    preconditions: [Firefox browser]
    steps:
      - Run through smoke suite on Firefox
    expected: Core features work
